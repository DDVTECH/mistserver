var MD5=function(e){function t(e,t){return e<<t|e>>>32-t}function a(e,t){var a,i,s,n,r;s=e&2147483648;n=t&2147483648;a=e&1073741824;i=t&1073741824;r=(e&1073741823)+(t&1073741823);if(a&i){return r^2147483648^s^n}if(a|i){if(r&1073741824){return r^3221225472^s^n}else{return r^1073741824^s^n}}else{return r^s^n}}function i(e,t,a){return e&t|~e&a}function s(e,t,a){return e&a|t&~a}function n(e,t,a){return e^t^a}function r(e,t,a){return t^(e|~a)}function o(e,s,n,r,o,l,d){e=a(e,a(a(i(s,n,r),o),d));return a(t(e,l),s)}function l(e,i,n,r,o,l,d){e=a(e,a(a(s(i,n,r),o),d));return a(t(e,l),i)}function d(e,i,s,r,o,l,d){e=a(e,a(a(n(i,s,r),o),d));return a(t(e,l),i)}function c(e,i,s,n,o,l,d){e=a(e,a(a(r(i,s,n),o),d));return a(t(e,l),i)}function p(e){var t;var a=e.length;var i=a+8;var s=(i-i%64)/64;var n=(s+1)*16;var r=Array(n-1);var o=0;var l=0;while(l<a){t=(l-l%4)/4;o=l%4*8;r[t]=r[t]|e.charCodeAt(l)<<o;l++}t=(l-l%4)/4;o=l%4*8;r[t]=r[t]|128<<o;r[n-2]=a<<3;r[n-1]=a>>>29;return r}function u(e){var t="",a="",i,s;for(s=0;s<=3;s++){i=e>>>s*8&255;a="0"+i.toString(16);t=t+a.substr(a.length-2,2)}return t}function f(e){e=e.replace(/\r\n/g,"\n");var t="";for(var a=0;a<e.length;a++){var i=e.charCodeAt(a);if(i<128){t+=String.fromCharCode(i)}else if(i>127&&i<2048){t+=String.fromCharCode(i>>6|192);t+=String.fromCharCode(i&63|128)}else{t+=String.fromCharCode(i>>12|224);t+=String.fromCharCode(i>>6&63|128);t+=String.fromCharCode(i&63|128)}}return t}var h=Array();var m,v,b,g,y,x,$,w,k;var _=7,I=12,U=17,C=22;var S=5,T=9,M=14,P=20;var A=4,O=11,E=16,L=23;var j=6,N=10,R=15,D=21;e=f(e);h=p(e);x=1732584193;$=4023233417;w=2562383102;k=271733878;for(m=0;m<h.length;m+=16){v=x;b=$;g=w;y=k;x=o(x,$,w,k,h[m+0],_,3614090360);k=o(k,x,$,w,h[m+1],I,3905402710);w=o(w,k,x,$,h[m+2],U,606105819);$=o($,w,k,x,h[m+3],C,3250441966);x=o(x,$,w,k,h[m+4],_,4118548399);k=o(k,x,$,w,h[m+5],I,1200080426);w=o(w,k,x,$,h[m+6],U,2821735955);$=o($,w,k,x,h[m+7],C,4249261313);x=o(x,$,w,k,h[m+8],_,1770035416);k=o(k,x,$,w,h[m+9],I,2336552879);w=o(w,k,x,$,h[m+10],U,4294925233);$=o($,w,k,x,h[m+11],C,2304563134);x=o(x,$,w,k,h[m+12],_,1804603682);k=o(k,x,$,w,h[m+13],I,4254626195);w=o(w,k,x,$,h[m+14],U,2792965006);$=o($,w,k,x,h[m+15],C,1236535329);x=l(x,$,w,k,h[m+1],S,4129170786);k=l(k,x,$,w,h[m+6],T,3225465664);w=l(w,k,x,$,h[m+11],M,643717713);$=l($,w,k,x,h[m+0],P,3921069994);x=l(x,$,w,k,h[m+5],S,3593408605);k=l(k,x,$,w,h[m+10],T,38016083);w=l(w,k,x,$,h[m+15],M,3634488961);$=l($,w,k,x,h[m+4],P,3889429448);x=l(x,$,w,k,h[m+9],S,568446438);k=l(k,x,$,w,h[m+14],T,3275163606);w=l(w,k,x,$,h[m+3],M,4107603335);$=l($,w,k,x,h[m+8],P,1163531501);x=l(x,$,w,k,h[m+13],S,2850285829);k=l(k,x,$,w,h[m+2],T,4243563512);w=l(w,k,x,$,h[m+7],M,1735328473);$=l($,w,k,x,h[m+12],P,2368359562);x=d(x,$,w,k,h[m+5],A,4294588738);k=d(k,x,$,w,h[m+8],O,2272392833);w=d(w,k,x,$,h[m+11],E,1839030562);$=d($,w,k,x,h[m+14],L,4259657740);x=d(x,$,w,k,h[m+1],A,2763975236);k=d(k,x,$,w,h[m+4],O,1272893353);w=d(w,k,x,$,h[m+7],E,4139469664);$=d($,w,k,x,h[m+10],L,3200236656);x=d(x,$,w,k,h[m+13],A,681279174);k=d(k,x,$,w,h[m+0],O,3936430074);w=d(w,k,x,$,h[m+3],E,3572445317);$=d($,w,k,x,h[m+6],L,76029189);x=d(x,$,w,k,h[m+9],A,3654602809);k=d(k,x,$,w,h[m+12],O,3873151461);w=d(w,k,x,$,h[m+15],E,530742520);$=d($,w,k,x,h[m+2],L,3299628645);x=c(x,$,w,k,h[m+0],j,4096336452);k=c(k,x,$,w,h[m+7],N,1126891415);w=c(w,k,x,$,h[m+14],R,2878612391);$=c($,w,k,x,h[m+5],D,4237533241);x=c(x,$,w,k,h[m+12],j,1700485571);k=c(k,x,$,w,h[m+3],N,2399980690);w=c(w,k,x,$,h[m+10],R,4293915773);$=c($,w,k,x,h[m+1],D,2240044497);x=c(x,$,w,k,h[m+8],j,1873313359);k=c(k,x,$,w,h[m+15],N,4264355552);w=c(w,k,x,$,h[m+6],R,2734768916);$=c($,w,k,x,h[m+13],D,1309151649);x=c(x,$,w,k,h[m+4],j,4149444226);k=c(k,x,$,w,h[m+11],N,3174756917);w=c(w,k,x,$,h[m+2],R,718787259);$=c($,w,k,x,h[m+9],D,3951481745);x=a(x,v);$=a($,b);w=a(w,g);k=a(k,y)}var H=u(x)+u($)+u(w)+u(k);return H.toLowerCase()};(function(e){e.fn.stupidtable=function(){var t=e(this);t.on("click","thead th",function(){e(this).stupidsort()})};e.fn.stupidsort=function(){var t=e(this);var a=t.closest("table");var i=a.children("tbody");var s=i.children("tr");var n=t.attr("data-sort-type");if(!n){return}var r=true;if(t.hasClass("sorting-asc")){r=false}var o=0;t.prevAll().each(function(){var t=e(this).attr("colspan");o+=t?Number(t):1});function l(t){var a=e(t).children("td,th");var i=0;var s;a.each(function(){if(i==o){s=e(this);return false}var t=e(this).attr("colspan");i+=t?Number(t):1});var r;if(typeof s.data("sort-value")!="undefined"){r=s.data("sort-value")}else if(typeof s.attr("data-sort-value")!="undefined"){r=s.attr("data-sort-value")}else{r=s.text()}switch(n){case"string":case"string-ins":r=String(r).toLowerCase();break;case"int":r=parseInt(Number(r));break;case"float":r=Number(r);break}return r}s.sort(function(e,t){var a=r?1:-1;e=l(e);t=l(t);if(e>t){return a*1}if(e<t){return a*-1}return 0});i.append(s);a.find("thead th").removeClass("sorting-asc").removeClass("sorting-desc");t.addClass(r?"sorting-asc":"sorting-desc")}})(jQuery);$(function(){UI.elements={menu:$("nav > .menu"),main:$("main"),header:$("header"),connection:{status:$("#connection"),user_and_host:$("#user_and_host"),msg:$("#message")},context_menu:[]};UI.buildMenu();UI.stored.getOpts();document.body.setAttribute("data-browser",function(){var e=window.navigator.userAgent;if(e.indexOf("MSIE ")>=0||e.indexOf("Trident/")>=0){return"ie"}if(e.indexOf("Edge/")>=0){return"edge"}if(e.indexOf("Opera")>=0||e.indexOf("OPR")>=0){return"opera"}if(e.indexOf("Chrome")>=0){return"chrome"}if(e.indexOf("Safari")>=0){return"safari"}if(e.indexOf("Firefox")>=0){return"firefox"}return false}());$("body").on("keydown",function(e){switch(e.key){case"Escape":{for(let e of UI.elements.context_menu){e.hide()}break}}});UI.elements.main.click(function(e){if(!e.isDefaultPrevented()){for(let e of UI.elements.context_menu){e.hide()}}});var e={timeout:false,delay:1500};UI.elements.main.on("mousedown",function(t){var a=t.target;e.timeout=setTimeout(function(){e.timeout=false;var i=new Event("contextmenu",{bubbles:true});i.pageX=t.pageX;i.pageY=t.pageY;a.dispatchEvent(i);function s(e){e.preventDefault()}function n(){window.removeEventListener("click",s,true);document.removeEventListener("mouseup",n)}window.addEventListener("click",s,true);document.addEventListener("mouseup",function(e){requestAnimationFrame(n)})},e.delay)});UI.elements.main.on("mouseleave",function(t){if(e.timeout){clearTimeout(e.timeout);e.timeout=false}});UI.elements.main.on("mouseup",function(t){if(e.timeout){clearTimeout(e.timeout);e.timeout=false}});try{if("mistLogin"in sessionStorage){var t=JSON.parse(sessionStorage["mistLogin"]);mist.user.name=t.name;mist.user.password=t.password;mist.user.host=t.host}}catch(e){}if(location.hash){var a=decodeURIComponent(location.hash).substring(1).split("@");var i=a[0].split("&");mist.user.name=i[0];if(i[1]){mist.user.host=i[1]}}mist.send(function(e){$(window).trigger("hashchange")},{},{timeout:5,hide:true});var s=0;$("body > div.filler").on("scroll",function(){var e=$(this).scrollLeft();if(e!=s){UI.elements.header.css("margin-right",-1*e+"px")}s=e})});var lastpage=[];$(window).on("hashchange",function(e){var t=decodeURIComponent(location.hash).substring(1).split("@");if(!t[1]){t[1]=""}var a=t[1].split("&");if(a[0]==""){a[0]="Overview"}UI.showTab(a[0],a[1],lastpage);if(lastpage[0]!=a[0]||lastpage[1]!=a[1])lastpage=[a[0],a[1]]});var MistVideoObject={};var otherhost={host:false,https:false};var UI={debug:false,elements:{},stored:{getOpts:function(){var e=localStorage["stored"];if(e){e=JSON.parse(e)}$.extend(true,this.vars,e);return this.vars},saveOpt:function(e,t){this.vars[e]=t;localStorage["stored"]=JSON.stringify(this.vars);return this.vars},vars:{helpme:true}},interval:{list:{},clear:function(){for(var e in this.list){clearInterval(this.list[e].id)}this.list={}},set:function(e,t){if(this.opts){log("[interval]","Set called on interval, but an interval is already active.")}var a={delay:t,callback:e,id:setInterval(e,t)};this.list[a.id]=a;return a.id}},websockets:{list:[],clear:function(){for(var e in this.list){this.list[e].close()}},create:function(e,t){var a=new WebSocket(e);var i=this;this.list.push(a);a.addEventListener("close",function(){for(var e=i.list.length-1;e>=0;e--){if(i.list[e]==a){i.list.splice(e,1)}}});a.addEventListener("error",t);return a}},countrylist:{AF:"Afghanistan",AX:"&Aring;land Islands",AL:"Albania",DZ:"Algeria",AS:"American Samoa",AD:"Andorra",AO:"Angola",AI:"Anguilla",AQ:"Antarctica",AG:"Antigua and Barbuda",AR:"Argentina",AM:"Armenia",AW:"Aruba",AU:"Australia",AT:"Austria",AZ:"Azerbaijan",BS:"Bahamas",BH:"Bahrain",BD:"Bangladesh",BB:"Barbados",BY:"Belarus",BE:"Belgium",BZ:"Belize",BJ:"Benin",BM:"Bermuda",BT:"Bhutan",BO:"Bolivia, Plurinational State of",BQ:"Bonaire, Sint Eustatius and Saba",BA:"Bosnia and Herzegovina",BW:"Botswana",BV:"Bouvet Island",BR:"Brazil",IO:"British Indian Ocean Territory",BN:"Brunei Darussalam",BG:"Bulgaria",BF:"Burkina Faso",BI:"Burundi",KH:"Cambodia",CM:"Cameroon",CA:"Canada",CV:"Cape Verde",KY:"Cayman Islands",CF:"Central African Republic",TD:"Chad",CL:"Chile",CN:"China",CX:"Christmas Island",CC:"Cocos (Keeling) Islands",CO:"Colombia",KM:"Comoros",CG:"Congo",CD:"Congo, the Democratic Republic of the",CK:"Cook Islands",CR:"Costa Rica",CI:"C&ocirc;te d'Ivoire",HR:"Croatia",CU:"Cuba",CW:"Cura&ccedil;ao",CY:"Cyprus",CZ:"Czech Republic",DK:"Denmark",DJ:"Djibouti",DM:"Dominica",DO:"Dominican Republic",EC:"Ecuador",EG:"Egypt",SV:"El Salvador",GQ:"Equatorial Guinea",ER:"Eritrea",EE:"Estonia",ET:"Ethiopia",FK:"Falkland Islands (Malvinas)",FO:"Faroe Islands",FJ:"Fiji",FI:"Finland",FR:"France",GF:"French Guiana",PF:"French Polynesia",TF:"French Southern Territories",GA:"Gabon",GM:"Gambia",GE:"Georgia",DE:"Germany",GH:"Ghana",GI:"Gibraltar",GR:"Greece",GL:"Greenland",GD:"Grenada",GP:"Guadeloupe",GU:"Guam",GT:"Guatemala",GG:"Guernsey",GN:"Guinea",GW:"Guinea-Bissau",GY:"Guyana",HT:"Haiti",HM:"Heard Island and McDonald Islands",VA:"Holy See (Vatican City State)",HN:"Honduras",HK:"Hong Kong",HU:"Hungary",IS:"Iceland",IN:"India",ID:"Indonesia",IR:"Iran, Islamic Republic of",IQ:"Iraq",IE:"Ireland",IM:"Isle of Man",IL:"Israel",IT:"Italy",JM:"Jamaica",JP:"Japan",JE:"Jersey",JO:"Jordan",KZ:"Kazakhstan",KE:"Kenya",KI:"Kiribati",KP:"Korea, Democratic People's Republic of",KR:"Korea, Republic of",KW:"Kuwait",KG:"Kyrgyzstan",LA:"Lao People's Democratic Republic",LV:"Latvia",LB:"Lebanon",LS:"Lesotho",LR:"Liberia",LY:"Libya",LI:"Liechtenstein",LT:"Lithuania",LU:"Luxembourg",MO:"Macao",MK:"Macedonia, the former Yugoslav Republic of",MG:"Madagascar",MW:"Malawi",MY:"Malaysia",MV:"Maldives",ML:"Mali",MT:"Malta",MH:"Marshall Islands",MQ:"Martinique",MR:"Mauritania",MU:"Mauritius",YT:"Mayotte",MX:"Mexico",FM:"Micronesia, Federated States of",MD:"Moldova, Republic of",MC:"Monaco",MN:"Mongolia",ME:"Montenegro",MS:"Montserrat",MA:"Morocco",MZ:"Mozambique",MM:"Myanmar",NA:"Namibia",NR:"Nauru",NP:"Nepal",NL:"Netherlands",NC:"New Caledonia",NZ:"New Zealand",NI:"Nicaragua",NE:"Niger",NG:"Nigeria",NU:"Niue",NF:"Norfolk Island",MP:"Northern Mariana Islands",NO:"Norway",OM:"Oman",PK:"Pakistan",PW:"Palau",PS:"Palestine, State of",PA:"Panama",PG:"Papua New Guinea",PY:"Paraguay",PE:"Peru",PH:"Philippines",PN:"Pitcairn",PL:"Poland",PT:"Portugal",PR:"Puerto Rico",QA:"Qatar",RE:"R&eacute;union",RO:"Romania",RU:"Russian Federation",RW:"Rwanda",BL:"Saint Barth&eacute;lemy",SH:"Saint Helena, Ascension and Tristan da Cunha",KN:"Saint Kitts and Nevis",LC:"Saint Lucia",MF:"Saint Martin (French part)",PM:"Saint Pierre and Miquelon",VC:"Saint Vincent and the Grenadines",WS:"Samoa",SM:"San Marino",ST:"Sao Tome and Principe",SA:"Saudi Arabia",SN:"Senegal",RS:"Serbia",SC:"Seychelles",SL:"Sierra Leone",SG:"Singapore",SX:"Sint Maarten (Dutch part)",SK:"Slovakia",SI:"Slovenia",SB:"Solomon Islands",SO:"Somalia",ZA:"South Africa",GS:"South Georgia and the South Sandwich Islands",SS:"South Sudan",ES:"Spain",LK:"Sri Lanka",SD:"Sudan",SR:"Suriname",SJ:"Svalbard and Jan Mayen",SZ:"Swaziland",SE:"Sweden",CH:"Switzerland",SY:"Syrian Arab Republic",TW:"Taiwan, Province of China",TJ:"Tajikistan",TZ:"Tanzania, United Republic of",TH:"Thailand",TL:"Timor-Leste",TG:"Togo",TK:"Tokelau",TO:"Tonga",TT:"Trinidad and Tobago",TN:"Tunisia",TR:"Turkey",TM:"Turkmenistan",TC:"Turks and Caicos Islands",TV:"Tuvalu",UG:"Uganda",UA:"Ukraine",AE:"United Arab Emirates",GB:"United Kingdom",US:"United States",UM:"United States Minor Outlying Islands",UY:"Uruguay",UZ:"Uzbekistan",VU:"Vanuatu",VE:"Venezuela, Bolivarian Republic of",VN:"Viet Nam",VG:"Virgin Islands, British",VI:"Virgin Islands, U.S.",WF:"Wallis and Futuna",EH:"Western Sahara",YE:"Yemen",ZM:"Zambia",ZW:"Zimbabwe"},tooltip:{show:function(e,t){$tooltip=this.element;if(!$.contains(document.body,$tooltip[0])){$("body").append($tooltip)}$tooltip.html(t);clearTimeout(this.hiding);delete this.hiding;var a=$(document).height()-$tooltip.outerHeight();var i=$(document).width()-$tooltip.outerWidth();$tooltip.css("left",Math.min(e.pageX+10,i-10));$tooltip.css("top",Math.min(e.pageY+25,a-10));$tooltip.show().addClass("show")},hide:function(){$tooltip=this.element;$tooltip.removeClass("show");this.hiding=setTimeout(function(){$tooltip.hide()},500)},element:$("<div>").attr("id","tooltip")},context_menu:function(){var e=$("<section>").attr("class","context_menu").click(function(e){e.stopPropagation()});e[0].style.display="none";this.ele=e;UI.elements.context_menu.push(this);this.pos=function(t){var a=e.offsetParent();var i=a[0].getBoundingClientRect();var s=a.height()-e.outerHeight();var n=a.width()-e.outerWidth();e.css("left",Math.min(t.pageX-i.x,n));e.css("top",Math.min(t.pageY-i.y,s))};this.show=function(t,a){if(typeof t=="string"||t instanceof jQuery){e.html(t)}else if(typeof t=="object"){e.html("");if(!Array.isArray(t)){t=[t]}for(var i in t){var s=t[i];if(s instanceof jQuery){e.children().last().remove();e.append(s);e.append($("<hr>"));continue}for(var n in s){var r=s[n];var o=$("<div>");if(typeof r=="string"){o.text(r)}else if(r instanceof jQuery){e.append(r);continue}else{function l(t){if(Array.isArray(t)){var a={};a.text=t[0];if(t.length>=2&&typeof t[1]=="function"){a["function"]=t[1]}if(t.length>=3){a.icon=t[2];if(t.length>=4){a.title=t[3]}}t=a}if("function"in t){o.click(function(a){var i=t["function"].apply(this,arguments);if(i!==false){e.hide()}});o.on("keydown",function(e){switch(e.key){case"Enter":{$(this).click();break}}});o.attr("tabindex","0")}if("icon"in t){o.append($("<div>").addClass("icon").attr("data-icon",t.icon))}if("title"in t){o.attr("title",t.title)}if(typeof t.text=="string"){o[0]._text=document.createTextNode(t.text);o.append(o[0]._text);o[0]._setText=function(e){this._text.nodeValue=e}}else{o.append(t.text);o[0]._setText=function(e){$(this).html(e)}}}l(r)}e.append(o)}e.append($("<hr>"))}e.children().last().remove();e.find("[tabindex]").first().focus()}if(!e.parent()){$("body").append(e)}e[0].style.display="";if(a){this.pos(a)}e.find("[tabindex]").first().focus()};this.hide=function(){e[0].style.display="none"};this.remove=function(){delete UI.element.context_menu;e.remove()};e.on("keydown",function(t){function a(t){var a=e.find(":focus");if(!a.length){e.find("[tabindex]").first().focus();return}if(t=="down"){var i=a.nextAll("[tabindex]");if(!i.length){e.find("[tabindex]").first().focus()}else{i.first().focus()}}else{var s=a.prevAll("[tabindex]");if(!s.length){e.find("[tabindex]").last().focus()}else{s.first().focus()}}}switch(t.key){case"ArrowDown":{a("down");break}case"ArrowUp":{a("up");break}}});this.hide()},pagecontrol:function(e,t){var a=$("<div>").addClass("page_control");a.elements={prev:$("<button>").text("Previous").click(function(){n("previous")}),next:$("<button>").text("Next").click(function(){n("next")}),page_buttons:{},page_button_cont:$("<div>").addClass("page_numbers"),pagelength:$("<select>").append($("<option>").text(5)).append($("<option>").text(10)).append($("<option>").text(25)).append($("<option>").text(50)).append($("<option>").text(100)).change(function(){a.vars.page_size=$(this).val();n()}),jumpto:$("<select>").addClass("jump_to").change(function(){n($(this).val())}),summary:document.createElement("span"),style:document.createElement("style")};a.vars={currentpage:1,page_size:t||25,entries:0,uid:"paginated_"+(Math.random()+"").slice(2)};a.elements.pagelength.val(a.vars.page_size);a.elements.summary.className="summary";a.elements.summary.elements={start:document.createTextNode(""),end:document.createTextNode(""),total:document.createTextNode("")};a.elements.summary.appendChild(document.createTextNode("Showing "));a.elements.summary.appendChild(a.elements.summary.elements.start);a.elements.summary.appendChild(document.createTextNode("-"));a.elements.summary.appendChild(a.elements.summary.elements.end);a.elements.summary.appendChild(document.createTextNode(" of "));a.elements.summary.appendChild(a.elements.summary.elements.total);a.elements.summary.appendChild(document.createTextNode(" items."));a.elements.summary.update=function(){this.elements.start.nodeValue=Math.max(0,(a.vars.currentpage-1)*a.vars.page_size+1);this.elements.end.nodeValue=Math.min(a.vars.currentpage*a.vars.page_size,a.vars.entries);this.elements.total.nodeValue=a.vars.entries;var e=Math.floor((a.vars.entries-1)/a.vars.page_size)+1;while(a.elements.jumpto.children().length<e){a.elements.jumpto.append($("<option>").text(a.elements.jumpto.children().length+1))}while(a.elements.jumpto.children().length>e){a.elements.jumpto.children().last().remove()}};e.classList.add(a.vars.uid);function i(e){var t=document.createElement("button");t.appendChild(document.createTextNode(e));t.addEventListener("click",function(){n(e)});a.elements.page_buttons[e]=t;a.elements.page_button_cont.append(t);return t}var s=false;function n(t){perpage=a.vars.page_size;if(!t)t=a.vars.currentpage;if(t=="next"){t=a.vars.currentpage+1}if(t=="previous"){t=a.vars.currentpage-1}var n=e.querySelectorAll(":scope > :not(.hidden)");a.vars.entries=n.length;if(!s&&a.vars.entries>0){let e=false;if(a.elements.style.textContent!=""){e=a.elements.style.textContent;a.elements.style.textContent=""}s=getComputedStyle(n[0]).getPropertyValue("display");if(s=="none")s=false;if(e){a.elements.style.textContent=e}}n=n.length;if(t instanceof HTMLElement){var r=Array.from(e.children).indexOf(t);t=Math.floor(r/perpage)+1}t=Math.max(1,t);maxpage=Math.floor((n-1)/perpage)+1;t=Math.min(t,maxpage);for(var o=1;o<=maxpage;o++){if(!(o in a.elements.page_buttons)){i(o)}switch(o){case 1:case t-1:case t:case t+1:case maxpage:{a.elements.page_buttons[o].classList.remove("hidden");break}default:{a.elements.page_buttons[o].classList.add("hidden")}}}var l=Object.keys(a.elements.page_buttons);for(var o=maxpage;o<l.length;o++){a.elements.page_buttons[l[o]].classList.add("hidden")}if(a.vars.currentpage in a.elements.page_buttons)a.elements.page_buttons[a.vars.currentpage].classList.remove("active");if(t==1){a.elements.prev.attr("disabled","")}else{a.elements.prev.removeAttr("disabled")}if(t==maxpage){a.elements.next.attr("disabled","")}else{a.elements.next.removeAttr("disabled")}a.vars.currentpage=t;if(a.vars.currentpage in a.elements.page_buttons)a.elements.page_buttons[t].classList.add("active");var d="."+a.vars.uid+" > * { display: none !important; }\n";d+="."+a.vars.uid+" > *:not(.hidden) ";d+="~ *:not(.hidden) ".repeat(Math.max(0,perpage*(t-1)));d+="{ display: "+(s?s:"revert")+" !important; }\n";d+="."+a.vars.uid+"> *:not(.hidden) ";d+="~ *:not(.hidden) ".repeat(perpage*t);d+="{ display: none !important; }\n";a.elements.style.textContent=d;a.elements.summary.update();a.elements.jumpto.val(t)}e.show_page=n;n();a.append($("<div>").addClass("pages").append(a.elements.prev).append(a.elements.page_button_cont).append(a.elements.next)).append(a.elements.summary).append($("<label>").addClass("input_container").append($("<span>").text("Jump to page:")).append(a.elements.jumpto)).append($("<label>").addClass("input_container").append($("<span>").text("Items per page:")).append(a.elements.pagelength)).append(a.elements.style);return a},sortableItems:function(e,t,a){a=Object.assign({controls:false,sortby:false,sortdir:1,container:e,sortsave:false},a);var i=a.sortby;var s=a.sortdir;if(a.controls){if(a.controls.getAttribute("data-sortby")){i=a.controls.getAttribute("data-sortby")}if(a.controls.getAttribute("data-sortdir")){s=a.controls.getAttribute("data-sortdir")}for(var n=0;n<a.controls.children.length;n++){if(a.controls.children[n].hasAttribute("data-index")){a.controls.children[n].addEventListener("click",function(){var t=this.getAttribute("data-index");e.sort(t)})}}}if(a.sortsave){var r=mist.stored.get();if(!(a.sortsave in r)){r[a.sortsave]={}}var o=Object.assign({by:i,dir:s},r[a.sortsave]);i=o.by;s=o.dir}e.sort=function(n,r){if(!r){r=s;if(n==i){r*=-1}}n=n||n==""?n:i;i=n;s=r;if(a.sortsave){mist.stored.set(a.sortsave,{by:n,dir:r})}if(a.controls){a.controls.setAttribute("data-sortby",n);a.controls.setAttribute("data-sortdir",r);var o=a.controls.querySelector("[data-sorting]");if(o){o.removeAttribute("data-sorting")}var l=a.controls.querySelector('[data-index="'+n+'"]');if(l)l.setAttribute("data-sorting","")}try{var d=new Intl.Collator("en",{numeric:true,sensitivity:"accent"}).compare;for(var c=0;c<a.container.children.length-1;c++){var p=a.container.children[c];var u=a.container.children[c+1];if(r*d(t.call(p,n),t.call(u,n))>0){a.container.insertBefore(u,p);if(c>0){c=c-2}}}}catch(t){var f=["Failed to sort items in ",e," by '"+n+"'"];if(n!=a.sortby){f.push(", falling back to '"+a.sortby+"'");console.warn.apply(this,f);this.sort(a.sortby)}else{console.warn.apply(this,f)}}};if(i!==false){e.sort()}},humanMime:function(e){var t=false;switch(e){case"html5/application/vnd.apple.mpegurl":t="HLS (TS)";break;case"html5/application/vnd.apple.mpegurl;version=7":t="HLS (CMAF)";break;case"html5/application/sdp":t="SDP";break;case"html5/video/webm":t="WebM";break;case"html5/video/raw":t="Raw";break;case"html5/video/mp4":t="MP4";break;case"ws/video/mp4":t="MP4 (websocket)";break;case"ws/video/raw":t="Raw (websocket)";break;case"dtsc":t="DTSC";break;case"html5/audio/aac":t="AAC";break;case"html5/audio/flac":t="FLAC";break;case"html5/image/jpeg":t="JPG";break;case"dash/video/mp4":t="DASH";break;case"flash/11":t="HDS";break;case"flash/10":t="RTMP";break;case"flash/7":t="Progressive";break;case"html5/audio/mp3":t="MP3";break;case"html5/audio/wav":t="WAV";break;case"html5/video/mp2t":case"html5/video/mpeg":t="TS";break;case"html5/application/vnd.ms-sstr+xml":case"html5/application/vnd.ms-ss":t="Smooth Streaming";break;case"html5/text/vtt":t="VTT Subtitles";break;case"html5/text/plain":t="SRT Subtitles";break;case"html5/text/javascript":t="JSON Subtitles";break;case"rtsp":t="RTSP";break;case"srt":t="SRT";break;case"webrtc":t="WebRTC (websocket)";break;case"whep":t="WebRTC (WHEP)";break}return t},popup:function(e){var t={element:$("<dialog>").addClass("popup"),show:function(e){this.element.html($("<button>").text("Close").addClass("close").click(function(){t.close()})).append(e);if(!this.element[0].open){$("body").append(this.element);t.element[0].showModal()}t.element.find(".field").first().focus()},close:function(){this.element[0].close()}};t.element[0].addEventListener("mousedown",function(e){if(e.target==this){let a=this.getBoundingClientRect();let i=a.top<=e.clientY&&e.clientY<=a.top+a.height&&a.left<=e.clientX&&e.clientX<=a.left+a.width;if(!i){t.close()}}});t.element[0].addEventListener("close",function(){setTimeout(function(){t.element.remove();t.element=null},1e3)});if(e){t.show(e)}return t},menu:[{Overview:{},General:{hiddenmenu:{"Edit variable":{},"Edit external writer":{},"Edit JWK":{},"Stream keys":{}}},Protocols:{},Streams:{keepParam:true,hiddenmenu:{Edit:{},Status:{},Preview:{},Embed:{}}},Push:{},Triggers:{},Logs:{},Statistics:{},"Server Stats":{}},{Disconnect:{classes:["red"]}},{Documentation:{link:"https://docs.mistserver.org/"},Changelog:{link:"https://releases.mistserver.org/changelog"},"Email for Help":{}}],buildMenu:function(){function e(e,t){var a=$("<a>").addClass("button");a.html($("<span>").addClass("plain").text(e)).append($("<span>").addClass("highlighted").text(e));for(var i in t.classes){a.addClass(t.classes[i])}if("link"in t){a.attr("href",t.link).attr("target","_blank")}else if(!("submenu"in t)){a.click(function(t){if($(this).closest(".menu").hasClass("hide")){return}var a;var i=$(this).closest(".hiddenmenu[data-param]");if(i.length){a=i.attr("data-param")}UI.navto(e,a);t.stopPropagation()})}return a}var t=UI.elements.menu;for(var a in UI.menu){if(a>0){t.append($("<br>"))}for(var i in UI.menu[a]){var s=UI.menu[a][i];var n=e(i,s);t.append(n);if("submenu"in s){var r=$("<span>").addClass("submenu");n.addClass("arrowdown").append(r);for(var o in s.submenu){r.append(e(o,s.submenu[o]))}}else if("hiddenmenu"in s){var r=$("<span>").addClass("hiddenmenu");if(s.keepParam){r.attr("data-param","")}n.append(r);for(var o in s.hiddenmenu){r.append(e(o,s.hiddenmenu[o]))}}}}var l=$("<div>").attr("id","ih_button").text("?").click(function(){$("body").toggleClass("helpme");UI.stored.saveOpt("helpme",$("body").hasClass("helpme"))}).attr("title","Click to toggle the display of integrated help");if(UI.stored.getOpts().helpme){$("body").addClass("helpme")}t.after(l).after($("<div>").addClass("separator"))},findInput:function(e){return this.findInOutput("inputs",e)},findOutput:function(e){return this.findInOutput("connectors",e)},findInOutput:function(e,t){if("capabilities"in mist.data){var a=false;var i=mist.data.capabilities[e];if(t in i){a=i[t]}if(t+".exe"in i){a=i[t+".exe"]}return a}else{throw"Request capabilities first"}},findFolderSubstreams:function(e,t){function a(e,t){var a=$.extend({},t);delete a.meta;delete a.error;a.online=2;a.name=e;a.ischild=true;return a}function i(e){for(var t in mist.data.capabilities.inputs){if(t.indexOf("Buffer")>=0||t.indexOf("Buffer.exe")>=0||t.indexOf("Folder")>=0||t.indexOf("Folder.exe")>=0){continue}if(mist.inputMatch(mist.data.capabilities.inputs[t].source_match,"/"+e)){return true}}return false}mist.send(function(s,n){var r=e.name;var o=0;var l={};for(var d in s.browse.files){if(i(s.browse.files[d])){var c=r+"+"+s.browse.files[d];l[c]=a(c,e);l[c].source=e.source+s.browse.files[d];o++}}if("files"in s.browse&&s.browse.files.length){e.filesfound=true}else{e.filesfound=false}t(l)},{browse:e.source})},findStreamKeys:function(e){if("streamkeys"in mist.data){let t=[];if(typeof mist.data.streamkeys=="object"){for(let a in mist.data.streamkeys){if(mist.data.streamkeys[a]==e){t.push(a)}}}return t}throw"Please request streamkeys first."},findInputBySource:function(e){if(e==""){return null}if("capabilities"in mist.data){let a={};if("matches"in mist.data.capabilities.inputs){a=mist.data.capabilities.inputs.matches}else{for(let s in mist.data.capabilities.inputs){let n=mist.data.capabilities.inputs[s];if(typeof n.source_match=="undefined"){continue}let r=n.source_match;if(typeof r=="string"){r=[r]}for(let o of r){if(o in a&&a[o]!=s){if(n.priority>(e=>e?e:0)(mist.data.capabilities.inputs[a[o]].priority)){a[o]=s}}else{a[o]=s}}}}let i;if("matches_sorted"in mist.data.capabilities.inputs){i=mist.data.capabilities.inputs.matches_sorted}else{i=Object.keys(a).sort((e,t)=>t.length-e.length);let l={};for(let d of Object.keys(mist.data.capabilities.inputs)){l[d.replace(".exe","").toLowerCase()]=1}function t(e){if(e.slice(-2)==":*"){let t=e.slice(0,-2);if(t in l)return 1}return 0}i.sort((e,a)=>t(a)-t(e));Object.defineProperty(mist.data.capabilities.inputs,"matches",{value:a});Object.defineProperty(mist.data.capabilities.inputs,"matches_sorted",{value:i})}for(let c of i){if(mist.inputMatch(c,e)){let p=a[c];mist.data.capabilities.inputs[p].index=p;return mist.data.capabilities.inputs[p]}}return null}else{throw"Please request capabilities first."}},updateLiveStreamHint:function(e,t,a,i,s){let n;if(a=="raw"){n={};a=false}if(!a){a=$("<span>")}a.html("");if(!e||!t){return n||a}if(!i){i=UI.findInputBySource(t);if(i===null){return n||a}}if(!s){s=UI.findStreamKeys(e)}let r;switch(i.name){case"Buffer":case"Buffer.exe":r=["RTMP","TSSRT","RTSP","WebRTC"];break;case"TS":case"TS.exe":if(t.charAt(0)!="/"&&t.slice(0,7)!="ts-exec"){r=["TS"]}break;case"TSSRT":case"TSSRT.exe":{r=["TSSRT"];break}}if(!r){return n||a}var o=parseURL(mist.user.host);var l=t.match(/@.*/);if(l){l=l[0].substring(1)}var d=t.replace(/(?:.+?):\/\//,"");d=d.split("/");d=d[0];d=d.split(":");d=d[0];var c=t.match(/:\d+/)?.[0];var p=t.match(/^push:\/\/([^:@\/]*)/)?.[1];if(p!="invalid,host"){s=[e].concat(s.map(e=>encodeURIComponent(e)))}let u=["RTMP","RTSP","TSSRT","WebRTC","HTTPS","HTTP"];for(let e=u.length-1;e>=0;e--){u.push(u[e]+".exe")}let f={};for(let e=u.length-1;e>=0;e--){let t=u[e];if(t in mist.data.capabilities.connectors){f[t.replace(".exe","")]=mist.data.capabilities.connectors[t].optional.port["default"]}else{u.splice(e,1)}}let h={RTMP:1935,RTSP:554,HTTP:80,HTTPS:443,TSSRT:-1,TS:-1};let m={};for(let e of u){let t=e.replace(".exe","");m[t]=[];for(let a in mist.data.config.protocols){var v=mist.data.config.protocols[a];if(v.connector==e){let e=false;if(t in f)e=":"+f[t];if("port"in v)e=":"+v.port;if(e==":"+h[t])e="";switch(t){case"TSSRT":{if(v.acceptable==1)e=false;if(e!==false){e={port:e,passphrase:v.passphrase}}break}case"HTTP":case"HTTPS":{if("pubaddr"in v&&v.pubaddr.length){m[t].push(v.pubaddr)}break}}if(e!==false)m[t].push(e)}}}if(!n){context_menu=new UI.context_menu}function b(a){let i=a;function r(e,t){return!!n||$("<span>").addClass("value").addClass("clickable").attr("title",t).text(e).on("contextmenu",function(a){a.preventDefault();context_menu.show([[$("<div>").addClass("header").append($("<div>").text(e)).append(t?$("<div>").addClass("description").text(t):"")],[["Copy to clipboard",function(){UI.copy(e).then(()=>{this._setText("Copied!");setTimeout(function(){context_menu.hide()},300)}).catch(t=>{this._setText("Copy: "+t);setTimeout(function(){context_menu.hide()},300);var a=UI.popup(UI.buildUI([$("<h1>").text("Copy to clipboard"),{type:"help",help:"Automatic copying failed ("+t+"). Instead you can manually copy from the field below."},{type:"str",label:"Text",value:e,rows:Math.ceil(e.length/50+2)}]));a.element.find("textarea").select()})},"copy","Copy "+e+" to the clipboard"]]],a)}).click(function(e){this.dispatchEvent(new MouseEvent("contextmenu",e));e.stopPropagation()})}let p=$("<span>").addClass("values");let u=[];switch(a){case"RTMP":{function f(e,t){return"rtmp://"+o.host+t+"/"+(l&&!e?l:"live")+"/"}if(n){u={full_url:[],pairs:{}};for(let b of m["RTMP"]){for(const g of s){u.full_url.push(f(g!=e,b)+g)}for(const y of s){const x=f(y!=e,b);if(!(x in u.pairs)){u.pairs[x]=[]}u.pairs[x].push(y)}}break}for(let w of m["RTMP"]){let k=$("<div>").addClass("sub");for(const U of s){k.append($("<label>").append($("<span>").addClass("label")).append(r(f(U!=e,w)+U,"Use this RTMP url if your client doens't ask for a stream key")))}k.children().first().children().first().text("Full url:");p.append(k);k=$("<div>").addClass("sub");let _;let I=0;for(const C of s){let S=f(C!=e,w);if(_!=S){if(k.children().length)p.append(k);k=$("<div>").addClass("sub");k.append($("<label>").append($("<span>").addClass("label").text(I?"Or url:":"Url:")).append(r(S,"Use this RTMP url if your client also asks for a stream key"))).append($("<label>").append($("<span>").addClass("label").text("with key:")).append(r(C)));_=S;I++}else{k.append($("<label>").append($("<span>").addClass("label")).append(r(C)))}}p.append(k)}break}case"TSSRT":{i="SRT";if(t.slice(0,6)=="srt://"){let T;if(c){var h=parseURL(t.replace());if(h.host==""){h=parseURL(t.replace(/^srt:\/\//,"http://localhost"));h.host=h.host.replace(/^localhost/,"")}if(h.host!=""&&(!h.search||!h.searchParams||h.searchParams.get("mode")!="listener")){T="Caller mode: pulling stream from provided source."}else if(h.search&&h.searchParams&&h.searchParams.get("mode")=="caller"){T="Caller mode: you should probably add an address."}else{T=n?"srt://"+o.host+c:r("srt://"+o.host+c)}}else{T="You must specify a port."}u.push(T);p.append(typeof T=="string"?$("<span>").addClass("value").text(T):T)}else{for(let M of m["TSSRT"]){for(const P of s){if(l&&P==e){if(s.length<=1){let O="SRT cannot be used for input if there is a @password. Did you want to configure an SRT passphrase instead?";u.push(O);p.append($("<span>").addClass("value").text(O))}continue;if(l.length<10||l.length>79){let E="For SRT, the password length must be between 10 and 79 characters.";u.push(E);p.append($("<span>").addClass("value").text(E));continue}}let A="srt://"+o.host+M.port+"?streamid="+P+(M.passphrase?"&passphrase="+M.passphrase:"");u.push(A);p.append(r(A))}}}break}case"WebRTC":{i+=" (WHIP)";let L={};for(let j of["HTTP","HTTPS"]){for(let N of m[j]){if(typeof N=="string"){L[j.toLowerCase()+"://"+o.host+N]=1}else{for(let R of N){L[R]=1}}}}L=Object.keys(L);for(let D of L){for(const H of s){if(l&&H==e){if(s.length<=1){let W=i+" cannot be used for input if there is a @password.";u.push(W);p.append($("<span>").addClass("value").text(W))}continue}let F=D+(D[D.length-1]=="/"?"":"/")+"webrtc/"+H;u.push(F);p.append(r(F))}}break}case"RTSP":{for(const J of m["RTSP"]){for(const B of s){let V="rtsp://"+o.host+J+"/"+B+(l&&B==e?"?pass="+l:"");u.push(V);p.append(r(V))}}break}case"TS":{if(t.charAt(0)=="/"||t.slice(0,7)=="ts-exec"){return}if(t.slice(0,8)=="tsudp://"){let Y="udp://"+(d==""?o.host:d)+(c?c:":[port]")+"/";u.push(Y);p.append(r(Y))}else{return}break}}if(n){n[i]=u;return}let v=$("<label>").append($("<span>").addClass("label").text(i+":"));v.append(p);return v}if(n){for(const e of r){b(e)}}else{a.addClass("livestreamhint").html($("<span>").addClass("unit").html($("<span>").addClass("info").text("i"))).append($("<b>").text("Configure your source to push to:"));if(s.length==0){a.append($("<div>").text("There is no valid push endpoint with your current settings."))}else{for(const e of r){a.append(b(e))}a.append(context_menu.ele)}}return n||a},buildUI:function(e){var t=$("<div>").addClass("input_container");for(var a in e){var i=e[a];if(i===false){continue}if(i instanceof jQuery){t.append(i);continue}if(i.type=="help"){var s=$("<span>").addClass("text_container").append($("<span>").addClass("description").append(i.help));t.append(s);if("classes"in i){for(var n in i.classes){s.addClass(i.classes[n])}}continue}if(i.type=="text"){t.append($("<span>").addClass("text_container").append($("<span>").addClass("text").append(i.text)));continue}if(i.type=="custom"){t.append(i.custom);continue}if(i.type=="buttons"){var r=$("<span>").addClass("button_container").on("keydown",function(e){e.stopPropagation()});if("css"in i){r.css(i.css)}t.append(r);for(var n in i.buttons){var o=i.buttons[n];var l=$("<button>").text(o.label).data("opts",o);if("css"in o){l.css(o.css)}if("classes"in o){for(var d in o.classes){l.addClass(o.classes[d])}}r.append(l);switch(o.type){case"cancel":l.addClass("cancel").attr("data-icon","cross").click(o["function"]);break;case"save":l.addClass("save").attr("data-icon","check").click(function(e){var t=$(this).data("opts")["preSave"];if(t){t.call(this)}var a=$(this).closest(".input_container");a.find(".itemgroup:has(.summary:not(:empty))").addClass("expanded");var i=false;a.find('.hasValidate:visible, input[type="hidden"].hasValidate').each(function(){var e=$(this).data("validate");i=e(this,true);if(i){return false}});var t=$(this).data("opts")["failedValidate"];if(t){t.call(this)}if(i){return}a.find('.isSetting:visible, input[type="hidden"].isSetting').each(function(){var e=$(this).getval();var t=$(this).data("pointer");if(e===""){if("default"in $(this).data("opts")){e=$(this).data("opts")["default"]}else{t.main[t.index]=null;return true}}t.main[t.index]=e;var a=$(this).data("opts")["postSave"];if(a){a.call(this)}});var t=$(this).data("opts")["function"];if(t){t(this)}});break;default:l.click(o["function"]);break}if("icon"in o){l.attr("data-icon",o.icon)}}continue}var c=$("<label>").addClass("UIelement");t.append(c);if("css"in i){c.css(i.css)}c.append($("<span>").addClass("label").html("label"in i?i.label+":":""));if("classes"in i){for(var d in i.classes){c.addClass(i.classes[d])}}var p=$("<span>").addClass("field_container");c.append(p);var u;switch(i.type){case"password":u=$("<input>").attr("type","password");break;case"int":u=$("<input>").attr("type","number");if("min"in i){u.attr("min",i.min)}if("max"in i){u.attr("max",i.max)}if(!("step"in i)){i.step=1}u.attr("step",i.step);if("validate"in i){i.validate.push("int")}else{i.validate=["int"]}break;case"span":u=$("<span>");break;case"debug":i.select=[["","Default"],[0,"0 - NONE: All debugging messages disabled"],[1,"1 - FAIL: Messages about failed operations"],[2,"2 - ERROR: Previous level, and error messages"],[3,"3 - WARN: Previous level, and warning messages"],[4,"4 - INFO: Previous level, and status messages for development"],[5,"5 - MEDIUM: Previous level, and more status messages for development"],[6,"6 - HIGH: Previous level, and verbose debugging messages"],[7,"7 - VERY HIGH: Previous level, and very verbose debugging messages"],[8,"8 - EXTREME: Report everything in extreme detail"],[9,"9 - INSANE: Report everything in insane detail"],[10,"10 - DONTEVEN: All messages enabled"]];case"select":u=$("<select>");for(var n in i.select){var f=$("<option>");if(typeof i.select[n]=="string"){f.text(i.select[n])}else{f.val(i.select[n][0]).text(i.select[n][1])}u.append(f)}break;case"textarea":u=$("<textarea>").on("keydown",function(e){e.stopPropagation()});break;case"checkbox":u=$("<input>").attr("type","checkbox");break;case"hidden":u=$("<input>").attr("type","hidden");c.hide();break;case"email":u=$("<input>").attr("type","email").attr("autocomplete","on").attr("required","");break;case"browse":u=$("<input>").attr("type","text");if("filetypes"in i){u.data("filetypes",i.filetypes)}break;case"geolimited":case"hostlimited":u=$("<input>").attr("type","hidden");break;case"radioselect":u=$("<div>").addClass("radioselect");for(var a in i.radioselect){var h=$("<input>").attr("type","radio").val(i.radioselect[a][0]).attr("name",i.label);if(i.readonly){h.prop("disabled",true)}var m=$("<label>").append(h).append($("<span>").html(i.radioselect[a][1]));u.append(m);if(i.radioselect[a].length>2){var v=$("<select>").change(function(){$(this).parent().find("input[type=radio]:enabled").prop("checked","true")});m.append(v);if(i.readonly){v.prop("disabled",true)}for(var n in i.radioselect[a][2]){var f=$("<option>");v.append(f);if(i.radioselect[a][2][n]instanceof Array){f.val(i.radioselect[a][2][n][0]).html(i.radioselect[a][2][n][1])}else{f.html(i.radioselect[a][2][n])}}}}break;case"checklist":u=$("<div>").addClass("checkcontainer");$controls=$("<div>").addClass("controls");$checklist=$("<div>").addClass("checklist");u.append($checklist);for(var a in i.checklist){if(typeof i.checklist[a]=="string"){i.checklist[a]=[i.checklist[a],i.checklist[a]]}$checklist.append($("<label>").text(i.checklist[a][1]).prepend($("<input>").attr("type","checkbox").attr("name",i.checklist[a][0])))}break;case"DOMfield":u=i.DOMfield;break;case"unix":u=$("<input>").attr("type","datetime-local").attr("step",1);i.unit=$("<button>").text("Now").click(function(){$(this).closest(".field_container").find(".field").setval((new Date).getTime()/1e3)});break;case"selectinput":u=$("<div>").addClass("selectinput");var v=$("<select>");u.append(v);v.data("input",false);for(var a in i.selectinput){var f=$("<option>");v.append(f);if(typeof i.selectinput[a]=="string"){f.text(i.selectinput[a])}else{f.text(i.selectinput[a][1]);if(typeof i.selectinput[a][0]=="string"){f.val(i.selectinput[a][0])}else{f.val("CUSTOM");if(!v.data("input")){v.data("input",UI.buildUI([i.selectinput[a][0]]).children())}}}}if(v.data("input")){u.append(v.data("input"))}v.change(function(){if($(this).val()=="CUSTOM"){$(this).data("input").css("display","flex")}else{$(this).data("input").hide()}});v.trigger("change");break;case"inputlist":function b(e){let t=$("<div>").addClass("inputlist");var a=function(){var i;if("input"in e){i=UI.buildUI([e.input]).find(".field_container");i.find(".field").data("help_container",function(){return t.data("help_container")})}else{var s=Object.assign({},e);delete s.validate;delete s.pointer;s.type="str";i=UI.buildUI([s]).find(".field_container")}i.removeClass("isSetting");i.addClass("listitem");var n=function(e){let i=$(this).find(".field");if($(this).is(":last-child")){if(i.getval()!=""){$(this).after(a())}else if(e.which==8){$(this).prev().find(".field").focus()}}else{if(i.getval()==""){var s=$(this).prev();if(!s.length){s=$(this).next()}s.find(".field").focus();let e=i.data("help_container");if(e){if(typeof e=="function")e=e();if(e?.length)e.find(".err_balloon[data-uid='"+i.data("uid")+"']")?.remove()}$(this).remove();t.find(".field").trigger("change")}}};i.keyup(n);return i};t.data("newitem",a);t.append(t.data("newitem")());t.focus=function(){return $(this).find(".listitem").first().find(".field").focus()};return t}u=b(i);break;case"sublist":{u=$("<div>").addClass("sublist");var g=$("<div>").addClass("curvals");g.append($("<span>").text("None."));var y=$("<div>").addClass("itemsettings");var x=$("<button>").text("New "+i.itemLabel);var w=i.sublist;var k=i;var _=u;var I=c;u.data("build",function(e,t){var a=t;for(var i in k.saveas){if(!(i in e)){delete k.saveas[i]}}k.saveas=Object.assign(k.saveas,e);var s="New";if(typeof t!="undefined"){s="Edit"}var n=UI.buildUI([$("<h4>").text(s+" "+k.itemLabel)].concat(w).concat([{label:"Save first",type:"str",classes:["onlyshowhelp"],validate:[function(){return{msg:"Did you want to save this "+k.itemLabel+"?",classes:["red"]}}]},{type:"buttons",buttons:[{label:"Cancel",type:"cancel",function:function(){y.html("");x.show();I.show()}},{label:"Save "+k.itemLabel,type:"save",preSave:function(){$(this).closest(".input_container").find(".onlyshowhelp").closest("label").hide()},failedValidate:function(){$(this).closest(".input_container").find(".onlyshowhelp").closest("label").show()},function:function(){var e=_.getval();var t=Object.assign({},k.saveas);for(var i in t){if(t[i]===null){delete t[i]}}if(typeof a=="undefined"){e.push(t)}else{e[a]=t}_.setval(e);y.html("");x.show();I.show()}}]}]));y.html(n);x.hide();I.hide()});var U=u;x.click(function(){U.data("build")({})});w.unshift({type:"str",label:"Human readable name",placeholder:"none",help:"A convenient name to describe this "+i.itemLabel+". It won't be used by MistServer.",pointer:{main:i.saveas,index:"x-LSP-name"}});u.data("savelist",[]);u.append(g).append(x);t.append(y);break}case"json":{u=$("<textarea>").on("keydown",function(e){e.stopPropagation()}).on("keyup change",function(e){this.style.height="";this.style.height=(this.scrollHeight?this.scrollHeight+20:this.value.split("\n").length*14+20)+"px"}).css("min-height","3em");var C=function(e,t){if($(t).val()==""){return}if(e===null){return{msg:"Invalid json",classes:["red"]}}};if("validate"in i){i.validate.push(C)}else{i.validate=[C]}break}case"bitmask":{u=$("<div>").addClass("bitmask");for(var a in i.bitmask){u.append($("<label>").append($("<input>").attr("type","checkbox").attr("name","bitmask_"+("pointer"in i?i.pointer.index:"")).attr("value",i.bitmask[a][0]).addClass("field")).append($("<span>").text(i.bitmask[a][1])))}c.attr("for","none");break}case"group":{let R=$("<div>").addClass("itemgroup");let D=i.options;let H=$("<ul>").addClass("summary");D.unshift(H);if("help"in i){D.unshift($("<span>").addClass("description").text(i.help))}if("label"in i){D.unshift($("<b>").text(i.label).attr("tabindex",0).keydown(function(e){e.stopPropagation();if(e.which==13){$(this).trigger("click")}}).click(function(){R.toggleClass("expanded")}).attr("title","Click to show / hide these options"))}if(i.expand||!(i.expand===false)&&Object.keys(i.options).length<2){R.addClass("expanded")}R.change(function(){H.html("");$(this).find('.isSetting, input[type="hidden"].isSetting').each(function(){var e=$(this).getval();if(e==""){return}var t=$(this).data("opts");if(e!=t["default"]){var a=t["label"]+": ";switch(t.type){case"select":{e=t.select.filter(function(t){if(t[0]==e)return true;return false})[0][1];break}case"unix":{e=UI.format.dateTime(e);break}case"checkbox":{e="";a=a.slice(0,-2);break}case"inputlist":{e=e.join(", ");break}}H.append($("<li>").addClass("setting").append($("<span>").addClass("label").text(a)).append($("<span>").text(e)).append($("<span>").addClass("unit").text(typeof t.unit=="string"?t["unit"]:"")))}})}).append(UI.buildUI(D)).trigger("change");t.append(R);c.remove();continue;break}case"str":default:{u=$("<input>").attr("type","text");if("maxlength"in i){u.attr("maxlength",i.maxlength)}if("minlength"in i){u.attr("minlength",i.minlength)}}}u.addClass("field").data("opts",i).data("uid",Math.random().toString().slice(2));if("pointer"in i){u.attr("name",i.pointer.index)}p.append(u);if("classes"in i){for(var n in i.classes){u.addClass(i.classes[n])}}if("placeholder"in i){u.attr("placeholder",i.placeholder)}if("default"in i){u.attr("placeholder",i["default"])}if("unit"in i){if(Array.isArray(i.unit)){var S=$("<select>").change(function(){var e=$(this).closest(".field_container").find(".field");var t=e.data("opts");var a=e.getval();t.factor=Number($(this).val());if("min"in t){e.attr("min",t.min/t.factor)}if("max"in t){e.attr("max",t.max/t.factor)}if("step"in t){e.attr("step",t.step/t.factor)}if("placeholder"in t){e.attr("placeholder",t.placeholder/t.factor)}if(Number(a)!=0)e.setval(a)});for(var a in i.unit){S.append($("<option>").val(i.unit[a][0]).text(i.unit[a][1]))}p.append($("<span>").addClass("unit").html(S));S.trigger("change");u.change(function(e,t){if(t=="initial"){var a=$(this).getval();var i=$(this).data("opts");if(i.placeholder&&Number(a)==0){a=i.placeholder}if(Number(a)!=0){var s=1e9;var n=false;for(var r in i.unit){var o=(a/i.unit[r][0]).toString();if(o.length<s){s=o.length;n=i.unit[r][0]}}if(n){$(this).closest(".field_container").find(".unit select").val(n).trigger("change")}}}});u.trigger("change","initial")}else{p.append($("<span>").addClass("unit").html(i.unit))}}if("prefix"in i){p.prepend($("<span>").addClass("unit").html(i.prefix))}if("readonly"in i){u.attr("readonly","readonly");u.click(function(){if(this.selectionStart==this.selectionEnd){$(this).select()}})}if("qrcode"in i){p.append($("<span>").addClass("unit").html($("<button>").text("QR").on("keydown",function(e){e.stopPropagation()}).click(function(){var e=String($(this).closest(".field_container").find(".field").getval());var t=$("<div>").addClass("qrcode");UI.popup($("<span>").addClass("qr_container").append($("<p>").text(e)).append(t));t.qrcode({text:e,size:Math.min(t.width(),t.height())})})))}if("clipboard"in i&&document.queryCommandSupported("copy")){p.append($("<span>").addClass("unit").html($("<button>").text("Copy").on("keydown",function(e){e.stopPropagation()}).click(function(){var e=String($(this).closest(".field_container").find(".field").getval());var t=document.createElement("textarea");t.value=e;document.body.appendChild(t);t.select();var a=false;try{a=document.execCommand("copy")}catch(e){}if(a){$(this).text("Copied to clipboard!");document.body.removeChild(t);var i=$(this);setTimeout(function(){i.text("Copy")},5e3)}else{document.body.removeChild(t);alert("Failed to copy:\n"+e)}})))}if("rows"in i){u.attr("rows",i.rows)}if("dependent"in i){for(var a in i.dependent){c.attr("data-dependent-"+a,i.dependent[a])}}switch(i.type){case"browse":var T=$("<div>").addClass("grouper").append(c);t.append(T);var M=$("<button>").text("Browse").on("keydown",function(e){e.stopPropagation()});p.append(M);M.click(function(){var e=$("<div>").addClass("browse_container");var t=$(this).siblings(".field");var a;var i=$(this).closest(".grouper");if(i.length){i.append(e);a=t}else{if($(this).closest(".inputlist").length){e.insertAfter($(this).closest(".listitem"));a=e.siblings(".field_container").find(".field")}else{throw"Could not locate browse grouper container"}}a.attr("readonly","readonly").attr("disabled","disabled").css("opacity",.5);var s=$(this);var n=$("<button>").text("Stop browsing").click(function(){e.remove();a.removeAttr("readonly").removeAttr("disabled").css("opacity",1);t.trigger("change")});var r=$("<span>").addClass("field");var o=$("<div>").addClass("browse_contents");var l=$("<a>").addClass("folder");var d=t.data("filetypes");e.append($("<label>").addClass("UIelement").append($("<span>").addClass("label").text("Current folder:")).append($("<span>").addClass("field_container").append(r).append(n))).append(o);function c(i){o.text("Loading..");mist.send(function(i){r.text(i.browse.path[0]);t.setval(i.browse.path[0]+(i.browse.path[0].slice(-1)=="/"?"":"/")).trigger("keyup");o.html(l.clone(true).text("..").attr("title","Folder up"));if(i.browse.subdirectories){i.browse.subdirectories.sort();for(var s in i.browse.subdirectories){var n=i.browse.subdirectories[s];o.append(l.clone(true).attr("title",r.text()+(r.text().slice(-1)=="/"?"":"/")+n).text(n))}}if(i.browse.files){i.browse.files.sort();for(var s in i.browse.files){var n=i.browse.files[s];var c=r.text()+(r.text().slice(-1*p.length)==p?"":p)+n;var u=$("<a>").text(n).addClass("file").attr("title",c);o.append(u);if(d){var f=true;for(var h in d){if(typeof d[h]=="undefined"){continue}if(mist.inputMatch(d[h],c)){f=false;break}}if(f){u.hide()}}u.click(function(){var i=$(this).attr("title");t.setval(i);a.removeAttr("readonly").removeAttr("disabled").css("opacity",1);e.remove();t.trigger("keyup").trigger("change")})}}},{browse:i})}var p="/";if(mist.data.config.version.indexOf("indows")>-1){p="\\"}l.click(function(){var e=r.text()+(r.text().slice(-1*p.length)==p?"":p)+$(this).text();c(e)});var u=t.getval();var f=u.split("://");if(f.length>1){if(f[0]=="file"){u=f[1]}else{u=""}}u=u.split(p);u.pop();u=u.join(p);c(u)});break;case"geolimited":case"hostlimited":var P={field:u};P.blackwhite=$("<select>").append($("<option>").val("-").text("Blacklist")).append($("<option>").val("+").text("Whitelist"));P.values=$("<span>").addClass("limit_value_list");switch(i.type){case"geolimited":P.prototype=$("<select>").append($("<option>").val("").text("[Select a country]"));for(var a in UI.countrylist){P.prototype.append($("<option>").val(a).html(UI.countrylist[a]))}break;case"hostlimited":P.prototype=$("<input>").attr("type","text").attr("placeholder","type a host");break}P.prototype.on("change keyup",function(){var e=$(this).closest(".field_container").data("subUI");e.blackwhite.trigger("change")});P.blackwhite.change(function(){var e=$(this).closest(".field_container").data("subUI");var t=[];var a=false;e.values.children().each(function(){a=$(this).val();if(a!=""){t.push(a)}else{$(this).remove()}});e.values.append(e.prototype.clone(true));if(t.length>0){e.field.val($(this).val()+t.join(" "))}else{e.field.val("")}e.field.trigger("change")});P.values.append(P.prototype.clone(true));p.data("subUI",P).addClass("limit_list").append(P.blackwhite).append(P.values);break}if("value"in i){u.setval(i.value,["initial"])}if("pointer"in i){u.data("pointer",i.pointer).addClass("isSetting");if(i.pointer.main){var A=i.pointer.main[i.pointer.index];if(typeof A!="undefined"){u.setval(A,["initial"])}}}if("datalist"in i){var O="datalist_"+a+MD5(u[0].outerHTML);u.attr("list",O);var E=$("<datalist>").attr("id",O);p.append(E);for(var a in i.datalist){E.append($("<option>").val(i.datalist[a]))}}var L=$("<span>").addClass("help_container");c.append(L);u.data("help_container",L);if("help"in i){L.append($("<span>").addClass("ih_balloon").html(i.help));u.on("focusin mouseover",function(){$(this).closest("label").addClass("active")}).on("focusout mouseout",function(){$(this).closest("label").removeClass("active")})}if("validate"in i){var j=[];for(var n in i.validate){var N=i.validate[n];var C;if(typeof N=="function"){C=N}else{switch(N){case"required":C=function(e,t){if(e==""||e==null){return{msg:"This is a required field.",classes:["red"]}}return false};break;case"int":C=function(e,t){var a=$(t).data("opts");if(!t.validity.valid){if("factor"in a&&a.factor!=1){var i="Please enter a number";var s=[];if(t.validity.stepMismatch){i+=" divisible by "+a.step/a.factor}else if(t.validity.rangeUnderflow||t.validity.rangeOverflow){var n=$(t).closest(".field_container").find(".unit select option:selected").text();if("min"in a){s.push(" greater than or equal to "+a.min/a.factor+" "+n)}if("max"in a){s.push(" smaller than or equal to "+a.max/a.factor+" "+n)}}return{msg:i+s.join(" and")+".",classes:["red"]}}else{var i="Please enter an integer";var s=[];if("min"in a){s.push(" greater than or equal to "+a.min)}if("max"in a){s.push(" smaller than or equal to "+a.max)}return{msg:i+s.join(" and")+".",classes:["red"]}}}};break;case"streamname":{C=function(e,t){if(e==""){return}if(e.toLowerCase()!=e){return{msg:"Uppercase letters are not allowed.",classes:["red"]}}if(e.replace(/[^\da-z_\-\.]/g,"")!=e){return{msg:"Special characters (except for underscores (_), periods (.) and dashes (-)) are not allowed.",classes:["red"]}}if("streams"in mist.data&&e in mist.data.streams){if($(t).data("pointer").main.name!=e){return{msg:"This streamname already exists.<br>If you want to edit an existing stream, please click edit on the the streams tab.",classes:["red"]}}}};break}case"streamname_with_wildcard":{C=function(e,t){if(e==""){return}streampart=e.split("+");var a=streampart.slice(1).join("+");streampart=streampart[0];if(streampart.toLowerCase()!=streampart){return{msg:"Uppercase letters are not allowed in a stream name.",classes:["red"]}}if(streampart.replace(/[^\da-z_]/g,"")!=streampart){return{msg:"Special characters (except for underscores) are not allowed in a stream name.",classes:["red"]}}if(streampart!=e){if(a.replace(/[\00|\0|\/]/g,"")!=a){return{msg:"Slashes or null bytes are not allowed in wildcards.",classes:["red"]}}}};break}case"streamname_with_wildcard_and_variables":{C=function(e,t){if(e==""){return}streampart=e.split("+");var a=streampart.slice(1).join("+");streampart=streampart[0];if(streampart.toLowerCase()!=streampart){return{msg:"Uppercase letters are not allowed in a stream name.",classes:["red"]}}if(streampart.replace(/[^\da-z_$]/g,"")!=streampart){return{msg:"Special characters (except for underscores) are not allowed in a stream name.",classes:["red"]}}if(streampart!=e){if(a.replace(/[\00|\0|\/]/g,"")!=a){return{msg:"Slashes or null bytes are not allowed in wildcards.",classes:["red"]}}}};break}case"track_selector_parameter":{C=function(){};break}case"track_selector":{C=function(){};break}default:C=function(){};break}}j.push(C)}if("checkValidity"in u[0]){j.push(function(e,t){if("checkValidity"in t){if(t.checkValidity()==false){return{msg:"validationMessage"in t?t.validationMessage:"This value ("+e+") is invalid.",classes:["red"]}}}})}u.data("validate_functions",j).data("validate",function(e,t){if(!$(e).is(":visible")&&!$(e).is('input[type="hidden"]')){return}var a=$(e).getval();var i=$(e).data("validate_functions");var s=$(e).data("help_container");var n=$(e).data("uid");if(typeof s=="function"){s=s()}s.find('.err_balloon[data-uid="'+n+'"]')?.remove();for(var r in i){var o=i[r](a,e);if(o){$err=$("<span>").addClass("err_balloon").attr("data-uid",n).html(o.msg);for(var l in o.classes){$err.addClass(o.classes[l])}s.prepend($err);if(typeof o!="object"||!("break"in o)||o.break){if(t){$(e).focus()}return true}}}return false}).addClass("hasValidate").on("change keyup",function(){var e=$(this).data("validate");e(this)});if(u.getval()!=""){u.trigger("change")}}if("function"in i){u.on("change keyup",i["function"]);u.trigger("change")}}t.on("keydown",function(e){var t=false;switch(e.which){case 13:t=$(this).find("button.save").first();break;case 27:t=$(this).find("button.cancel").first();break}if(t&&t.length){t.trigger("click");e.stopPropagation()}});return t},buildVheaderTable:function(e){var t=$("<table>");var a=$("<tr>").addClass("header").append($("<td>").addClass("vheader").attr("rowspan",e.labels.length+1).append($("<span>").text(e.vheader)));var i=[];a.append($("<td>"));for(var s in e.labels){i.push($("<tr>").append($("<td>").html(e.labels[s]==""?"&nbsp;":e.labels[s]+":")))}for(var n in e.content){a.append($("<td>").html(e.content[n].header));for(var s in e.content[n].body){i[s].append($("<td>").html(e.content[n].body[s]))}}t.append($("<tbody>").append(a).append(i));return t},plot:{addGraph:function(e,t){var a={id:e.id,xaxis:e.xaxis,datasets:[],elements:{cont:$("<div>").addClass("graph"),plot:$("<div>").addClass("plot"),legend:$("<div>").addClass("legend").attr("draggable","true")}};UI.draggable(a.elements.legend);a.elements.cont.append(a.elements.plot).append(a.elements.legend);t.append(a.elements.cont);return a},go:function(e){if(Object.keys(e).length<1){return}var t={totals:[],clients:[]};for(var a in e){for(var i in e[a].datasets){var s=e[a].datasets[i];switch(s.datatype){case"clients":case"upbps":case"downbps":case"perc_lost":case"perc_retrans":switch(s.origin[0]){case"total":t["totals"].push({fields:[s.datatype],end:-15});break;case"stream":t["totals"].push({fields:[s.datatype],streams:[s.origin[1]],end:-15});break;case"protocol":t["totals"].push({fields:[s.datatype],protocols:[s.origin[1]],end:-15});break}break;case"cpuload":case"memload":t["capabilities"]={};break}}}if(t.totals.length==0){delete t.totals}if(t.clients.length==0){delete t.clients}mist.send(function(){for(var t in e){var a=e[t];if(a.datasets.length<1){a.elements.plot.html("");a.elements.legend.html("");return}switch(a.xaxis){case"time":var i=[];a.yaxes={};var s=[];for(var n in a.datasets){var r=a.datasets[n];if(r.display){r.getdata();if(!(r.yaxistype in a.yaxes)){i.push(UI.plot.yaxes[r.yaxistype]);a.yaxes[r.yaxistype]=i.length}r.yaxis=a.yaxes[r.yaxistype];s.push(r)}}if(i[0]){i[0].color=0}a.plot=$.plot(a.elements.plot,s,{legend:{show:false},xaxis:UI.plot.xaxes[a.xaxis],yaxes:i,grid:{hoverable:true,borderWidth:{top:0,right:0,bottom:1,left:1},color:"black",backgroundColor:{colors:["rgba(0,0,0,0)","rgba(0,0,0,0.025)"]}},crosshair:{mode:"x"}});var o=$("<table>").addClass("legend-list").addClass("nolay").html($("<tr>").html($("<td>").html($("<h3>").text(a.id))).append($("<td>").css("padding-right","2em").css("text-align","right").html($("<span>").addClass("value")).append($("<button>").data("opts",a).text("X").addClass("close").click(function(){var t=$(this).data("opts");if(confirm("Are you sure you want to remove "+t.id+"?")){t.elements.cont.remove();var a=$(".graph_ids option:contains("+t.id+")");var i=a.parent();a.remove();UI.plot.del(t.id);delete e[t.id];i.trigger("change");UI.plot.go(e)}}))));a.elements.legend.html(o);function l(e){var t=a.elements.legend.find(".value");var i=1;if(typeof e=="undefined"){t.eq(0).html("Latest:")}else{var s=a.plot.getXAxes()[0];e=Math.min(s.max,e);e=Math.max(s.min,e);t.eq(0).html(UI.format.time(e/1e3))}for(var n in a.datasets){var r="&nbsp;";if(a.datasets[n].display){var o=UI.plot.yaxes[a.datasets[n].yaxistype].tickFormatter;var l=a.datasets[n].data;if(!e){r=o(a.datasets[n].data[a.datasets[n].data.length-1][1])}else{for(var d in l){if(l[d][0]==e){r=o(l[d][1]);break}if(l[d][0]>e){if(d!=0){var c=l[d];var p=l[d-1];var u=c[1]+(e-c[0])*(p[1]-c[1])/(p[0]-c[0]);r=o(u)}break}}}}t.eq(i).html(r);i++}}var d=a.plot.getOptions();for(var n in a.datasets){var c=$("<input>").attr("type","checkbox").data("index",n).data("graph",a).click(function(){var e=$(this).data("graph");if($(this).is(":checked")){e.datasets[$(this).data("index")].display=true}else{e.datasets[$(this).data("index")].display=false}var t={};t[e.id]=e;UI.plot.go(t)});if(a.datasets[n].display){c.attr("checked","checked")}o.append($("<tr>").html($("<td>").html($("<label>").html(c).append($("<div>").addClass("series-color").css("background-color",a.datasets[n].color)).append(a.datasets[n].label))).append($("<td>").css("padding-right","2em").css("text-align","right").html($("<span>").addClass("value")).append($("<button>").text("X").addClass("close").data("index",n).data("graph",a).click(function(){var t=$(this).data("index");var a=$(this).data("graph");if(confirm("Are you sure you want to remove "+a.datasets[t].label+" from "+a.id+"?")){a.datasets.splice(t,1);if(a.datasets.length==0){a.elements.cont.remove();var i=$(".graph_ids option:contains("+a.id+")");var s=i.parent();i.remove();s.trigger("change");UI.plot.del(a.id);delete e[a.id];UI.plot.go(e)}else{UI.plot.save(a);var n={};n[a.id]=a;UI.plot.go(n)}}}))))}l();var p=false;a.elements.plot.on("plothover",function(e,t,a){if(t.x!=p){l(t.x);p=t.x}if(a){var i=$("<span>").append($("<h3>").text(a.series.label).prepend($("<div>").addClass("series-color").css("background-color",a.series.color))).append($("<table>").addClass("nolay").html($("<tr>").html($("<td>").text("Time:")).append($("<td>").html(UI.format.dateTime(a.datapoint[0]/1e3,"long")))).append($("<tr>").html($("<td>").text("Value:")).append($("<td>").html(a.series.yaxis.tickFormatter(a.datapoint[1],a.series.yaxis)))));UI.tooltip.show(t,i.children())}else{UI.tooltip.hide()}}).on("mouseout",function(){l()});break;case"coords":break}}},t)},save:function(e){var t={id:e.id,xaxis:e.xaxis,datasets:[]};for(var a in e.datasets){t.datasets.push({origin:e.datasets[a].origin,datatype:e.datasets[a].datatype})}var i=mist.stored.get().graphs||{};i[t.id]=t;mist.stored.set("graphs",i)},del:function(e){var t=mist.stored.get().graphs||{};delete t[e];mist.stored.set("graphs",t)},datatype:{getOptions:function(e){var t=$.extend(true,{},UI.plot.datatype.templates.general);var a=$.extend(true,{},UI.plot.datatype.templates[e.datatype]);e=$.extend(true,a,e);e=$.extend(true,t,e);switch(e.origin[0]){case"total":switch(e.datatype){case"cpuload":case"memload":break;default:e.label+=" (total)"}break;case"stream":case"protocol":e.label+=" ("+e.origin[1]+")";break}var i=[];var s=50;for(var n in e.basecolor){var r=e.basecolor[n];r+=s*(.5-Math.random());r=Math.round(r);r=Math.min(255,Math.max(0,r));i.push(r)}e.color="rgb("+i.join(",")+")";return e},templates:{general:{display:true,datatype:"general",label:"",yaxistype:"amount",data:[],lines:{show:true},points:{show:false},getdata:function(){var e=this.origin[0]=="stream"?this.origin[1]:"all_streams";var t=this.origin[0]=="protocol"?this.origin[1]:"all_protocols";var a=mist.data.totals[e][t][this.datatype];this.data=a;return a}},cpuload:{label:"CPU use",yaxistype:"percentage",basecolor:[237,194,64],cores:1,getdata:function(e){var t=false;for(var a in this.data){if(this.data[a][0]<(mist.data.config.time-600)*1e3){t=a}}if(t!==false){this.data.splice(0,Number(t)+1)}this.data.push([mist.data.config.time*1e3,mist.data.capabilities.cpu_use/10]);return this.data}},memload:{label:"Memory load",yaxistype:"percentage",basecolor:[175,216,248],getdata:function(){var e=false;for(var t in this.data){if(this.data[t][0]<(mist.data.config.time-600)*1e3){e=t}}if(e!==false){this.data.splice(0,Number(e)+1)}this.data.push([mist.data.config.time*1e3,mist.data.capabilities.load.memory]);return this.data}},clients:{label:"Connections",basecolor:[203,75,75]},upbps:{label:"Bandwidth up",yaxistype:"bytespersec",basecolor:[77,167,77]},downbps:{label:"Bandwidth down",yaxistype:"bytespersec",basecolor:[148,64,237]},perc_lost:{label:"Lost packages",yaxistype:"percentage",basecolor:[255,33,234]},perc_retrans:{label:"Re-transmitted packages",yaxistype:"percentage",basecolor:[0,0,255]}}},yaxes:{percentage:{name:"percentage",color:"black",tickColor:0,tickDecimals:0,tickFormatter:function(e,t){return UI.format.addUnit(UI.format.number(e),"%")},tickLength:0,min:0,max:100},amount:{name:"amount",color:"black",tickColor:0,tickDecimals:0,tickFormatter:function(e,t){return UI.format.number(e)},tickLength:0,min:0},bytespersec:{name:"bytespersec",color:"black",tickColor:0,tickDecimals:1,tickFormatter:function(e,t){return UI.format.bits(e*8,true).html()},tickLength:0,ticks:function(e,t,a,i,s){var n=.3*Math.sqrt($(".graph").first().height());var r=(e.max-e.min)/n,o=Math.floor(Math.log(Math.abs(r))/Math.log(1024)),l=r/Math.pow(1024,o),d=-Math.floor(Math.log(l)/Math.LN10),c=e.tickDecimals;if(c!=null&&d>c){d=c}var p=Math.pow(10,-d),u=l/p,f;if(u<1.5){f=1}else if(u<3){f=2;if(u>2.25&&(c==null||d+1<=c)){f=2.5;++d}}else if(u<7.5){f=5}else{f=10}f*=p;f=f*Math.pow(1e3,o);if(e.minTickSize!=null&&f<e.minTickSize){f=e.minTickSize}e.delta=r;e.tickDecimals=Math.max(0,c!=null?c:d);e.tickSize=f;var h=[],m=e.tickSize*Math.floor(e.min/e.tickSize),v=0,b=Number.NaN,g;do{g=b;b=m+v*e.tickSize;h.push(b);++v}while(b<e.max&&b!=g);return h},min:0}},xaxes:{time:{name:"time",mode:"time",timezone:"browser",ticks:5}}},draggable:function(e){e.attr("draggable",true);e.on("dragstart",function(e){$(this).css("opacity",.4).data("dragstart",{click:{x:e.originalEvent.pageX,y:e.originalEvent.pageY},ele:{x:this.offsetLeft,y:this.offsetTop}})}).on("dragend",function(e){var t=$(this).data("dragstart");var a=t.ele.x-t.click.x+e.originalEvent.pageX;var i=t.ele.y-t.click.y+e.originalEvent.pageY;$(this).css({opacity:1,top:i,left:a,right:"auto",bottom:"auto"})});e.parent().on("dragleave",function(){})},copy:function(e){return new Promise(function(t,a){navigator.permissions.query({name:"clipboard-write"}).then(function(a){if(a.state==="granted"||a.state==="prompt"){navigator.clipboard.writeText(e).then(function(){t()}).catch(function(){throw"Failed"})}else{throw"Not permitted"}}).catch(function(i){var s=document.createElement("textarea");s.value=e;s.textContent=e;s.style.position="absolute";s.style.opacity=1e-5;var n=document.activeElement;function r(e,t){if(!t){t=n}if(t.checkVisibility()){t.appendChild(e);return true}if(t.parentNode){return r(e,t.parentNode)}return r(e,document.body);return false}r(s);s.focus();if(document.activeElement!=s){if(n)a("Copy failed (could not obtain focus)");return}s.setSelectionRange(0,e.length);var o=false;try{o=document.execCommand("copy")}catch(e){console.errror(e)}s.parentNode.removeChild(s);n.focus();if(o){t()}else{a(i)}})})},upload:function(e){if(!e){e={description:"text files",accept:{"text/*":[]}}}if(!Array.isArray(e)){e=[e]}return new Promise(function(t,a){if(window.showOpenFilePicker){try{showOpenFilePicker({startIn:"downloads",types:e}).then(function(e){e[0].getFile().then(t).catch(a)}).catch(a)}catch(e){a(e)}}else{var i=$("<input>").attr("type","file").hide().change(function(e){if(this.files&&this.files.length){let e=t(this.files[0]);if(e instanceof Promise){e.finally(function(){i.remove()})}else{setTimeout(function(){i.remove()},1)}return}});$(document.body).append(i.click())}})},format:{time:function(e,t){var a=new Date(e*1e3);var i=[];i.push(("0"+a.getHours()).slice(-2));i.push(("0"+a.getMinutes()).slice(-2));if(t!="short"){i.push(("0"+a.getSeconds()).slice(-2))}return i.join(":")},date:function(e,t){var a=new Date(e*1e3);var i=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];var s=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var n=[];if(t=="long"){n.push(i[a.getDay()])}n.push(("0"+a.getDate()).slice(-2));n.push(s[a.getMonth()]);if(t!="short"){n.push(a.getFullYear())}return n.join(" ")},dateTime:function(e,t){return UI.format.date(e,t)+", "+UI.format.time(e,t)},duration:function(e,t){var a=[.001,1e3,60,60,24,1e99];var i=["ms","sec","min","hr","day"];var s={};var n=!!(e<0);var r=Math.abs(e);for(var o in i){r=Math.round(r/a[o]);var l=r%a[Number(o)+1];s[i[o]]=l;r-=l}var d;for(var o=i.length-1;o>=0;o--){var l=s[i[o]];if(s[i[o]]>0){d=i[o];break}}var c=$("<span>");switch(d){case"day":if(t){c.append(UI.format.addUnit(s.day,"days, ")).append(UI.format.addUnit(s.hr,"hrs"));break}else{c.append(UI.format.addUnit(s.day,"days, "))}default:if(t){switch(d){case"hr":{c.append(UI.format.addUnit(s.hr,"hrs, ")).append(UI.format.addUnit(s.min,"mins"));break}case"min":{c.append(UI.format.addUnit(s.min,"mins, ")).append(UI.format.addUnit(s.sec,"s"));break}case"sec":{var p=Math.round(s.sec*1e3+s.ms)/1e3;c.append(UI.format.addUnit(p,"s"));break}case"ms":{c.append(UI.format.addUnit(s.ms,"ms"));break}}}else{c.append([("0"+s.hr).slice(-2),("0"+s.min).slice(-2),("0"+s.sec).slice(-2)+(s.ms?"."+("00"+s.ms).slice(-3):"")].join(":"))}break}var u=(n?"- ":"")+c[0].innerHTML;return u},number:function(e,t){if(isNaN(Number(e))||e==0){return e}t=Object.assign({round:true},t);if(t.round){var a=3;var i=Math.pow(10,a-Math.floor(Math.log(e)/Math.LN10)-1);e=Math.round(e*i)/i}if(e>=1e4){var s=" ";number=e.toString().split(".");var n=/(\d+)(\d{3})/;while(n.test(number[0])){number[0]=number[0].replace(n,"$1"+s+"$2")}e=number.join(".")}return e},status:function(e){var t=$("<span>");if(typeof e.online=="undefined"){t.text("Unknown, checking..");if(typeof e.error!="undefined"){t.text(e.error)}return t}switch(e.online){case-1:t.text("Enabling");break;case 0:t.text("Unavailable").addClass("red");break;case 1:t.text("Active").addClass("green");break;case 2:t.text("Standby").addClass("orange");break;default:t.text(e.online)}if("error"in e){t.text(e.error)}return t},capital:function(e){return e.charAt(0).toUpperCase()+e.substring(1)},addUnit:function(e,t){var a=$("<span>").html(e);a.append($("<span>").addClass("unit").html(t));return a[0].innerHTML},bitbytes:function(e,t){t=Object.assign({persec:false,bytes:false,base:1e3,info:true},t);var a={bits:{1e3:["bit","kbit","Mbit","Gbit","Tbit","Pbit","Ebit","Zbit"],1024:["bit","Kibit","Mibit","Gibit","Tibit","Pibit","Eibit","Zibit"]},bytes:{1e3:["byte","kbyte","Mbyte","Gbyte","Tbyte","Pbyte","Ebyte","Zbyte"],1024:["byte","Kibyte","Mibyte","Gibyte","Tibyte","Pibyte","Eibyte","Zibyte"]}};if(!(t.base in a[t.bytes?"bytes":"bits"])){t.base=1e3}a=a[[t.bytes?"bytes":"bits"]][t.base];var i="";if(t.persec){i="/s"}var s=e;var n;if(s==0){n=a[0]}else{var r=Math.floor(Math.log(Math.abs(e))/Math.log(t.base));if(r<0){n=a[0]}else{s=s/Math.pow(t.base,r);n=a[r]}}if(n==a[0]&&s!=1){n+="s"}return $("<span>").text(UI.format.number(s)).append($("<span>").addClass("unit").text(n+i).append(t.info&&e!=0?$("<span>").addClass("info").text("i").hover(function(a){var r=$("<h3>").html(UI.format.addUnit(UI.format.number(s),n+i));if(s!=e){r.append(": "+UI.format.addUnit(UI.format.number(Math.round(e),{round:false}),(t.bytes?"bytes":"bits")+i))}UI.tooltip.show(a,$("<div>").append(r).append($("<p>").text("These are "+(t.bytes?"bytes":"bits")+(i==""?"":" per second")+" with a base of "+t.base+" ("+(t.base==1e3?"decimal":"binary")+"). This equals:")).append($("<ul>").append($("<li>").append(UI.format.bitbytes(e,{bytes:t.bytes,persec:t.persec,base:t.base==1e3?1024:1e3,info:false}))).append($("<li>").append(UI.format.bitbytes(t.bytes?e*8:e/8,{bytes:!t.bytes,persec:t.persec,base:t.base,info:false}))).append($("<li>").append(UI.format.bitbytes(t.bytes?e*8:e/8,{bytes:!t.bytes,persec:t.persec,base:t.base==1e3?1024:1e3,info:false})))))},function(){UI.tooltip.hide()}):""))},bytes:function(e,t){return UI.format.bitbytes(e,{bytes:true,persec:t,base:1024})},bits:function(e,t){return UI.format.bitbytes(e,{persec:t,base:1e3})}},navto:function(e,t){var a=location.hash;var i=a.split("@");i[0]=[mist.user.name,mist.user.host].join("&");i[1]=[e,t].join("&");if(typeof screenlog!="undefined"){screenlog.navto(i[1])}location.hash=i.join("@");if(location.hash==a){$(window).trigger("hashchange")}},showTab:function(e,t,a){var i=UI.elements.main;if(typeof a=="undefined"){a=[]}if(mist.user.loggedin){if(!("ui_settings"in mist.data)){i.html("Loading..");mist.send(function(){UI.showTab(e,t)},{ui_settings:true});return}if(mist.data.config.serverid){document.title=mist.data.config.serverid+" - MistServer MI"}}var s=UI.elements.menu.removeClass("hide").find('.plain:contains("'+e+'")').filter(function(){return $(this).text()===e}).closest(".button");if(s.length>0){UI.elements.menu.find(".button.active").removeClass("active");s.addClass("active");$submenu=s.closest("[data-param]");if($submenu.length){$submenu.attr("data-param",t)}}if(window.mv&&mv.reference){mv.reference.unload()}UI.interval.clear();UI.websockets.clear();UI.elements.contextmenu=[];i.attr("data-tab",e).html($("<h2>").text(e));switch(e){case"Login":if(mist.user.loggedin){UI.navto("Overview");return}document.title="MistServer MI";UI.elements.menu.addClass("hide");UI.elements.connection.status.text("Disconnected").removeClass("green").addClass("red");i.append(UI.buildUI([{type:"help",help:"Please provide your account details.<br>You were asked to set these when MistController was started for the first time. If you did not yet set any account details, log in with your desired credentials to create a new account."},{label:"Host",help:"Url location of the MistServer API. Generally located at http://MistServerIP:4242/api",default:"http://localhost:4242/api",pointer:{main:mist.user,index:"host"},validate:[function(e,t){if(e.slice(0,5)!=location.href.slice(0,5)){return{msg:"It looks like you're attempting to connect to a host using "+parseURL(e).protocol+", while this page has been loaded over "+parseURL(location.href).protocol+". Your browser may refuse this because it is insecure.",break:false,classes:["orange"]}}}]},{label:"Username",help:"Please enter your username here.",validate:["required"],pointer:{main:mist.user,index:"name"}},{label:"Password",type:"password",help:"Please enter your password here.",validate:["required"],pointer:{main:mist.user,index:"rawpassword"}},{type:"buttons",buttons:[{label:"Login",type:"save",function:function(){mist.user.password=MD5(mist.user.rawpassword);delete mist.user.rawpassword;mist.send(function(){UI.navto("Overview")})}}]}]));break;case"Create a new account":UI.elements.menu.addClass("hide");i.append($("<p>").text("No account has been created yet in the MistServer at ").append($("<i>").text(mist.user.host)).append("."));i.append(UI.buildUI([{type:"buttons",buttons:[{label:"Select other host",type:"cancel",css:{float:"left"},function:function(){UI.navto("Login")}}]},{type:"custom",custom:$("<br>")},{label:"Desired username",type:"str",validate:["required"],help:"Enter your desired username. In the future, you will need this to access the Management Interface.",pointer:{main:mist.user,index:"name"}},{label:"Desired password",type:"password",validate:["required",function(e,t){$(".match_password.field").not($(t)).trigger("change");return false}],help:"Enter your desired password. In the future, you will need this to access the Management Interface.",pointer:{main:mist.user,index:"rawpassword"},classes:["match_password"]},{label:"Repeat password",type:"password",validate:["required",function(e,t){if(e!=$(".match_password.field").not($(t)).val()){return{msg:'The fields "Desired password" and "Repeat password" do not match.',classes:["red"]}}return false}],help:"Repeat your desired password.",classes:["match_password"]},{type:"buttons",buttons:[{type:"save",label:"Create new account",function:function(){mist.send(function(){UI.navto("Account created")},{authorize:{new_username:mist.user.name,new_password:mist.user.rawpassword}});mist.user.password=MD5(mist.user.rawpassword);delete mist.user.rawpassword}}]}]));break;case"Account created":UI.elements.menu.addClass("hide");i.append($("<p>").text("Your account has been created succesfully.")).append(UI.buildUI([{type:"text",text:"Would you like to enable all (currently) available protocols with their default settings?"},{type:"buttons",buttons:[{label:"Enable protocols",type:"save",function:function(){if(mist.data.config.protocols){i.append("Unable to enable all protocols as protocol settings already exist.<br>");return}i.append("Retrieving available protocols..<br>");mist.send(function(e){var t=[];for(var a in e.capabilities.connectors){var s=e.capabilities.connectors[a];if("PUSHONLY"in s||"NODEFAULT"in s){continue}if(s.required){i.append('Could not enable protocol "'+a+'" because it has required settings.<br>');continue}t.push({connector:a});i.append('Enabled protocol "'+a+'".<br>')}i.append("Saving protocol settings..<br>");mist.send(function(e){i.append("Protocols enabled. Redirecting..");setTimeout(function(){UI.navto("Overview")},5e3)},{config:{protocols:t}})},{capabilities:true})}},{label:"Skip",type:"cancel",function:function(){UI.navto("Overview")}}]}]));break;case"Overview":if(typeof mist.data.bandwidth=="undefined"){mist.send(function(t){UI.navto(e)},{bandwidth:true});i.append("Loading..");return}var n=$("<span>").text("Loading..");var r=$("<span>");var o=$("<span>").addClass("logs");var l=$("<span>");var d=$("<span>");var c=$("<span>").text("Unknown");var p=$("<span>");var u=$("<span>");var f=parseURL(mist.user.host);f=f.protocol+f.host+f.port;var h={};i.append(UI.buildUI([{type:"help",help:"You can find most basic information about your MistServer here.<br>You can also set the debug level and force a save to the config.json file that MistServer uses to save your settings. "},{type:"span",label:"Version",pointer:{main:mist.data.config,index:"version"}},{type:"span",label:"Version check",value:n},{type:"span",label:"Server time",value:d},{type:"span",label:"Licensed to",value:"license"in mist.data.config?mist.data.config.license.user:""},{type:"span",label:"Active licenses",value:c},{type:"span",label:"Configured streams",value:mist.data.streams?Object.keys(mist.data.streams).length:0},{type:"span",label:"Active streams",value:r},{type:"span",label:"Current connections",value:l},{type:"span",label:"Enabled protocols",value:p},{type:"span",label:"Disabled protocols",value:u},{type:"span",label:"Recent problems",value:o},$("<br>"),$("<span>").addClass("bigbuttons").append($("<button>").attr("data-icon","disk").text("Force configuration save").attr("title","Force an immediate save to the config.json MistServer uses to save your settings. Saving will otherwise happen upon closing MistServer.").click(function(){var e=$(this);e.text("Saving..");mist.send(function(){e.attr("data-icon","check").text("Configuration saved!");setTimeout(function(){e.attr("data-icon","disk").text("Force configuration save")},5e3)},{save:true})})).append($("<button>").attr("data-icon","down").text("Download configuration").attr("title","Download the current MistServer configuration file so you can save it on your computer as a backup, or so you can transfer it to other MistServer instances.").click(function(){var e=$(this);e.text("Loading..");mist.send(function(t){e.attr("data-icon","check").text("Configuration retrieved");var a=new Blob([JSON.stringify(t.config_backup)],{type:"text/plain"});var i="MistServer_config_"+(mist.data.config.serverid?mist.data.config.serverid+"_":"")+(new Date).toISOString()+".json";function s(t){console.warn(t);var a="Download failed";if(t.name=="AbortError"){a="Download aborted"}e.attr("data-icon","cross").text(a);setTimeout(function(){e.attr("data-icon","down").text("Download configuration")},5e3)}if(window.showSaveFilePicker){try{showSaveFilePicker({startIn:"downloads",suggestedName:i}).then(function(t){t.createWritable().then(function(t){t.write(a).then(function(){t.close().then(function(){e.attr("data-icon","check").text("Configuration saved!");setTimeout(function(){e.attr("data-icon","down").text("Download configuration")},5e3)}).catch(s)}).catch(s)}).catch(s)}).catch(s);return}catch(e){s(e)}}if(window.navigator.msSaveOrOpenBlob){window.navigator.msSaveOrOpenBlob(a,i)}else{var n=document.createElement("a");var r=URL.createObjectURL(a);n.href=r;n.download=i;document.body.appendChild(n);n.click();setTimeout(function(){document.body.removeChild(n);window.URL.revokeObjectURL(r);e.attr("data-icon","check").text("Configuration saved!")},0)}setTimeout(function(){e.attr("data-icon","down").text("Download configuration")},5e3)},{config_backup:true})})).append($("<button>").attr("data-icon","up").text("Upload configuration").attr("title","Upload a MistServer configuration file and apply its settings. This can be used to restore a backup or to import configuration that you've downloaded from other MistServer instances.\nYour current config will be overwritten!").click(function(){var e=$(this);function t(e){return new Promise(function(t,a){e.text().then(function(i){try{var s=JSON.parse(i)}catch(e){a("Selected file does not contain json")}if(s){mist.send(function(i){var n=i.config_backup;var r=[];var o={streams:function(e){return e.streams?Object.keys(e.streams).length:0},protocols:function(e){return e.config&&e.config.protocols?e.config.protocols.length:0},"automatic pushes":function(e){return e.auto_push?Object.keys(e.auto_push).length:0},triggers:function(e){return e.config&&e.config.triggers?Object.entries(e.config.triggers).map(function(e){return e[1].length}).reduce(function(e,t){return e+t},0):0}};for(var l in o){var d=o[l](n);var c=o[l](s);if(d!=c){r.push("- "+UI.format.capital(l)+": "+d+" to "+c)}}var p="Are you sure you want to apply this config? Your current config will be overwritten!\n\n";if(r.length){p+="These are some of the changes:\n";p+=r.join("\n")+"\n"}else{var u=Object.keys(o);p+="There are no changes in the amount of "+u.slice(0,-1).join(", ")+" or "+u.slice(-1)+" configured.\n"}var f=(new TextEncoder).encode(JSON.stringify(n)).length;var h=e.size;if(f!=h){var m=h/f;p+="The config file size will be ";if(m>1){m--;p+="increased"}else{m=1-m;p+="decreased"}p+=" by "+Math.round(m*100)+"%.\n"}else{p+="The config file size will not change.\n"}if(confirm(p)){mist.send(function(){t();UI.navto("Overview")},{config_restore:s})}else{a("Upload canceled")}},{config_backup:true})}else{a("Selected file does not contain json")}})})}if(window.showOpenFilePicker){function a(t){console.warn(t);var a="Upload failed";if(t.name=="AbortError"){a="Upload aborted"}e.attr("data-icon","cross").text(a);setTimeout(function(){e.attr("data-icon","up").text("Upload configuration")},5e3)}try{showOpenFilePicker({startIn:"downloads",types:[{description:"Configuration files",accept:{"text/*":[".json",".config",".cfg",".conf",".txt"]}}]}).then(function(e){e[0].getFile().then(function(e){t(e).catch(a)}).catch(a)}).catch(a)}catch(s){a(s)}}else{var i=$("<input>").attr("type","file").hide().change(function(e){if(this.files&&this.files.length){t(this.files[0]).catch(a).finally(function(){i.remove()});return}});e.append(i.click())}}))]));function m(e){function t(e){if(!e.update){UI.showTab("Overview");return}var i="";if("progress"in e.update){i=" ("+e.update.progress+"%)"}n.text("Updating.."+i);a(e.log);if(e.update.installing){setTimeout(function(){mist.send(function(e){t(e)},{update:true})},1e3)}}function a(e){var t=e.filter(function(e){return e[1]=="UPDR"});if(t.length){var a=$("<div>");n.append(a);for(var i in t){a.append($("<div>").text(t[i][2]))}}}if(!e.update||!("uptodate"in e.update)){n.text("Unknown, checking..");setTimeout(function(){mist.send(function(e){if("update"in e){m(e)}},{checkupdate:true})},5e3);return}else if(e.update.error){n.addClass("red").text(e.update.error);return}else if(e.update.uptodate){n.text("Your version is up to date.").addClass("green");return}else if(e.update.progress){n.addClass("orange").removeClass("red").text("Updating..");t(e)}else{n.text("");n.append($("<span>").addClass("red").text("On "+new Date(e.update.date).toLocaleDateString()+" version "+e.update.version+" became available."));if(!e.update.url||e.update.url.slice(-4)!=".zip"){n.append($("<button>").text("Rolling update").css({"font-size":"1em","margin-left":"1em"}).click(function(){if(confirm("Are you sure you want to execute a rolling update?")){n.addClass("orange").removeClass("red").text("Rolling update command sent..");mist.send(function(e){t(e)},{autoupdate:true})}}))}var i=$("<a>").attr("href",e.update.url).attr("target","_blank").text("Manual download");i[0].protocol="https:";n.append($("<div>").append(i))}a(e.log)}m(mist.data);if("license"in mist.data.config){if("active_products"in mist.data.config.license&&Object.keys(mist.data.config.license.active_products).length){var v=$("<table>").css("text-indent","0");c.html(v);v.append($("<tr>").append($("<th>").append("Product")).append($("<th>").append("Updates until")).append($("<th>").append("Use until")).append($("<th>").append("Max. simul. instances")));for(var b in mist.data.config.license.active_products){var g=mist.data.config.license.active_products[b];v.append($("<tr>").append($("<td>").append(g.name)).append($("<td>").append(g.updates_final?g.updates_final:"&infin;")).append($("<td>").append(g.use_final?g.use_final:"&infin;")).append($("<td>").append(g.amount?g.amount:"&infin;")))}}else{c.text("None. ")}c.append($("<a>").text("More details").attr("href","https://shop.mistserver.org/myinvoices").attr("target","_blank"))}function y(){var e={totals:{fields:["clients"],start:-10},active_streams:true};if(!("capabilities"in mist.data)){e.capabilities=true}mist.send(function(e){x()},e)}function x(){if("active_streams"in mist.data){var e=mist.data.active_streams?mist.data.active_streams.length:0}else{var e="?"}r.text(e);if("totals"in mist.data&&"all_streams"in mist.data.totals){var t=mist.data.totals.all_streams.all_protocols.clients;t=t.length?UI.format.number(t[t.length-1][1]):0}else{t="Loading.."}l.text(t);d.text(UI.format.dateTime(mist.data.config.time,"long"));o.html("");var a=0;if("license"in mist.data.config&&"user_msg"in mist.data.config.license){mist.data.log.unshift([mist.data.config.license.time,"ERROR",mist.data.config.license.user_msg])}for(var i in mist.data.log){var s=mist.data.log[i];if(["FAIL","ERROR"].indexOf(s[1])>-1){a++;var n=$("<span>").addClass("content").addClass("red");var c=s[2].split("|");for(var i in c){n.append($("<span>").text(c[i]))}o.append($("<div>").append($("<span>").append(UI.format.time(s[0])).css("margin-right","0.5em")).append(n));if(a==5){break}}}if(a==0){o.html("None.")}var f={on:[],off:[]};for(var i in mist.data.config.protocols){var h=mist.data.config.protocols[i];if(f.on.indexOf(h.connector)>-1){continue}f.on.push(h.connector)}p.text(f.on.length?f.on.join(", "):"None.");if("capabilities"in mist.data){for(var i in mist.data.capabilities.connectors){if(f.on.indexOf(i)==-1){f.off.push(i)}}u.text(f.off.length?f.off.join(", "):"None.")}else{u.text("Loading..")}}y();x();UI.interval.set(y,3e4);break;case"General":{var w={serverid:mist.data.config.serverid,debug:mist.data.config.debug,accesslog:mist.data.config.accesslog,prometheus:mist.data.config.prometheus,defaultStream:mist.data.config.defaultStream,trustedproxy:mist.data.config.trustedproxy};var k={sessionViewerMode:mist.data.config.sessionViewerMode,sessionInputMode:mist.data.config.sessionInputMode,sessionOutputMode:mist.data.config.sessionOutputMode,sessionUnspecifiedMode:mist.data.config.sessionUnspecifiedMode,tknMode:mist.data.config.tknMode,sessionStreamInfoMode:mist.data.config.sessionStreamInfoMode};var _={location:"location"in mist.data.config?mist.data.config.location:{}};i.html(UI.buildUI([$("<h2>").text("General settings"),{type:"help",help:"These are settings that apply to your MistServer instance in general."},{type:"str",label:"Human readable name",pointer:{main:w,index:"serverid"},help:"You can name your MistServer here for personal use. You'll still need to set host name within your network yourself."},{type:"debug",label:"Debug level",pointer:{main:w,index:"debug"},help:"You can set the amount of debug information MistServer saves in the log. A full reboot of MistServer is required before some components of MistServer can post debug information."},{type:"selectinput",label:"Access log",selectinput:[["","Do not track"],["LOG","Log to MistServer log"],[{type:"str",label:"Path",LTSonly:true},"Log to file"]],pointer:{main:w,index:"accesslog"},help:"Enable access logs.",LTSonly:true},{type:"selectinput",label:"Prometheus stats output",selectinput:[["","Disabled"],[{type:"str",label:"Passphrase",LTSonly:true},"Enabled"]],pointer:{main:w,index:"prometheus"},help:"Make stats available in Prometheus format. These can be accessed via "+f+"/PASSPHRASE or "+f+"/PASSPHRASE.json.",LTSonly:true},{type:"inputlist",label:"Trusted proxies",help:"List of proxy server addresses that are allowed to override the viewer IP address to arbitrary values.<br>You may use a hostname or IP address.",pointer:{main:w,index:"trustedproxy"}},{type:"str",validate:["streamname_with_wildcard_and_variables"],label:"Fallback stream",pointer:{main:w,index:"defaultStream"},help:"When this is set, if someone attempts to view a stream that does not exist, or is offline, they will be redirected to this stream instead. $stream may be used to refer to the original stream name.",LTSonly:true},{type:"buttons",buttons:[{type:"save",label:"Save",function:function(e){$(e).text("Saving..");var t={config:w};mist.send(function(){UI.navto("General")},t)}}]}]));i.append(UI.buildUI([$("<h3>").text("Sessions"),{type:"bitmask",label:"Bundle viewer sessions by",bitmask:[[8,"Stream name"],[4,"IP address"],[2,"Token"],[1,"Protocol"]],pointer:{main:k,index:"sessionViewerMode"},help:"Change the way viewer connections are bundled into sessions.<br>Default: stream name, viewer IP and token"},{type:"bitmask",label:"Bundle input sessions by",bitmask:[[8,"Stream name"],[4,"IP address"],[2,"Token"],[1,"Protocol"]],pointer:{main:k,index:"sessionInputMode"},help:"Change the way input connections are bundled into sessions.<br>Default: stream name, input IP, token and protocol"},{type:"bitmask",label:"Bundle output sessions by",bitmask:[[8,"Stream name"],[4,"IP address"],[2,"Token"],[1,"Protocol"]],pointer:{main:k,index:"sessionOutputMode"},help:"Change the way output connections are bundled into sessions.<br>Default: stream name, output IP, token and protocol"},{type:"bitmask",label:"Bundle unspecified sessions by",bitmask:[[8,"Stream name"],[4,"IP address"],[2,"Token"],[1,"Protocol"]],pointer:{main:k,index:"sessionUnspecifiedMode"},help:"Change the way unspecified connections are bundled into sessions.<br>Default: none"},{type:"select",label:"Treat HTTP-only sessions as",select:[[1,"A viewer session"],[2,"An output session: skip executing the USER_NEW and USER_END triggers"],[4,"A separate 'unspecified' session: skip executing the USER_NEW and USER_END triggers"],[3,"Do not start a session: skip executing the USER_NEW and USER_END triggers and do not count for statistics"]],pointer:{main:k,index:"sessionStreamInfoMode"},help:"Change the way the stream info connection gets treated.<br>Default: as a viewer session"},{type:"bitmask",label:"Communicate session token",bitmask:[[8,"Write to cookie"],[4,"Write to URL parameter"],[2,"Read from cookie"],[1,"Read from URL parameter"]],pointer:{main:k,index:"tknMode"},help:"Change the way the session token gets passed to and from MistServer, which can be set as a cookie or URL parameter named `tkn`. Reading the session token as a URL parameter takes precedence over reading from the cookie.<br>Default: all"},{type:"buttons",buttons:[{type:"save",label:"Save",function:function(e){$(e).text("Saving..");var t={config:k};mist.send(function(){UI.navto("General")},t)}}]}]));var I=$("<div>").html("Loading..");mist.send(function(e){if(!e.variable_list){I.html("None configured.");return}var t=$("<tbody>");I.html($("<table>").html($("<thead>").html($("<tr>").append($("<th>").text("Variable")).append($("<th>").text("Latest value")).append($("<th>").text("Command or url")).append($("<th>").text("Check interval")).append($("<th>").text("Last checked")).append($("<th>")))).append(t));for(var a in e.variable_list){var i=e.variable_list[a];t.append($("<tr>").addClass("variable").attr("data-name",a).html($("<td>").text("$"+a)).append($("<td>").html($("<code>").text("target"in i?i.lastunix>0?JSON.stringify(i.value):"":JSON.stringify(i.value)))).append($("<td>").html("target"in i?i.target.match(/^http(s)?:\/\//)?$("<a>").attr("target","_blank").attr("href",i.target).text(i.target):i.target:"")).append($("<td>").html("target"in i?i.interval==0?"Once":UI.format.duration(i.interval):"Never")).append($("<td>").attr("title","target"in i?i.lastunix>0?"At "+UI.format.dateTime(new Date(i.lastunix),"long"):"Not yet":"").html("target"in i?i.lastunix>0?UI.format.duration((new Date).getTime()*.001-i.lastunix)+" ago":"Not yet":"")).append($("<td>").html($("<button>").text("Edit").click(function(){var e=$(this).closest("tr").attr("data-name");UI.navto("Edit variable",e)})).append($("<button>").text("Remove").click(function(){var e=$(this).closest("tr").attr("data-name");if(confirm("Are you sure you want to remove the custom variable $"+e+"?")){mist.send(function(){UI.showTab("General")},{variable_remove:e})}}))))}},{variable_list:true});i.append(UI.buildUI([$("<h3>").text("Custom variables"),{type:"help",help:"In certain places, like target URL's and pushes, variable substitution is applied in order to replace a $variable with their corresponding value. Here you can define your own constants and variables which will be used when variable substitution is applied. Variables can be used within variables but will not be reflected in their latest value on this page."},$("<div>").addClass("button_container").css("text-align","right").html($("<button>").attr("data-icon","plus").text("New variable").click(function(){UI.navto("Edit variable","")})),I]));var U=$("<div>").text("Loading..");i.append(UI.buildUI([$("<h3>").text("Load balancer"),{type:"help",help:"If you're using MistServer's load balancer, the information below is passed to it so that it can make informed decisions."},U]));mist.send(function(e){var t={limit:""};if("bandwidth"in e){t=e.bandwidth;if(t==null){t={}}if(!t.limit){t.limit=""}}U.html(UI.buildUI([{type:"selectinput",label:"Server's bandwidth limit",selectinput:[["","Default (1 Gbit/s)"],[{label:"Custom",type:"number",min:0,unit:[[.125,"bit/s"],[125,"kbit/s"],[125e3,"Mbit/s"],[125e6,"Gbit/s"]]},"Custom"]],pointer:{main:t,index:"limit"},help:"This is the amount of traffic this server is willing to handle."},{type:"inputlist",label:"Bandwidth exceptions",pointer:{main:t,index:"exceptions"},help:"Data sent to the hosts and subnets listed here will not count towards reported bandwidth usage.<br>Examples:<ul><li>192.168.0.0/16</li><li>localhost</li><li>10.0.0.0/8</li><li>fe80::/16</li></ul>"},{type:"int",step:1e-8,label:"Server latitude",pointer:{main:_.location,index:"lat"},help:"This setting is only useful when MistServer is combined with a load balancer. When this is set, the balancer can send users to a server close to them."},{type:"int",step:1e-8,label:"Server longitude",pointer:{main:_.location,index:"lon"},help:"This setting is only useful when MistServer is combined with a load balancer. When this is set, the balancer can send users to a server close to them."},{type:"str",label:"Server location name",pointer:{main:_.location,index:"name"},help:"This setting is only useful when MistServer is combined with a load balancer. This will be displayed as the server's location."},{type:"buttons",buttons:[{type:"save",label:"Save",function:function(e){$(e).text("Saving..");var a={config:_};var i={};i.limit=t.limit;i.exceptions=t.exceptions;if(i.exceptions===null){i.exceptions=[]}a.bandwidth=i;mist.send(function(){UI.navto("Overview")},a)}}]}]))},{bandwidth:true});var C=$("<div>").html("Loading..");i.append(UI.buildUI([$("<h3>").text("External writers"),{type:"help",help:"When pushing a stream to a target unsupported by MistServer like S3 storage, an external writer can be provided which handles writing the media data to the target location. The writer will receive data over stdin and MistServer will print any info written to stdout and stderr as log messages."},$("<div>").addClass("button_container").css("text-align","right").html($("<button>").attr("data-icon","plus").text("New external writer").click(function(){UI.navto("Edit external writer","")})),C]));let Ce=$("<div>").html("Loading..");i.append(UI.buildUI([$("<h3>").text("JSON web keys (JWK)"),{type:"help",help:"You can use JSON web tokens (JWT) to control permissions for viewing certain streams, inputting a stream or even access to this Management Interface.<br>Here, you can store your public keys (JWK) that will be used to validate the JWT's. You can also supply an url from which MistServer can download a key set (JWKS)."},$("<div>").addClass("button_container").css("text-align","right").html($("<button>").attr("data-icon","plus").text("Add JWK").click(function(){UI.navto("Edit JWK","")})),Ce]));mist.send(function(e){if(!e.external_writer_list){C.html("None configured.")}else{var t=$("<tbody>");C.html($("<table>").html($("<thead>").html($("<tr>").append($("<th>").text("Name")).append($("<th>").text("Command line")).append($("<th>").text("URI protocols handled")).append($("<th>")))).append(t));for(var a in e.external_writer_list){var i=e.external_writer_list[a];t.append($("<tr>").addClass("uploader").attr("data-name",a).html($("<td>").text(i[0])).append($("<td>").html($("<code>").html(i[1]))).append($("<td>").text(i[2]?i[2].join(", "):"none").addClass("desc")).append($("<td>").html($("<button>").text("Edit").click(function(){var e=$(this).closest("tr").attr("data-name");UI.navto("Edit external writer",e)})).append($("<button>").text("Remove").click(function(){var t=$(this).closest("tr").attr("data-name");var a=e.external_writer_list[t][0];if(confirm("Are you sure you want to remove the Uploader '"+a+"'?")){mist.send(function(){UI.showTab("General")},{external_writer_remove:a})}}))))}}if(!e.jwks){Ce.html("None configured.")}else{let t=$("<tbody>");let a=new UI.context_menu;for(let i of e.jwks){let e=i[0];let s=i.length>1?i[1]:false;if(!s){s={input:true,output:true,admin:false,stream:"*"}}let n;if(typeof e=="string"){n=$("<a>").attr("href",e).attr("target","_blank").text(e)}else{let t=e?.kid?e.kid:JSON.stringify(e,null,2);n=$("<div>").addClass("key").addClass("clickable").text(t).attr("title",t)}t.append($("<tr>").attr("title",typeof e=="string"?e:JSON.stringify(e,null,2)).on("contextmenu",function(t){t.preventDefault();a.show([[$("<div>").addClass("header").html(n.clone())],[["Copy "+(typeof e=="string"?"url":"key"),function(){let t=typeof e=="string"?e:JSON.stringify(e);UI.copy(t).then(()=>{this._setText("Copied!");setTimeout(function(){a.hide()},300)}).catch(e=>{this._setText("Copy: "+e);setTimeout(function(){a.hide()},300);var i=UI.popup(UI.buildUI([$("<h1>").text("Copy to clipboard"),{type:"help",help:"Automatic copying failed ("+e+"). Instead you can manually copy from the field below."},{type:"str",label:"Text",value:t,rows:Math.ceil(t.length/50+2)}]));i.element.find("textarea").select()})},"copy","Copy this "+(typeof e=="string"?"url":"key")+" to the clipboard."],["Edit",function(){UI.navto("Edit JWK",$(t.target).closest("tr").index())},"Edit","Edit this "+(typeof e=="string"?"url":"key")+" or its permissions."]]],t)}).append($("<td>").html(n)).append($("<td>").text(typeof e=="string"?"url":e.kty)).append(function(){let e=$("<td>").addClass("permissions");if(s.output){e.append($("<div>").addClass("output").attr("title","Viewing"))}if(s.input){e.append($("<div>").addClass("input").attr("title","Input"))}if(s.admin){e.append($("<div>").addClass("admin").attr("title","MI and API"))}if(!s.stream)s.stream="*";e.append($("<div>").addClass("streams").text(Array.isArray(s.stream)?"For streams: "+s.stream.join(", "):s.stream=="*"?"For all streams":"For streams: "+s.stream));return e}()).append($("<td>").append($("<button>").attr("data-icon","Edit").text("Edit").click(function(){UI.navto("Edit JWK",$(this).closest("tr").index())})).append($("<button>").attr("data-icon","trash").text("Delete").click(function(){if(confirm("Are you sure you want to delete this key?\n"+(typeof e=="string"?e:n[0].innerText))){mist.send(function(){UI.navto("General")},{deletejwks:typeof e=="string"?e:e.kid?e.kid:e})}}))))}Ce.html($("<table>").addClass("JWKs").append($("<thead>").append($("<tr>").append($("<th>").text("Key id or url to key set")).append($("<th>").text("Key type")).append($("<th>").text("Can permit")).append($("<th>")))).append(t)).append(a.ele)}},{external_writer_list:true,jwks:true});break}case"Edit external writer":{var S=false;if(t!=""){S=true}function T(){if(!S){i.html($("<h2>").text("New external writer"))}else{i.html($("<h2>").text("Edit external writer '"+t+"'"))}var e={};if(mist.data.external_writer_list&&t in mist.data.external_writer_list){var a=mist.data.external_writer_list[t];e.name=a[0];e.cmdline=a[1];e.protocols=a[2]}i.append(UI.buildUI([{type:"str",label:"Human readable name",help:"A human readable name for the external writer.",validate:["required"],pointer:{main:e,index:"name"}},{type:"str",label:"Command line",help:"Command line for a local command (with optional arguments) which will write media data to the target.",validate:["required"],pointer:{main:e,index:"cmdline"}},{type:"inputlist",label:"URI protocols handled",help:"URI protocols which the external writer will be handling.",validate:["required",function(e){for(var t in e){var a=e[t];if(a.match(/^([a-z\d\+\-\.])+?$/)===null){return{classes:["red"],msg:"There was a problem with the protocol URI '"+function(e){return $("<div>").text(e).html()}(a)+"':<br>A protocol URI may only contain lower case letters, digits, and the following special characters . + and -"};break}}}],input:{type:"str",unit:"://"},pointer:{main:e,index:"protocols"}},{type:"buttons",buttons:[{type:"cancel",label:"Cancel",function:function(){UI.navto("General")}},{type:"save",label:"Save",function:function(){var a={external_writer_add:e};var i=null;if(t!=""&&t in mist.data.external_writer_list){i=mist.data.external_writer_list[t][0]}if(i!==null&&e.name!=i){a.external_writer_remove=i}mist.send(function(){UI.navto("General")},a)}}]}]))}if("external_writer_list"in mist.data){T()}else{mist.send(function(){T()},{external_writer_list:true})}break}case"Edit variable":{var S=false;if(t!=""){S=true}function M(e,a){if(!S){i.html($("<h2>").text("New Variable"))}else{i.html($("<h2>").text('Edit Variable "$'+t+'"'))}var s=$("<div>");i.append(UI.buildUI([{type:"str",maxlength:31,label:"Variable name",prefix:"$",help:"What should the variable be called? A dollar sign will automatically be prepended.",pointer:{main:e,index:"name"},validate:["required",function(e){if(e.length&&e[0]=="$"){return{msg:"The dollar sign will automatically be prepended. You don't need to type it here.",classes:["red"]}}if(e.indexOf("{")!==-1||e.indexOf("}")!==-1||e.indexOf("$")!==-1){return{msg:'The following symbols are not permitted: "$ { }".',classes:["red"]}}}]},{type:"select",label:"Type",help:"What kind of variable is this? It can either be a static value that you can enter below, or a dynamic one that is returned by a command or url.",select:[["value","Static value"],["command","Dynamic through command or url"]],value:"value",pointer:{main:a,index:"type"},function:function(){var e=[$("Invalid variable type")];switch($(this).val()){case"value":{e=[{type:"str",label:"Value",pointer:{main:a,index:"value"},help:"The static value that this variable should be replaced with. There is a character limit of 63 characters.",validate:["required"]}];break}case"command":{e=[{type:"str",label:"Command",help:"The command that should be executed or the url that should be downloaded to retrieve the value for this variable.<br>For example:<br><code>/usr/bin/date +%A</code><br>There is a character limit of 511 characters.",validate:["required"],pointer:{main:a,index:"target"}},{type:"int",min:0,max:4294967295,step:.001,default:0,label:"Checking interval",unit:"s",help:"At what interval, in seconds, MistServer should execute the command and update the value.<br>To execute the command once when MistServer starts up (and then never update), set the interval to 0.",pointer:{main:a,index:"interval"}},{type:"int",min:0,max:4294967295,step:.001,default:1,label:"Wait time",unit:"s",help:"Specifies the maximum time, in seconds, MistServer should wait for data when executing the variable target. If set to 0 this variable takes on the same value as the interval.<br>MistServer only updates one variable at a time, so setting this value too high can block other variables from updating.",pointer:{main:a,index:"waitTime"}}];break}}s.html(UI.buildUI(e))}},s,{type:"buttons",buttons:[{type:"cancel",label:"Cancel",function:function(){UI.navto("General")}},{type:"save",label:"Save",function:function(){var i={variable_add:e};switch(a.type){case"value":{e.value=a.value;break}case"command":{e.target=a.target;e.interval=a.interval;e.waitTime=a.waitTime;break}}if(e.name!=t){i.variable_remove=t}mist.send(function(){UI.navto("General")},i)}}]}]))}i.html("Loading..");if(!S){M({},{})}else{mist.send(function(e){if(t in e.variable_list){var a=e.variable_list[t];a.type="target"in a?"command":"value";M({name:t},a)}else{i.append('Variable "$'+t+'" does not exist.')}},{variable_list:true})}break}case"Edit JWK":{let Se=false;if(t!=""){Se=true;i.html("Loading..");mist.send(T,{jwks:true})}else{T()}function T(e){if(Se&&e&&e.jwks){Se=e.jwks?.[Number(t)];if(Se&&(Se.length<2||!Se[1])){Se[1]={input:true,output:true,admin:false,stream:"*"}}}i.html($("<h2>").text(Se?typeof Se[0]=="string"?"Edit url to JWKS":"Edit JSON web key":"Add JSON web key(s)"));let a={urls:[],keys:[],permissions:{}};if(Se){if(typeof Se[0]=="string"){a.urls=[Se[0]]}else{a.keys=[JSON.stringify(Se[0],null,2)]}a.permissions=Se[1]}i.append(UI.buildUI([{type:"help",help:"You can use JSON web tokens (JWT) to control permissions for viewing certain streams, inputting a stream or even access to this Management Interface.<br>Here, you can add your public keys (JWK) that will be used to validate the JWT's. You can also supply an url from which MistServer can download a key set (JWKS)."},$("<h3>").text("Keys"),!Se||typeof Se[0]=="string"?{label:"Url(s) to JSON web key set (JWKS)",help:"Enter one or more urls where MistServer can download a JSON web key set.",pointer:{main:a,index:"urls"},type:"inputlist",validate:Se?["required"]:[],input:{type:"str",validate:[function(e){if(e=="")return;function t(e){let t;try{t=new URL(e)}catch(e){return false}return t.protocol==="http:"||t.protocol==="https:"}if(!t(e)){return{msg:"Please enter a valid url.",classes:["red"]}}}]}}:false,!Se?{type:"help",help:"- and / or -",css:{margin:"1em 0"}}:false,!Se||typeof Se[0]!="string"?{type:"span",label:"JSON web key (set)",value:$("<button>").attr("data-icon","up").text("Upload JWKS file").css({fontSize:"1.25em",marginLeft:0}).click(function(){let e=$(this);let t=$(this).closest(".input_container")?.find('.field[name="keys"]');let a=e.parent().data("help_container");let i=e.parent().data("uid");if(a){a.find(".err_balloon[data-uid='"+i+"']")?.remove()}function s(t){console.warn(t);var s="Upload failed";if(t.name=="AbortError"){s="Upload aborted"}e.attr("data-icon","cross").text(s);if(a){let e=$("<span>").addClass("err_balloon").addClass("orange").attr("data-uid",i).html(t);a.prepend(e)}setTimeout(function(){e.attr("data-icon","up").text("Upload JWKS file")},5e3)}UI.upload({description:"JWKS files",accept:{"*/json":[".jwk",".jwks",".json"]}}).then(function(e){e.text().then(function(a){try{let n=JSON.parse(a);let r=t.getval();let o=false;function i(e){if("kty"in e&&"alg"in e){r.push(JSON.stringify(e,null,2));o=true}}if("keys"in n){for(let l in n.keys){i(n.keys[l])}}else if(Array.isArray(n)){for(let d in n){i(n[d])}}else{i(n)}if(!o)throw"Could not find any keys in this file ("+e.name+")";t.setval(r)}catch(c){s(c)}})}).catch(s)}),help:"Upload a JWKS file from your computer."}:false,!Se||typeof Se[0]!="string"?{type:"inputlist",pointer:{main:a,index:"keys"},help:"Enter a JWK or a JWKS: a json object or array of objects.",validate:Se?["required"]:[],input:{type:"textarea",placeholder:JSON.stringify({alg:"youralg",kid:"youruuid",kty:"oct",k:42},null,2),rows:6,validate:[function(e,t){let a=1+$(t).closest(".listitem").index();if(e==""){return}let i;try{i=JSON.parse(e)}catch(e){}if(!i){return{msg:"Field "+a+": Invalid json.",classes:["red"]}}if(i===null||typeof i!="object"){return{msg:"Field "+a+": Please enter a JSON object or array of objects.",classes:["red"]}}if(Array.isArray(i)){for(let e of i){if(!("kty"in e)){return{msg:"Field "+a+": All keys should contain the 'kty' index.",classes:["red"]}}}}else if(!("kty"in i)){return{msg:"Field "+a+": All keys should contain the 'kty' index.",classes:["red"]}}}]}}:false,$("<h3>").text("Grant permissions"),{label:"Use keys to permit viewing",type:"checkbox",pointer:{main:a.permissions,index:"output"},help:"When a valid JWT - signed with one of these keys - is provided, access should be granted to view the stream.",value:true},{label:"Use keys to permit stream input",type:"checkbox",pointer:{main:a.permissions,index:"input"},help:"When a valid JWT - signed with one of these keys - is provided, access should be granted to input the stream.",value:true},{label:"Apply to",type:"selectinput",pointer:{main:a.permissions,index:"stream"},help:"The keys listed above should only grant access to the streams configured here.<br>You may use STREAMNAME+* to include all wildcard children.",selectinput:[["*","All streams"],[{type:"inputlist"},"These stream names .."]]},{label:"API authentication",type:"checkbox",pointer:{main:a.permissions,index:"admin"},help:"When a valid JWT - signed with one of these keys - is provided, access should be granted to the MistServer Management Interface and API."},{type:"buttons",buttons:[{type:"save",label:Se?"Save":"Add",icon:Se?"check":"plus",function:function(e){for(let e in a.keys){a.keys[e]=JSON.parse(a.keys[e])}let t=a.urls.concat(a.keys);if(t.length==0){let t=$(e).closest(".input_container").find(".field[name]");t.each(function(){let e=$(this).data("validate_functions");e.push(function(e,t){if(e.length==0){return{msg:"Please enter something in one of these fields.",classes:["orange"]}}});$(this).data("validate_functions",e);$(this).data("validate")(this,true);e.pop();$(this).data("validate_functions",e)});return}let i={addjwks:[]};for(let e in t){i.addjwks.push([t[e],a.permissions])}if(Se){i.deletejwks=typeof Se[0]=="string"?Se[0]:Se[0].kid?Se[0].kid:Se[0]}mist.send(function(e){UI.navto("General")},i)}},{type:"cancel",label:"Return",function:function(){UI.navto("General")}}]}]))}break}case"Protocols":if(typeof mist.data.capabilities=="undefined"){mist.send(function(t){UI.navto(e)},{capabilities:true});i.append("Loading..");return}var P=$("<tbody>");i.append(UI.buildUI([{type:"help",help:"You can find an overview of all the protocols and their relevant information here. You can add, edit or delete protocols."}])).append($("<button>").text("Delete all protocols").click(function(){if(confirm("Are you sure you want to delete all currently configured protocols?")){mist.data.config.protocols=[];mist.send(function(e){UI.navto("Protocols")},{config:mist.data.config})}})).append($("<button>").text("Enable default protocols").click(function(){var e=Object.keys(mist.data.capabilities.connectors);for(var t in mist.data.config.protocols){var a=mist.data.config.protocols[t];var i=e.indexOf(a.connector);if(i>-1){e.splice(i,1)}}var s=[];for(var t in e){var n=mist.data.capabilities.connectors[e[t]];if("PUSHONLY"in n||"NODEFAULT"in n){continue}if(!("required"in n)||Object.keys(n.required).length==0){s.push(e[t])}}var r="Click OK to enable disabled protocols with their default settings:"+"\n  ";if(s.length){r+=s.join(", ")}else{r+="None."}if(s.length!=e.length){var o=e.filter(function(e){return s.indexOf(e)<0});r+="\n\n"+"The following protocols can only be set manually:"+"\n  "+o.join(", ")}if(confirm(r)&&s.length){if(mist.data.config.protocols===null){mist.data.config.protocols=[]}for(var t in s){mist.data.config.protocols.push({connector:s[t]})}mist.send(function(e){UI.navto("Protocols")},{config:mist.data.config})}})).append("<br>").append($("<button>").text("New protocol").click(function(){UI.navto("Edit Protocol")}).css("clear","both")).append($("<table>").html($("<thead>").addClass("sticky").html($("<tr>").html($("<th>").text("Protocol")).append($("<th>").text("Status")).append($("<th>").text("Settings")).append($("<th>")))).append(P));function A(){function e(e){var t=mist.data.capabilities.connectors[e.connector];if(!t){return""}var a=[];var i=["required","optional"];for(var s in i){for(var n in t[i[s]]){if(e[n]&&e[n]!=""){a.push(n+": "+e[n])}else if(t[i[s]][n]["default"]){a.push(n+": "+t[i[s]][n]["default"])}}}return $("<span>").addClass("description").text(a.join(", "))}P.html("");for(var t in mist.data.config.protocols){var a=mist.data.config.protocols[t];var i=mist.data.capabilities.connectors[a.connector];P.append($("<tr>").data("index",t).append($("<td>").text(i&&i.friendly?i.friendly:a.connector)).append($("<td>").html(UI.format.status(a))).append($("<td>").html(e(a))).append($("<td>").css("text-align","right").html($("<button>").text("Edit").click(function(){UI.navto("Edit Protocol",$(this).closest("tr").data("index"))})).append($("<button>").text("Delete").click(function(){var e=$(this).closest("tr").data("index");if(confirm('Are you sure you want to delete the protocol "'+mist.data.config.protocols[e].connector+'"?')){mist.send(function(e){UI.navto("Protocols")},{deleteprotocol:mist.data.config.protocols[e]});mist.data.config.protocols.splice(e,1)}}))))}}A();UI.interval.set(function(){mist.send(function(){A()})},1e4);break;case"Edit Protocol":if(typeof mist.data.capabilities=="undefined"){mist.send(function(a){UI.navto(e,t)},{capabilities:true});i.append("Loading..");return}var S=false;if(t!=""&&t>=0){S=true}var O={};for(var b in mist.data.config.protocols){O[mist.data.config.protocols[b].connector]=1}function E(e){var t=mist.data.capabilities.connectors[e];var a=mist.convertBuildOptions(t,L);if(S){var i=$.extend({},L)}a.push({type:"hidden",pointer:{main:L,index:"connector"},value:e});a.push({type:"buttons",buttons:[{type:"save",label:"Save",function:function(){var e={};if(S){e.updateprotocol=[i,L]}else{e.addprotocol=L}mist.send(function(e){UI.navto("Protocols")},e)}},{type:"cancel",label:"Cancel",function:function(){UI.navto("Protocols")}}]});if("deps"in t&&t.deps!=""){v=$("<span>").text("Dependencies:");$ul=$("<ul>");v.append($ul);if(typeof t.deps=="string"){t.deps=t.deps.split(", ")}for(var s in t.deps){var n=$("<li>").text(t.deps[s]+" ");$ul.append(n);if(typeof O[t.deps[s]]!="undefined"||typeof O[t.deps[s]+".exe"]!="undefined"){n.append($("<span>").addClass("green").text("(Configured)"))}else{n.append($("<span>").addClass("red").text("(Not yet configured)"))}}a.unshift({type:"text",text:v[0].innerHTML})}return UI.buildUI(a)}var O={};for(var b in mist.data.config.protocols){O[mist.data.config.protocols[b].connector]=1}if(!S){i.html($("<h2>").text("New Protocol"));var L={};var j=[["",""]];for(var b in mist.data.capabilities.connectors){j.push([b,mist.data.capabilities.connectors[b].friendly?mist.data.capabilities.connectors[b].friendly:b])}var N=$("<span>");i.append(UI.buildUI([{label:"Protocol",type:"select",select:j,function:function(){if($(this).getval()==""){return}N.html(E($(this).getval()))}}])).append(N)}else{var R=mist.data.config.protocols[t];var L=R;i.find("h2").append(' "'+R.connector+'"');i.append(E(R.connector))}break;case"Streams":{if(!("capabilities"in mist.data)){i.html("Loading..");mist.send(function(){UI.navto(e,t)},{capabilities:true,streamkeys:true});return}var D=mist.stored.get();var H={by:"name",dir:1};var F;if(t==""){if("viewmode"in D){t=D.viewmode}}if("sortstreams"in D){H=D.sortstreams}if("streams_pagesize"in D){F=D.streams_pagesize}var W;var J=UI.buildUI([{type:"help",help:"This is an overview of the streams you've currently configured.<br>You can left click a stream to "+(t=="thumbnails"?"edit":"preview")+" it"+(t=="thumbnails"?", or its thumbnail to preview it":"")+". You can right click a stream for an action menu."},$("<div>").css({width:"45.25em",display:"flex","justify-content":"flex-end"}).append($("<button>").text("Switch to "+(t=="thumbnails"?"list":"thumbnail")+" view").click(function(){mist.stored.set("viewmode",t=="thumbnails"?"list":"thumbnails");UI.navto("Streams",t=="thumbnails"?"list":"thumbnails")})).append($("<button>").attr("data-icon","key").text("Manage stream keys").click(function(){UI.navto("Stream keys")})).append($("<button>").attr("data-icon","plus").text("Create a new stream").click(function(){UI.navto("Edit")})),{label:"Filter streams",classes:["filter"],help:"Stream names that do not contain the text you enter here will be hidden.",function:function(e){var t=$(this).getval();if(W)W.filter(t)},css:{"margin-top":"3em"}}]);i.append(J);var B=$.extend({},mist.data.streams);var V=new UI.context_menu;if(t=="thumbnails"){W=UI.dynamic({create:function(){var e=document.createElement("div");e.className="streams thumbnails";UI.sortableItems(e,function(e){return this.sortValues[e]},{});return e},values:B,add:{create:function(e){var t=document.createElement("div");t.className="stream";t.setAttribute("data-id",e);var a=["thumbnail","actions"];t.elements={};t.elements.header=document.createElement("a");t.elements.header.className="header";t.appendChild(t.elements.header);for(var i in a){var s=a[i];t.elements[s]=document.createElement("div");t.elements[s].className=s;t.elements[s].raw=false;t.appendChild(t.elements[s])}if(e.indexOf("+")>=0){t.setAttribute("data-iswildcardstream","yes");var n=document.createElement("span");n.className="wildparent";var r=e.split("+");n.appendChild(document.createTextNode(r.shift()+"+"));t.elements.header.appendChild(n);t.elements.header.appendChild(document.createTextNode(r.join("+")))}else{t.setAttribute("data-iswildcardstream","no");t.elements.header.innerText=e}t.elements.header.addEventListener("click",function(){UI.navto("Edit",e)});t.elements.thumbnail.addEventListener("click",function(){if(B[e].isfolderstream){if(!B[e].filesfound){UI.findFolderSubstreams(B[e],function(a){$.extend(B,a);W.update(B);B[e].filesfound=true;t.setAttribute("data-showingsubstreams","yes");t.setAttribute("title","This is a folder stream: it points to a folder with media files inside.")})}else{UI.navto("Edit",e)}}else{UI.navto("Preview",e)}});t.elements.actions.appendChild($("<button>").text("Actions").click(function(t){var a=$(this).offset();V.fill(e,{pageX:a.left,pageY:a.top});t.stopPropagation()})[0]);t.insertBefore(UI.modules.stream.status(e,{thumbnail:false,tags:"readonly"})[0],t.children[1]);t.remove=function(){if(this.parentNode){this.parentNode.removeChild(this)}};t.addEventListener("contextmenu",function(t){t.preventDefault();V.fill(e,t)});return t},update:function(e){if(e.online==1&&e.online!=this.elements.thumbnail.raw){var t=UI.modules.stream.thumbnail(e.name,{clone:true});this.elements.thumbnail.appendChild(t[0]);this.elements.thumbnail.raw=e.online}if(e.source!==this.raw_source){if(e.source===null){this.elements.header.classList.add("wildparent");this.setAttribute("title","This stream has no configuration and will disappear once it goes offline.")}else{if(this.raw_src===null){this.classList.remove("wildparent")}this.raw_source=e.source;var a=UI.findInput("Folder");this.setAttribute("title",e.source);if(a){if(mist.inputMatch(a.source_match,e.source)){this.setAttribute("data-isfolderstream","yes");e.isfolderstream=true;this.setAttribute("title","This is a folder stream: it points to a folder with media files inside. Click to request its sub streams.")}else{this.setAttribute("data-isfolderstream","no");this.setAttribute("title",e.source);e.isfolderstream=false}}}}var i=[0,1,2,3,5,4,0];this.sortValues={name:e.name,state:e.stats&&e.stats.length>=2?i.length>e.stats[1]?i[e.stats[1]]:0:0,viewers:e.stats&&e.stats.length>=3?e.stats[2]:0,inputs:e.stats&&e.stats.length>=4?e.stats[3]:0,outputs:e.stats&&e.stats.length>=5?e.stats[4]:0}}},update:function(){this.sort();if(this.show_page)this.show_page()}});i.append(W);var Y=H.by;var q={name:1,viewers:-1,state:-1,inputs:-1,outputs:-1};var G=q[Y]*H.dir;J.append(UI.buildUI([{label:"Sort streams by",help:"Choose by which attribute the streams listed below should be sorted",type:"select",select:[["name","Stream name"],["state","State (Online, offline, waiting etc.)"],["viewers","Viewers"],["inputs","Inputs"],["outputs","Outputs"]],value:H.by,function:function(e){Y=$(this).getval();H.by=Y;mist.stored.set("sortstreams",H);if(W)W.sort(Y,q[Y]*G)},unit:$("<label>").append($("<input>").attr("type","checkbox").prop("checked",G==-1).change(function(){G=$(this).is(":checked")?-1:1;H.dir=G*q[Y];mist.stored.set("sortstreams",H);if(W)W.sort(Y,q[Y]*G)})).append($("<span>").text("Reverse"))}]).children())}else{var z=$("<table>").addClass("streams");i.append(z);z.layout={name:function(e,t){if(t!=this.raw){this.raw=t;var a=this;var i=$("<a>").addClass("clickable").text(e.name).click(function(){if($(a).attr("data-iswildcard")=="no"&&$(a).attr("data-isfolderstream")=="yes"){UI.navto("Edit",t)}else{UI.navto("Preview",t)}});if(t.indexOf("+")>=0){var s=t.split("+");var n=s.shift();var r=s.join("+");$(this).attr("data-iswildcard",n+"+");i.attr("title","This is a wildcard stream: its config is inherited from its parent: '"+n+"'.").html($("<span>").addClass("wildparent").text(n+"+")).append(r)}else{$(this).attr("data-iswildcard","no")}$(this).html(i)}if(e.source!==this.raw_src){if(e.source===null){$(this).addClass("wildparent");$(this).find("a").attr("title","This stream has no configuration and will disappear once it goes offline.")}else if(this.raw_src===null){$(this).removeClass("wildparent");$(this).find("a").attr("title",t.indexOf("+")>=0?"This is a wildcard stream: its config is inherited from its parent: '"+n+"'.":false)}this.raw_src=e.source;if(mist.data.capabilities){var o=UI.findInput("Folder");if(o){if(mist.inputMatch(o.source_match,e.source)){$(this).attr("data-isfolderstream","yes").attr("title","This is a folder stream: it points to a folder with media files inside. Click the '' to request its sub streams.");e.isfolderstream=true}else{$(this).attr("data-isfolderstream","no").attr("title",e.source);e.isfolderstream=false}}}}},actions:function(e,t){if(this.raw)return;$(this).html($("<button>").text("Actions").click(function(e){var a=$(this).offset();V.fill(t,{pageX:a.left,pageY:a.top});e.stopPropagation()}));this.raw=true},state:function(e){var t=$("<div>").attr("data-streamstatus",0).text("Inactive");if("stats"in e){if(this.raw==e.stats[1]){return}var a=["Inactive","Initializing","Booting","Waiting for data","Available","Shutting down","Invalid state"];t=$("<div>").attr("data-streamstatus",e.stats[1]).text(a[e.stats[1]]);this.raw=e.stats[1]}$(this).html(t).addClass("activestream")},tags:function(e){this.update(e)},viewers:function(e){var t="";if("stats"in e){if(this.raw==e.stats[2]){return}t=e.stats[2];this.raw=e.stats[2];if(t==0)t=""}$(this).html(t)},inputs:function(e){var t="";if("stats"in e){if(this.raw==e.stats[3]){return}t=e.stats[3];this.raw=e.stats[3];if(t==0)t=""}$(this).html(t)},outputs:function(e){var t="";if("stats"in e){if(this.raw==e.stats[4]){return}t=e.stats[4];this.raw=e.stats[4];if(t==0)t=""}$(this).html(t)}};var X=$("<tr>").attr("data-sortby","name");z.append($("<thead>").addClass("sticky").append(X));var K={name:"Stream name",actions:""};for(var b in z.layout){var Z=b in K?K[b]:UI.format.capital(b);var Q=$("<th>").text(Z);if(Z!=""){Q.attr("data-index",b)}X.append(Q)}W=UI.dynamic({create:function(){var e=document.createElement("tbody");UI.sortableItems(e,function(e){return this._cells[e].raw},{controls:X[0],sortsave:"sortstreams"});e.remove=function(){if(this.parentNode){this.parentNode.removeChild(this)}};return e},values:B,add:{create:function(e){var t=document.createElement("tr");t.setAttribute("data-id",e);t._cells={};for(var a in z.layout){var i=document.createElement("td");i.setAttribute("data-index",a);t._cells[a]=i;t.append(i)}var s=t._cells.tags;t._cells.tags=UI.modules.stream.tags({streamname:e,context_menu:V,onclick:function(e,t){if(this.getAttribute("data-type")>0){var a=J.find(".field.filter");if(a.getval()=="#"+t){var i=a.data("lastval");a.setval(i?i:"")}else{a.data("lastval",a.getval());a.setval("#"+t)}}},getStreamstatus:function(){return this.closest("tr").querySelector("[data-streamstatus]").getAttribute("data-streamstatus")}});s.appendChild(t._cells.tags);t.addEventListener("contextmenu",function(t){t.preventDefault();V.fill(e,t)});t.addEventListener("click",function(a){if(B[e].isfolderstream){if("filesfound"in B[e]){return}else{UI.findFolderSubstreams(B[e],function(e){$.extend(B,e);W.update(B);t.setAttribute("data-showingsubstreams","")})}W.show_page(this)}});t.remove=function(){if(this.parentNode){this.parentNode.removeChild(this)}};return t},update:function(e,t){for(var a in z.layout){z.layout[a].call(this._cells[a],e,this._id)}}},update:function(){this.sort();if(this.show_page)this.show_page()}});z.append(W)}W.filter=function(e){if(e[0]=="#"){e=e.slice(1);for(var t=0;t<this.children.length;t++){var a=this.children[t];if(e in a._cells.tags.values&&a._cells.tags.values[e]>0){a.classList.remove("hidden")}else{a.classList.add("hidden")}}}else{e=e.toLowerCase();for(var t=0;t<this.children.length;t++){var a=this.children[t];if(a.getAttribute("data-id").toLowerCase().indexOf(e)>=0){a.classList.remove("hidden")}else{a.classList.add("hidden")}}}W.show_page()};i.append(V.ele);V.fill=function(e,t){let a=B[e];function i(e){if(a.source===null){return'<span class="wildparent">'+e+'</span><div class="description">Unconfigured</div>'}if(e.indexOf("+")>=0){let t=e.split("+");return'<span class="wildparent">'+t[0]+"+</span>"+t.slice(1).join("+")}return e}var s=[$("<div>").addClass("header").html(i(e))];var n=[[$("<span>").html("Edit "+(e.indexOf("+")<0?"stream":"<b>"+e.split("+")[0]+"</b>")),function(){UI.navto("Edit",e)},"Edit","Change the settings of this stream."],["Stream status",function(){UI.navto("Status",e)},"Status","See more details about the status of this stream."],["Preview stream",function(){UI.navto("Preview",e)},"Preview","Watch the stream."],["Embed stream",function(){UI.navto("Embed",e)},"Embed","Get urls to this stream or get code to embed it on your website."]];var r=[["Delete stream",function(){if(confirm('Are you sure you want to delete the stream "'+e+'"?')){delete mist.data.streams[e];mist.send(function(t){delete B[e];W.update(B)},{deletestream:[e]})}},"trash","Remove this stream's settings."],["Stop sessions",function(){if(confirm("Are you sure you want to disconnect all sessions (viewers, pushes and possibly the input) for the stream '"+e+"'?")){mist.send(function(){},{stop_sessions:e})}},"stop","Disconnect sessions for this stream. Disconnecting a session will kill any currently open connections (viewers, pushes and possibly the input). If the USER_NEW trigger is in use, it will be triggered again by any reconnecting connections."],["Invalidate sessions",function(){if(confirm("Are you sure you want to invalidate all sessions for the stream '"+e+"'?\nThis will re-trigger the USER_NEW trigger.")){mist.send(function(){},{invalidate_sessions:e})}},"invalidate","Invalidate all the currently active sessions for this stream. This has the effect of re-triggering the USER_NEW trigger, allowing you to selectively close some of the existing connections after they have been previously allowed. If you don't have a USER_NEW trigger configured, this will not have any effect."],["Nuke stream",function(){if(confirm("Are you sure you want to completely shut down the stream '"+e+"'?\nAll viewers will be disconnected.")){mist.send(function(){},{nuke_stream:e})}},"nuke","Shut down a running stream completely and/or clean up any potentially left over stream data in memory. It attempts a clean shutdown of the running stream first, followed by a forced shut down, and then follows up by checking for left over data in memory and cleaning that up if any is found."]];if(a.source===null){n.shift();n.unshift([$("<span>").html("Create <b>"+e.split("+")[0]+"</b>"),function(){UI.navto("Edit",e)},"Edit","Create this stream."]);r.shift()}if(a.isfolderstream){n.pop();n.pop();r=[r[0]]}var o=[s];if(B[e].isfolderstream&&!B[e].filesfound){o.push([["Scan folder for sub streams",function(){UI.findFolderSubstreams(B[e],function(e){$.extend(B,e);W.update(B)})},"folder"]])}o.push(n);o.push(r);if(B[e].online==1){o.push($("<aside>").append(UI.modules.stream.thumbnail(e)))}V.show(o,t);V.ele.find("[tabindex]").first().focus()};UI.sockets.ws.active_streams.subscribe(function(e,t){if(e!="stream")return;var a=t[0];var i=a.split("+")[0];if(i in mist.data.streams){if(i!=a){if(!(a in B)){B[a]=$.extend({},mist.data.streams[i]);B[a].name=a;if(B[i].isfolderstream){B[a].source+=a.replace(i+"+")}}else if(t.slice(1).every(e=>!e)){delete B[a];W.update(B);return}}B[a].stats=t;W.update(B)}else if(a in B){B[a].stats=t;W.update(B)}else{if(a){B[a]={name:a,source:null,stats:t};W.update(B)}else{console.log("Received information about unknown stream",a,t)}}});var ee=UI.pagecontrol(W,F);i.append(ee);ee.elements.pagelength.change(function(){mist.stored.set("streams_pagesize",$(this).val())});break}case"Edit":{i.append("Loading..");mist.send(function(a){var s=false;if(t!=""){s=true}if(!s){i.html($("<h2>").text("New Stream"));var n={}}else{var r=t.split("+")[0];var n;if(r in mist.data.streams){n=$.extend({},mist.data.streams[r])}else{n={name:r,source:"push://"};if(UI.findStreamKeys(t).length){n.source+="invalid,host"}}i.html(UI.modules.stream.header(t,e,r));if(r!=t){i.append($("<div>").addClass("err_balloon").addClass("orange").css({position:"static",width:"54.65em",margin:"2em 0 3em"}).html("Note:<br>You are editing the settings of <b>"+r+"</b>, which is the parent of wildcard stream <b>"+t+"</b>. This will also affect other children of <b>"+r+"</b>."))}}n.streamkeys=UI.findStreamKeys(t.split("+")[0]);if(n.source&&n.source.slice(0,7)=="push://"){if(n.source.match(/push:\/\/[^:@\/]*/)?.[0]=="push://invalid,host"){n.streamkey_only=true;n.source=n.source.replace("push://invalid,host","push://")}}var o=[];var l=$("<datalist>").attr("id","source_datalist");var d={};var c=$("<div>").addClass("source_info");var p=false;var u=false;function f(e){let t="source_prefill"in e?e.source_prefill:[];if(typeof t=="string"){t=[t]}for(var a in t){if(!(t[a]in d)){d[t[a]]=[];l.append($("<option>").val(t[a]))}d[t[a]].push(e)}let i=e.name.toLowerCase()+":";if(!(i in d))d[i]=[e]}for(var m in mist.data.capabilities.inputs){for(var v in mist.data.capabilities.inputs[m].source_match){o.push(mist.data.capabilities.inputs[m].source_match[v])}f(mist.data.capabilities.inputs[m])}Object.defineProperty(d,"prefills",{value:Object.keys(d).sort((e,t)=>{t.length-e.length})});let b=$("<div>").text("source_help");function g(e,t){b.html($("<p>").html("Where MistServer can find the media data.<br>This help text will update as you type to provide more details.")).append($("<h3>").text("Video on Demand (VoD)")).append($("<p>").text("Please enter the path to your media file. This can be a file on your server (Use the 'browse'-button) or somewhere on the internet (enter the url).")).append($("<h3>").text("Live streaming")).append($("<h4>").text("Pulling from a device or server")).append($("<p>").html("If MistServer should pull the stream from somewhere - for example an IP camera - enter the protocol and address where it can be reached. This should be provided to you by the device or server.<br>For example: <b>rtsp://[user]:[password]@[hostname]</b>")).append($("<h4>").text("Pushing into MistServer")).append($("<p>").html("To set up MistServer to receive stream data from another application or server, enter <b>push://</b> and follow the instructions from there."));var a=UI.findInputBySource(e)?.index;let i={};for(let s of d.prefills){if(e.startsWith(s)){let n=d[s];for(let e of n){if(a&&e.name==a){}let t="source_syntax"in e?e.source_syntax:[];if(typeof t=="string")t=[t];if(t.filter(t=>t.startsWith(e.name.toLowerCase()+":")).length==0){t.push(e.name.toLowerCase()+":[address]")}for(h of t){if(h.startsWith(s)){if(a&&e.name==a){i["_match"+h]=[e.name]}else{if(!(h in i))i[h]=[];i[h].push(e.name)}}}}b.html($("<p>").text("Where MistServer can find the media data."));if(Object.keys(i).length){let a=$("<ul>").addClass("syntaxes");b.append(a);for(let s in i){let n=s;let r=s.slice(0,6)=="_match";if(r){s=s.slice(6)}let o=$("<span>");let l=s.replace(/\//g,"\\/").replace(/\[.*?\]/g,function(e){if(e[1].match(/[a-zA-Z0-9]/)===null)return"(\\"+e[1]+".*?)?";return"(.*?)?"})+"$";let d=e.substring(0,t)+""+e.substring(t);let c=d.match(l);let p=s;if(c!==null&&c.length>1&&typeof c[1]!="undefined"){for(let e=1;e<c.length;e++){if(c[e].includes("")){let t=0;p=p.replace(/(\[.*?\])/g,function(a){t++;if(t==e)return"<b>"+a+"</b>";else return a});break}}}o.html(p);let u=[];for(let e of i[n]){let t=e in mist.data.capabilities.inputs?mist.data.capabilities.inputs[e]:e+".exe"in mist.data.capabilities.inputs?mist.data.capabilities.inputs[e+".exe"]:null;if(!t)return;u.push("source_name"in t?t.source_name:e)}if(u.length>=2){let e=u.splice(-2);u.push(e.join(" or "))}let f=$("<div>").addClass("description");let h=$("<li>").html($("<div>").text(r?"Matched input type: ":"Input type: ").append($("<h4>").css("display","inline").text(u.join(", ")))).append($("<div>").text("Syntax: ").append(o)).append(f);if(r){a.prepend(h.attr("data-icon","check"))}else{a.append(h)}let m=[];for(let e of i[n]){let t=e in mist.data.capabilities.inputs?mist.data.capabilities.inputs[e]:e+".exe"in mist.data.capabilities.inputs?mist.data.capabilities.inputs[e+".exe"]:null;if(!t)return;let a=t.desc;if("source_help"in t)a=t.source_help;if(typeof a=="object"){if(s in a){a=a[s]}else if("default"in a){a=a["default"]}else{a=t.desc}}if(!m.includes(a))m.push(a)}for(let e of m){f.append($("<div>").css("white-space","pre-line").text(e))}}}break}}return a?a:null}var y=$("<div>");function x(e){var a={};if(!mist.data.streams){mist.data.streams={}}mist.data.streams[n.name]=n;if(n.source===null)n.source="";a.addstream={};a.addstream[n.name]=n;if(t!=n.name){delete mist.data.streams[t];a.deletestream=[t]}if(n.stop_sessions&&t!=""){a.stop_sessions=t;delete n.stop_sessions}if(n.source.slice(0,7)=="push://"){a.streamkey_del=[];a.streamkey_add={};let e=UI.findStreamKeys(t.split("+")[0]);for(let t of e){if(n.streamkeys.indexOf(t)<0){a.streamkey_del.push(t)}}for(let e of n.streamkeys){if(!mist.data.streamkeys||!(e in mist.data.streamkeys)||mist.data.streamkeys[e]!=n.name){a.streamkey_add[e]=n.name}}if(n.streamkey_only){n.source=n.source.replace(/push:\/\/[^:@\/]*/,"push://invalid,host")}else{n.source=n.source.replace("push://invalid,host","push://")}}var i=null;for(var s in mist.data.capabilities.inputs){if(typeof mist.data.capabilities.inputs[s].source_match=="undefined"){continue}if(mist.inputMatch(mist.data.capabilities.inputs[s].source_match,n.source)){i=s;break}}if(i){var r=mist.data.capabilities.inputs[i];for(var s in n){if(s=="name"||s=="source"||s=="stop_sessions"||s=="processes"||s=="tags"){continue}if("optional"in r&&s in r.optional){continue}if("required"in r&&s in r.required){continue}if(s=="always_on"&&"always_match"in r&&mist.inputMatch(r.always_match,n.source)){continue}delete n[s]}}mist.send(function(){delete mist.data.streams[n.name].online;delete mist.data.streams[n.name].error;UI.navto(e,e=="Preview"?t.indexOf("+")<0?n.name:t:"")},a)}var w=$("<style>").text("button.saveandpreview { display: none; }");var k=$("<span>").addClass("ih_balloon");var _=$("<div>");var I={};var U=[];var C=$("<div>");for(var m in mist.data.capabilities.processes){U.push([m,mist.data.capabilities.processes[m].hrn?mist.data.capabilities.processes[m].hrn:mist.data.capabilities.processes[m].name])}if(U.length){var S=[{label:"New process",type:"select",select:U,value:U[0][0],pointer:{main:I,index:"process"},function:function(){var e=$(this).getval();if(e!=null){var t=mist.data.capabilities.processes[e];var a=[$("<h4>").text(t.name+" Process options")];C.html(UI.buildUI(a.concat(mist.convertBuildOptions(t,I))))}}},C];_.append(UI.buildUI([$("<br>"),$("<h3>").text("Stream processes"),{label:"Stream processes",itemLabel:"stream process",type:"sublist",sublist:S,saveas:I,pointer:{main:n,index:"processes"}}]))}var T=UI.buildUI([{label:"Stream name",type:"str",validate:["required","streamname"],pointer:{main:n,index:"name"},help:"Set the name this stream will be recognised by for players and/or stream pushing."},{label:"Source",type:"browse",filetypes:o,pointer:{main:n,index:"source"},help:b,function:function(){var e=$(this).val();var a=$(this);w.remove();k.html("");let s=g(e,this.selectionStart);if(e==""){return}if(s===null){y.html($("<h3>").text("Unrecognized input").addClass("red")).append($("<span>").text("Please edit the stream source.").addClass("red"));c.html("");return}var r=mist.data.capabilities.inputs[s];var o=c.find("div");if(o.length){o.removeClass("active");o.filter('[data-source="'+e+'"]').addClass("active")}let l=$(this).closest(".input_container").find('.itemgroup [name="streamkeys"]').closest(".itemgroup");if(e.slice(0,7)=="push://"){l.show()}else{l.hide()}function d(e){var i=$.extend({},r);if(r.dynamic_capa){i.desc="Loading dynamic capabilities..";if(!("dynamic_capa_results"in r)||!(e in r.dynamic_capa_results)){u=e;if(p){return}p=setTimeout(function(){if(!("dynamic_capa_results"in r)){r.dynamic_capa_results={}}r.dynamic_capa_results[u]=null;mist.send(function(e){p=false;r.dynamic_capa_results[u]=e.capabilities;d(u)},{capabilities:u})},1e3)}else{delete i.desc;if(r.dynamic_capa_results[e]){i=r.dynamic_capa_results[e]}}}y.html($("<h3>").text("source_name"in r?"Input options for "+r.source_name.toLowerCase():r.name+" Input options"));var o=mist.convertBuildOptions(i,n);if("always_match"in r&&mist.inputMatch(r.always_match,e)){o.push({label:"Always on",type:"checkbox",help:"Keep this input available at all times, even when there are no active viewers.",pointer:{main:n,index:"always_on"},value:t==""&&(s=="TSSRT"||s=="TSRIST"||s=="RTSP"||s=="TS")?true:false})}y.append(UI.buildUI(o));c.html("");if(r.enum_static_prefix&&e.slice(0,r.enum_static_prefix.length)==r.enum_static_prefix){function l(){c.html($("<p>").text("Possible sources for "+r.name+": (click to set)"));var t=r.enumerated_sources[r.enum_static_prefix];for(var i in t){var s=t[i].split(" ")[0];c.append($("<div>").attr("data-source",s).text(t[i]).click(function(){var e=$(this).attr("data-source");a.val(e).trigger("change")}).addClass(s==e?"active":""))}}function f(){if(!("enumerated_sources"in r)||!(r.enum_static_prefix in r.enumerated_sources)){if(!("enumerated_sources"in r)){r.enumerated_sources={}}r.enumerated_sources[r.enum_static_prefix]=[];setTimeout(function(){delete r.enumerated_sources[r.enum_static_prefix]},1e4);mist.send(function(e){if(!("enumerated_sources"in r)){r.enumerated_sources={}}r.enumerated_sources[r.enum_static_prefix]=e.enumerate_sources;l()},{enumerate_sources:e})}else{l()}}f()}}if(r.name=="Folder"){if(t.indexOf("+")<0){i.append(w)}}let f=i.find("[name=name]").val();UI.updateLiveStreamHint(t.indexOf("+")>=0&&f==t.split("+")[0]?t:f,i.find("[name=streamkey_only]").getval()?i.find("[name=source]")?.val()?.replace(/push:\/\/[^:@\/]*/,"push://invalid,host"):i.find("[name=source]")?.val()?.replace("push://invalid,host","push://"),k,r,i.find("[name=streamkeys]").getval());d(e)}},l,c,{label:"Persistent tags",type:"inputlist",help:"You can configure persistent tags that are applied to this stream when it starts. You can use tags to associate configuration or behavior with multiple streams.<br><br>Note that tags are not applied retroactively - if your stream is already active when you edit this field, changes will not take effect until the stream restarts.",pointer:{main:n,index:"tags"},input:{type:"str",prefix:"#"},validate:[function(e,t){e=e.join("");if(e.indexOf(" ")>-1){return{msg:"Spaces are not allowed in tag names.",classes:["red"]}}if(e.indexOf("#")>-1){return{msg:"You don't need to prefix these values with a #.",classes:["orange"],break:false}}}]},{type:"group",label:"Permissions for stream input",options:[{label:"Require stream key",type:"checkbox",help:"Check this box to block pushes using the stream name instead of a stream key.",pointer:{main:n,index:"streamkey_only"},function:function(){i.find("[name=source]").trigger("change")}},{type:"help",help:"Stream keys are a method to bypass all security and allow an incoming push for the given stream. If a token that matches a stream is used it will be accepted."},{label:"Stream keys",type:"inputlist",pointer:{main:n,index:"streamkeys"},help:"You may enter one or more stream keys. When none are entered, you can only push into this stream using the stream name.",function:function(){let e=i.find("[name=name]").val();UI.updateLiveStreamHint(t.indexOf("+")>=0&&e==t.split("+")[0]?t:e,i.find("[name=streamkey_only]").getval()?i.find("[name=source]")?.val()?.replace(/push:\/\/[^:@\/]*/,"push://invalid,host"):i.find("[name=source]")?.val()?.replace("push://invalid,host","push://"),k,false,$(this).getval())},input:{type:"str",clipboard:true,maxlength:256,validate:[function(e,a){if(mist.data.streamkeys&&e in mist.data.streamkeys&&mist.data.streamkeys[e]!=t){return{msg:"The key '"+e+"' is already in use (for the stream '"+mist.data.streamkeys[e]+"'). Duplicates are not allowed.",classes:["red"]}}if(e.length&&!e.match(/^[0-9a-z]+$/i)){return{msg:"The key '"+e+"' contains special characters. We recommend not using these as some video streaming protocols do not accept them.",classes:["orange"],break:false}}}],unit:$("<button>").text("Generate").click(function(){let e=$(this).closest(".field_container").find(".field");function t(e){function t(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";return e[Math.floor(Math.random()*e.length)]}let a="";while(a.length<e){a+=t()}return a}function a(){e.setval(t(32));if(e.data("validate")(e)){a()}}a();e.trigger("keyup")})}},$("<div>").addClass("livestreamhint").html(function(){let e=t.split("+")[0];let a=$("<div>").addClass("description");let s=$("<span>");function n(){let t={};for(const a in mist.data.streamkeys){const i=mist.data.streamkeys[a];if(i.split("+")[0]==e){if(!(i in t)){t[i]=[]}t[i].push(a)}}delete t[e];s.text(Object.keys(t).length?"Additionally, a total of "+Object.values(t).map(function(e){return e.length}).reduce(function(e,t){return e+t})+" stream keys for "+Object.keys(t).length+' wildcards of "'+e+'" have been configured.':"You can also add stream keys for wildcard streams here:")}n();a.append(s).append($("<button>").css("float","right").attr("data-icon","key").text("Manage stream keys").click(function(){let t=UI.popup(UI.modules.streamkeys(e,function(){t.show(UI.modules.streamkeys(e,arguments.callee))}));t.element[0].addEventListener("close",function(){mist.send(function(){n();i.find('[name="streamkeys"]').setval(UI.findStreamKeys(e))},{streamkeys:true})})}));return a}())]},k,$("<br>"),{type:"custom",custom:y},_,{label:"Stop sessions",type:"checkbox",help:"When saving these stream settings, kill this stream's current connections.",pointer:{main:n,index:"stop_sessions"}},{type:"buttons",buttons:[{type:"cancel",label:"Cancel",function:function(){UI.navto("Streams")}},{type:"save",label:"Save",function:function(){x("Streams")}},{type:"save",label:"Save and Preview",function:function(){x("Preview")},classes:["saveandpreview"]}]}]);let M=T.find('.itemgroup [name="streamkeys"]').closest(".itemgroup");if(n.source&&n.source.slice(0,7)=="push://"){M.show()}else{M.hide()}i.append(T);T.change(function(){var e=i.find(".header");if(e.length){e.attr("data-changed","yes")}});i.find("[name=name]").keyup(function(){let e=$(this).val();UI.updateLiveStreamHint(t.indexOf("+")>=0&&e==t.split("+")[0]?t:e,i.find("[name=streamkey_only]").getval()?i.find("[name=source]")?.val()?.replace(/push:\/\/[^:@\/]*/,"push://invalid,host"):i.find("[name=source]")?.val()?.replace("push://invalid,host","push://"),k,false,i.find("[name=streamkeys]").getval())}).trigger("keyup");i.find('[name="source"]').attr("list","source_datalist")},{capabilities:true,streamkeys:true});break}case"Status":{if(t==""){UI.navto("Streams");return}var te=$("<div>").addClass("dashboard");i.html(UI.modules.stream.header(t,e)).append(te);var ae=UI.modules.stream.findMist(function(e,a){te.append(UI.modules.stream.status(t,{status:false,stats:false}));te.append(UI.modules.stream.metadata(t));te.append($("<section>").addClass("logcont").append(UI.modules.stream.logs(t)).append(UI.modules.stream.accesslogs(t)));te.append(UI.modules.stream.processes(t));te.append(UI.modules.stream.triggers(t,"Status"));te.append(UI.modules.stream.pushes(t))});te.append(ae);te.append(UI.modules.stream.actions("Status",t));te.append(UI.modules.stream.clients(t));break}case"Preview":{if(t==""){UI.navto("Streams");return}var te=$("<div>").addClass("dashboard");var ie=$("<div>").text("Loading..");i.html(UI.modules.stream.header(t,e)).append(ie).append(te);var ae=UI.modules.stream.findMist(function(e){if(typeof mistplayers=="undefined"){throw"Player.js was not applied properly."}ie.replaceWith(UI.modules.stream.status(t,{tags:false,thumbnail:false,status:false,stats:false}));window.mv={};$preview=UI.modules.stream.preview(t,window.mv);te.append($preview);te.append(UI.modules.stream.playercontrols(window.mv,$preview)).append(UI.modules.stream.logs(t)).append(UI.modules.stream.metadata(t))});te.append(ae);break}case"Embed":{if(t==""){UI.navto("Streams");return}i.html(UI.modules.stream.header(t,e));var se=$("<span>");i.append(UI.modules.stream.findMist(function(e){i.append(UI.modules.stream.embedurls(t,e,this.getUrls()))},false,true));break}case"Stream keys":{i.html($("<button>").attr("data-icon","Streams").css({width:"fit-content"}).text("Return to stream overview").click(function(){UI.navto("Streams")})).append(UI.modules.streamkeys());break}case"Push":i.html($("<h2>").text("Pushes and recordings")).append(UI.buildUI([{type:"help",help:"You can record streams to a file, or push streams to other servers, allowing them to broadcast your stream as well.<br>You can right click a push or stream name for actions."}])).append(UI.modules.pushes({push_settings:true,collapsible:true,filter:true}));break;case"Start Push":if(!("capabilities"in mist.data)||!("variable_list"in mist.data)||!("external_writer_list"in mist.data)){i.append("Loading MistServer capabilities..");mist.send(function(){UI.showTab("Start Push",t,a)},{capabilities:true,variable_list:true,external_writer_list:true});return}var ne;function re(s,n){var r=t.split("_");t=r[0];if(r.length>=2){n=r.slice(1).join("_")}if(typeof n!="undefined"&&typeof s=="undefined"){mist.send(function(e){if(n in e.auto_push){re(e.auto_push[n],n)}else{re()}},{push_auto_list:1});return}var o=[];var l=[];var d={};var c=[];for(var p in mist.data.capabilities.connectors){var u=mist.data.capabilities.connectors[p];if("push_urls"in u){d[p]=u.push_urls;for(var f in u.push_urls){if(u.push_urls[f][0]=="/"){o.push(u.push_urls[f])}else{l.push(u.push_urls[f])}}}}if(mist.data.external_writer_list){for(var p in mist.data.external_writer_list){var h=mist.data.external_writer_list[p];if(h.length>=3){for(var f in h[2]){c.push(h[2][f]+"://")}}}}if(mist.data.capabilities.internal_writers&&mist.data.capabilities.internal_writers.length){for(let e of mist.data.capabilities.internal_writers){c.push(e+"://")}}o.sort();l.sort();var m={params:{}};if(t=="auto"){i.find("h2").text("Add automatic push");m.enabled=true}var v=[];if(t=="auto"){m=Object.assign(m,{start_rule:[null,null,null],end_rule:[null,null,null]});if(typeof s!="undefined"){m=Object.assign(m,s);if(m.stream.indexOf("deactivated_")==0){m.enabled=false;m.stream=m.stream.slice(16)}var b=m.target.split("?");if(b.length>1){v=b.pop();m.target=b.join("?");v=v.split("&");for(var p in v){var g=v[p].split("=");m.params[g.shift()]=g.join("=")}}}}var y=$("<div>").css("margin","1em 0");var x=$("<div>");var w,k;if(t=="auto"){x.css("margin","1em 0").html(UI.buildUI([$("<h3>").text("Automatic push options"),{label:"This push should be active",help:"When 'based on server time' is selected, a start and/or end timestamp can be configured. When it's 'based on a variable', the push will be activated while the specified variable matches the specified value.",type:"select",select:[["time","Based on server time"],["variable","Based on a variable"]],value:m.start_rule[0]||m.end_rule[0]?"variable":"time",classes:["activewhen"],function:function(){var e=x.find(".varbased").closest(".UIelement");var t=x.find(".timebased").closest(".UIelement");if($(this).getval()=="time"){e.hide();t.css("display","")}else{t.hide();e.css("display","");x.find(".field.variableOperator").trigger("change")}}},$("<br>"),$("<span>").addClass("UIelement").append($("<h3>").text("Start the push").addClass("varbased")),{classes:["varbased"],label:"Use this variable",type:"str",help:"This variable should be used to determine if this push should be started.",prefix:"$",datalist:Object.keys(mist.data.variable_list||[]),pointer:{main:m.start_rule,index:0}},{classes:["varbased","variableOperator"],label:"Comparison operator",type:"select",select:[[0,"is true"],[1,"is false"],[2,"=="],[3,"!="],[10,">  (numerical)"],[11,">= (numerical)"],[12,"<  (numerical)"],[13,"<= (numerical)"],[20,">  (lexical)"],[21,">= (lexical)"],[22,"<  (lexical)"],[23,"<= (lexical)"]],value:2,css:{display:"none"},help:"How would you like to compare this variable?",pointer:{main:m.start_rule,index:1},function:function(){var e=x.find(".field.startVariableValue").closest(".UIelement");if(Number($(this).getval())<2){e.hide()}else{e.css("display","")}}},{classes:["varbased","startVariableValue"],label:"Variable value",type:"str",help:"The variable will be compared with this value to determine if this push should be started.<br>You can also enter another variable here!",datalist:Object.values(mist.data.variable_list||[]).map(function(e){return typeof e=="string"?e:e[3]}).concat(Object.keys(mist.data.variable_list||[]).map(function(e){return"$"+e})),pointer:{main:m.start_rule,index:2}},$("<span>").addClass("UIelement").append($("<h3>").text("Stop the push").addClass("varbased")),{classes:["varbased"],label:"Use this variable",type:"str",help:"This variable should be used to determine if this push should be stopped.<br>You can leave this field blank if you do not want to have a stop condition. (You can always stop the push manually)",prefix:"$",datalist:Object.keys(mist.data.variable_list||[]),pointer:{main:m.end_rule,index:0}},{classes:["varbased"],label:"Comparison operator",type:"select",select:[[0,"is true"],[1,"is false"],[2,"=="],[3,"!="],[10,">  (numerical)"],[11,">= (numerical)"],[12,"<  (numerical)"],[13,"<= (numerical)"],[20,">  (lexical)"],[21,">= (lexical)"],[22,"<  (lexical)"],[23,"<= (lexical)"]],value:2,help:"How would you like to compare this variable?",pointer:{main:m.end_rule,index:1},function:function(){var e=x.find(".field.endVariableValue").closest(".UIelement");if(Number($(this).getval())<2){e.hide()}else{e.css("display","")}}},{classes:["varbased","endVariableValue"],label:"Variable value",type:"str",help:"The variable will be compared with this value to determine if this push should be stopped.<br>You can also enter another variable here!",datalist:Object.values(mist.data.variable_list||[]).map(function(e){return typeof e=="string"?e:e[3]}).concat(Object.keys(mist.data.variable_list||[]).map(function(e){return"$"+e})),pointer:{main:m.end_rule,index:2}},{classes:["timebased"],type:"unix",label:"Start time",min:0,help:"The time where the push will become active. The default is to start immediately.",pointer:{main:m,index:"scheduletime"}},{classes:["timebased"],type:"unix",label:"End time",min:0,help:"The time where the push will stop. Defaults to never stop automatically.<br>Only makes sense for live streams.",pointer:{main:m,index:"completetime"}},{label:"Inhibitor",type:"inputlist",help:"Optional list of tags and/or stream names: if any of them identify the stream, this push will not start.",input:{type:"str",datalist:ne,validate:[function(e,t){if(e=="")return false;if(e[0]=="#"){return false}var a=e.split("+");a=a[0];if(a in mist.data.streams){return false}return{msg:"'"+a+"' is not a stream name.",classes:["orange"],break:false}}]},pointer:{main:m,index:"inhibit"}}],m));x.find(".activewhen").trigger("change")}var _=[{label:"Stream",type:"str",help:"This may either be a full stream name, a partial wildcard stream name, a full wildcard stream name, or a tag preceded by a # (e.g. #tag1).<br>For example, given the stream <i>a</i> you can use:              <ul>              <li><i>a</i>: the stream configured as <i>a</i></li>              <li><i>a+</i>: all streams configured as <i>a</i> with a wildcard behind it, but not <i>a</i> itself</li>              <li><i>a+b</i>: only the version of stream <i>a</i> that has wildcard <i>b</i></li>              </ul>",pointer:{main:m,index:"stream"},validate:["required",function(e,t){if(e[0]=="#"){return false}var a=e.split("+");a=a[0];if(a in mist.data.streams){return false}return{msg:"'"+a+"' is not a stream name.",classes:["orange"],break:false}}],datalist:ne,value:a[1]!=""?a[1]:""},{label:"Target",type:"str",help:"Where the stream will be pushed to.<br>              Valid push formats:              <ul>              <li>"+l.join("</li><li>")+"</li>              </ul>              Valid file formats:              <ul>              <li>"+o.join("</li><li>")+"</li>              </ul>              "+(c.length?"Additionally, the following protocols (from generic writers) may be used in combination with any of the above file formats:<ul><li>"+c.join("</li><li>")+"</li></ul>":"")+"              Valid text replacements:              <ul>              <li>$stream - inserts the stream name used to push to MistServer</li>              <li>$day - inserts the current day number</li><li>$month - inserts the current month number</li>              <li>$year - inserts the current year number</li><li>$hour - inserts the hour timestamp when stream was received</li>              <li>$minute - inserts the minute timestamp the stream was received</li>              <li>$seconds - inserts the seconds timestamp when the stream was received</li>              <li>$datetime - inserts $year.$month.$day.$hour.$minute.$seconds timestamp when the stream was received</li>              </ul>",pointer:{main:m,index:"target"},validate:["required",function(e,t){for(var a in l){if(mist.inputMatch(l[a],e)){return false}}for(var a in o){if(mist.inputMatch(o[a],e)){return false}for(var i in c){if(mist.inputMatch(c[i]+o[a].slice(1),e)){return false}}}return{msg:"Does not match a valid target.<br>Valid push formats:                  <ul>                  <li>"+l.join("</li><li>")+"</li>                  </ul>                  Valid file formats:                  <ul>                  <li>"+o.join("</li><li>")+"</li>                  </ul>                  "+(c.length?"Additionally, the following protocols may be used in combination with any of the above file formats:<ul><li>"+c.join("</li><li>")+"</li></ul>":""),classes:["red"]}}],function:function(){var e=false;var t=$(this).getval();for(connector in d){for(var a in d[connector]){if(mist.inputMatch(d[connector][a],t)){e=connector;break}if(d[connector][a][0]=="/"){for(var i in c){if(mist.inputMatch(c[i]+d[connector][a].slice(1),t)){e=connector;break}}}}}if($(this).data("last_match")==e){return}$(this).data("last_match",e);if(!e){y.html($("<h4>").addClass("red").text("Unrecognized target.")).append($("<span>").text("Please edit the push target."));return}if(!("friendly"in mist.data.capabilities.connectors[e])){mist.data.capabilities.connectors[e].friendly=mist.data.capabilities.connectors[e].name}y.html($("<h3>").text(mist.data.capabilities.connectors[e].friendly.replace("over HTTP","")));w=$.extend({},mist.data.capabilities.connectors[e].push_parameters);k={};function s(e,a){if(e.prot_only&&String().match&&t.match(/.+\:\/\/.+/)===null){delete w[a];return}if(e.file_only&&t[0]!="/"){delete w[a];return}if(e.type=="group"){for(var i in e.options){s(e.options[i],i)}}else{k[a]=e}}for(var a in mist.data.capabilities.connectors[e].push_parameters){s(mist.data.capabilities.connectors[e].push_parameters[a],a)}var n={desc:mist.data.capabilities.connectors[e].desc.replace("over HTTP",""),optional:w,sort:"sort"};var r=mist.convertBuildOptions(n,m.params);if(r[1].is("h4"))r.splice(1,1);var o=[];for(var a in v){var l=v[a].split("=");var p=l[0];if(!(p in k)){o.push(p+(l.length>1?"="+l.slice(1).join("="):""))}}r.push($("<br>"));r.push({type:"inputlist",label:"Custom url parameters",value:o,classes:["custom_url_parameters"],input:{type:"str",placeholder:"name=value",prefix:""},help:"Any custom url parameters not covered by the parameters configurable above.",pointer:{main:m,index:"custom_url_params"}});y.append(UI.buildUI(r))}},t=="auto"?{label:"Enabled",type:"checkbox",help:"When an automatic push is disabled, it will not start new pushes.",pointer:{main:m,index:"enabled"}}:$(""),{label:"Notes",type:"textarea",rows:4,pointer:{main:m,index:"x-LSP-notes"}},y,x];_.push({type:"buttons",buttons:[{type:"cancel",label:"Cancel",function:function(){if(a[0]&&a[0]!=e){UI.navto(a[0],a[1])}else{UI.navto("Push")}}},{type:"save",label:"Save",preSave:function(){if(t=="auto"){var e=$('[name="scheduletime"]').getval();var a=$('[name="startunix"]').getval();if(typeof n=="undefined"){if(e&&!a){$('[name="startunix"]').setval(e)}}else if(m.params.startunix&&m.scheduletime){if(e!=m.scheduletime&&a==m.params.startunix){$('[name="startunix"]').setval(e)}}}delete m.startVariableName;delete m.startVariableOperator;delete m.startVariableValue;delete m.endVariableName;delete m.endVariableOperator;delete m.endVariableValue;delete m.completetime;delete m.scheduletime;if(m.start_rule)m.start_rule.map(function(e){return null});if(m.end_rule)m.end_rule.map(function(e){return null})},function:function(){if(t=="auto"){if(!m.enabled){m.stream="deactivated_"+m.stream}delete m.enabled}var i=m.params;for(var s in i){if(i[s]===null||i[s]===false){delete i[s]}else if(!(s in k)){delete i[s]}}if(m.start_rule&&m.start_rule[0]===null){delete m.start_rule}if(m.end_rule&&m.end_rule[0]===null){delete m.end_rule}if("start_rule"in m||"end_rule"in m){m.scheduletime=0;m.completetime=0}if(Object.keys(i).length||m.custom_url_params&&m.custom_url_params.length){var r=[];for(var s in i){r.push(s+"="+i[s])}for(var s in m.custom_url_params){r.push(m.custom_url_params[s])}m.target+="?"+r.join("&")}delete m.params;delete m.custom_url_params;var o={};if(t=="auto"){if(n){o.push_auto_add={};o.push_auto_add[n]=m}else{o.push_auto_add=m}}else{o.push_start=m}mist.send(function(){if(a[0]&&a[0]!=e){UI.navto(a[0],a[1])}else{UI.navto("Push")}},o)}}]});i.append(UI.buildUI(_))}mist.send(function(e){ne=e.active_streams;if(!ne){ne=[]}var t=[];for(var a in ne){if(ne[a].indexOf("+")!=-1){t.push(ne[a].replace(/\+.*/,"")+"+")}}ne=ne.concat(t);var i=0;var s=0;for(var a in mist.data.streams){ne.push(a);if(mist.inputMatch(UI.findInput("Folder").source_match,mist.data.streams[a].source)){ne.push(a+"+");mist.send(function(e,t){var a=t.stream;for(var n in e.browse.files){for(var r in mist.data.capabilities.inputs){if(r.indexOf("Buffer")>=0||r.indexOf("Folder")>=0||r.indexOf("Buffer.exe")>=0||r.indexOf("Folder.exe")>=0){continue}if(mist.inputMatch(mist.data.capabilities.inputs[r].source_match,"/"+e.browse.files[n])){ne.push(a+"+"+e.browse.files[n])}}}s++;if(i==s){ne=ne.filter(function(e,t,a){return a.lastIndexOf(e)===t}).sort();re()}},{browse:mist.data.streams[a].source},{stream:a});i++}}if(i==s){ne=ne.filter(function(e,t,a){return a.lastIndexOf(e)===t}).sort();re()}},{active_streams:1});break;case"Triggers":if(!("triggers"in mist.data.config)||!mist.data.config.triggers){mist.data.config.triggers={}}var P=$("<tbody>");var z=$("<table>").html($("<thead>").addClass("sticky").html($("<tr>").html($("<th>").text("Trigger on").attr("data-sort-type","string").addClass("sorting-asc")).append($("<th>").text("Applies to").attr("data-sort-type","string")).append($("<th>").text("Handler").attr("data-sort-type","string")).append($("<th>")))).append(P);i.append(UI.buildUI([{type:"help",help:"Triggers are a way to react to events that occur inside MistServer. These allow you to block specific users, redirect streams, keep tabs on what is being pushed where, etcetera. For full documentation, please refer to the developer documentation section on the MistServer website."}])).append($("<button>").text("New trigger").click(function(){UI.navto("Edit Trigger")})).append(z);z.stupidtable();var oe=mist.data.config.triggers;for(var b in oe){for(var le in oe[b]){var de=triggerRewrite(oe[b][le]);P.append($("<tr>").attr("data-index",b+","+le).append($("<td>").text(b)).append($("<td>").text("streams"in de?de.streams.join(", "):"")).append($("<td>").text(de.handler)).append($("<td>").html($("<button>").text("Edit").click(function(){UI.navto("Edit Trigger",$(this).closest("tr").attr("data-index"))})).append($("<button>").text("Delete").click(function(){var e=$(this).closest("tr").attr("data-index").split(",");if(confirm("Are you sure you want to delete this "+e[0]+" trigger?")){mist.data.config.triggers[e[0]].splice(e[1],1);if(mist.data.config.triggers[e[0]].length==0){delete mist.data.config.triggers[e[0]]}mist.send(function(e){UI.navto("Triggers")},{config:mist.data.config})}}))))}}break;case"Edit Trigger":if(!("triggers"in mist.data.config)||!mist.data.config.triggers){mist.data.config.triggers={}}if(typeof mist.data.capabilities=="undefined"){mist.send(function(i){UI.showTab(e,t,a)},{capabilities:true});i.append("Loading..");return}if(!t){i.html($("<h2>").text("New Trigger"));var L={}}else{t=t.split(",");var ce=triggerRewrite(mist.data.config.triggers[t[0]][t[1]]);var L={triggeron:t[0],appliesto:ce.streams,url:ce.handler,async:ce.sync,default:ce["default"],params:ce.params}}var pe=[];for(var b in mist.data.capabilities.triggers){var ue=mist.data.capabilities.triggers[b];pe.push([b,b+": "+ue.when])}var fe=$("<div>").addClass("desc");var he=$("<div>");i.append(UI.buildUI([{label:"Trigger on",pointer:{main:L,index:"triggeron"},help:"For what event this trigger should activate.",type:"select",select:pe,validate:["required"],function:function(){var e=$(this).getval();var t=mist.data.capabilities.triggers[e];fe.html("");if(t){function a(e){switch(e){case"ignored":return"No. The trigger will ignore the response of the handler.";break;case"always":return"Yes. The trigger needs a response to proceed.";break;case"when-blocking":return"The trigger needs a response to proceed if it is configured to be blocking.";break;default:return e}}var i=[$("<h4>").text("Trigger properties"),{type:"help",help:'The trigger "<i>'+e+'</i>" has the following properties:'},{type:"span",label:"Triggers",value:t.when,help:"When this trigger is activated"}];if(t.payload!=""){i.push({label:"Payload",type:"textarea",value:t.payload,rows:t.payload.split("\n").length,readonly:true,clipboard:true,help:"The information this trigger sends to the handler."})}i.push({type:"span",label:"Requires response",value:a(t.response),help:"Whether this trigger requires a response from the trigger handler"});i.push({type:"span",label:"Response action",value:t.response_action,help:"What this trigger will do with its handler's response"});fe.append(UI.buildUI(i));if(t.stream_specific){$("[name=appliesto]").closest(".UIelement").show()}else{$("[name=appliesto]").setval([]).closest(".UIelement").hide()}if(t.argument){$("[name=params]").closest(".UIelement").show();he.text(t.argument)}else{$("[name=params]").setval("").closest(".UIelement").hide()}}}},fe,$("<h4>").text("Trigger settings"),{label:"Applies to",pointer:{main:L,index:"appliesto"},help:"For triggers that can apply to specific streams, this value decides what streams they are triggered for.<br><br>Leave this list empty to apply the trigger to all streams.<br><br>These may either be a full stream name, a partial wildcard stream name, a full wildcard stream name, or a tag preceded by a # (e.g. #tag1).<br>For example, given the stream <i>a</i> you can use:              <ul>              <li><i>a</i>: the stream configured as <i>a</i></li>              <li><i>a+</i>: all streams configured as <i>a</i> with a wildcard behind it, but not <i>a</i> itself</li>              <li><i>a+b</i>: only the version of stream <i>a</i> that has wildcard <i>b</i></li>              </ul>",type:"inputlist",datalist:Object.keys(mist.data.streams),value:a[1]!=""?[a[1]]:[]},$("<br>"),{label:"Handler (URL or executable)",help:"This can be either an HTTP URL or a full path to an executable.",pointer:{main:L,index:"url"},validate:["required"],type:"str"},{label:"Blocking",type:"checkbox",help:"If checked, pauses processing and uses the response of the handler. If the response does not start with 1, true, yes or cont, further processing is aborted. If unchecked, processing is never paused and the response is not checked.",pointer:{main:L,index:"async"}},{label:"Parameters",type:"str",help:$("<div>").text("The extra data you want this trigger to use.").append(he),pointer:{main:L,index:"params"}},{label:"Default response",type:"str",help:"The default response in case the handler fails or is set to non-blocking.",placeholder:"true",pointer:{main:L,index:"default"}},{type:"buttons",buttons:[{type:"cancel",label:"Cancel",function:function(){if(a[0]&&a[0]!=e){UI.navto(a[0],a[1])}else{UI.navto("Triggers")}}},{type:"save",label:"Save",function:function(){if(t){mist.data.config.triggers[t[0]].splice(t[1],1)}var i={handler:L.url,sync:L.async?true:false,streams:typeof L.appliesto=="undefined"?[]:L.appliesto,params:L.params,default:L["default"]};if(!("triggers"in mist.data.config)||mist.data.config.triggers===null){mist.data.config.triggers={}}if(!(L.triggeron in mist.data.config.triggers)){mist.data.config.triggers[L.triggeron]=[]}mist.data.config.triggers[L.triggeron].push(i);mist.send(function(){if(a[0]&&a[0]!=e){UI.navto(a[0],a[1])}else{UI.navto("Triggers")}},{config:mist.data.config})}}]}]));$("[name=triggeron]").trigger("change");break;case"Logs":{let Te=$("<div>").addClass("buttons");let Me=UI.modules.logs();Te.append(Me.find("> button").first());Me.find("> h3").remove();i.append(Te).append(Me);break}case"Statistics":var me=$("<span>").text("Loading..");i.append(me);var L={graph:"new"};var ve=mist.stored.get().graphs?$.extend(true,{},mist.stored.get().graphs):{};var be={};for(var b in mist.data.streams){be[b]=true}for(var b in mist.data.active_streams){be[mist.data.active_streams[b]]=true}be=Object.keys(be).sort();var ge=[];for(var b in mist.data.config.protocols){ge.push(mist.data.config.protocols[b].connector)}ge.sort();mist.send(function(){UI.plot.datatype.templates.cpuload.cores=0;for(var e in mist.data.capabilities.cpu){UI.plot.datatype.templates.cpuload.cores+=mist.data.capabilities.cpu[e].cores}me.html(UI.buildUI([{type:"help",help:"Here you will find the MistServer stream statistics, you can select various categories yourself. All statistics are live: up to five minutes are saved."},$("<h3>").text("Select the data to display"),{label:"Add to",type:"select",select:[["new","New graph"]],pointer:{main:L,index:"graph"},classes:["graph_ids"],function:function(){if(!$(this).val()){return}var e=me.find(".graph_xaxis");var t=me.find(".graph_id");if($(this).val()=="new"){e.children("option").prop("disabled",false);t.setval("Graph "+(Object.keys(ve).length+1)).closest("label").show()}else{var a=ve[$(this).val()].xaxis;e.children("option").prop("disabled",true).filter('[value="'+a+'"]').prop("disabled",false);t.closest("label").hide()}if(e.children('option[value="'+e.val()+'"]:disabled').length){e.val(e.children("option:enabled").first().val())}e.trigger("change")}},{label:"Graph id",type:"str",pointer:{main:L,index:"id"},classes:["graph_id"],validate:[function(e,t){if(e in ve){return{msg:"This graph id has already been used. Please enter something else.",classes:["red"]}}return false}]},{label:"Axis type",type:"select",select:[["time","Time line"]],pointer:{main:L,index:"xaxis"},value:"time",classes:["graph_xaxis"],function:function(){$s=me.find(".graph_datatype");switch($(this).getval()){case"coords":$s.children("option").prop("disabled",true).filter('[value="coords"]').prop("disabled",false);break;case"time":$s.children("option").prop("disabled",false).filter('[value="coords"]').prop("disabled",true);break}if(!$s.val()||$s.children('option[value="'+$s.val()+'"]:disabled').length){$s.val($s.children("option:enabled").first().val());$s.trigger("change")}}},{label:"Data type",type:"select",select:[["clients","Connections"],["upbps","Bandwidth (up)"],["downbps","Bandwidth (down)"],["cpuload","CPU use"],["memload","Memory load"],["coords","Client location"],["perc_lost","Lost packages"],["perc_retrans","Re-transmitted packages"]],pointer:{main:L,index:"datatype"},classes:["graph_datatype"],function:function(){$s=me.find(".graph_origin");switch($(this).getval()){case"cpuload":case"memload":$s.find("input[type=radio]").not('[value="total"]').prop("disabled",true);$s.find('input[type=radio][value="total"]').prop("checked",true);break;default:$s.find("input[type=radio]").prop("disabled",false);break}}},{label:"Data origin",type:"radioselect",radioselect:[["total","All"],["stream","The stream:",be],["protocol","The protocol:",ge]],pointer:{main:L,index:"origin"},value:["total"],classes:["graph_origin"]},{type:"buttons",buttons:[{label:"Add data set",type:"save",function:function(){var e;if(L.graph=="new"){e=UI.plot.addGraph(L,t);ve[e.id]=e;me.find("input.graph_id").val("");me.find("select.graph_ids").append($("<option>").text(e.id)).val(e.id).trigger("change")}else{e=ve[L.graph]}var a=UI.plot.datatype.getOptions({datatype:L.datatype,origin:L.origin});e.datasets.push(a);UI.plot.save(e);UI.plot.go(ve)}}]}]));var t=$("<div>").addClass("graph_container");i.append(t);var a=me.find("select.graph_ids");for(var e in ve){var s=UI.plot.addGraph(ve[e],t);a.append($("<option>").text(s.id)).val(s.id);var n=[];for(var r in ve[e].datasets){var o=UI.plot.datatype.getOptions({datatype:ve[e].datasets[r].datatype,origin:ve[e].datasets[r].origin});n.push(o)}s.datasets=n;ve[s.id]=s}a.trigger("change");UI.plot.go(ve);UI.interval.set(function(){UI.plot.go(ve)},1e4)},{active_streams:true,capabilities:true});break;case"Server Stats":if(typeof mist.data.capabilities=="undefined"){mist.send(function(t){UI.showTab(e)},{capabilities:true});i.append("Loading..");return}var ye=$("<table>");var xe=$("<table>");var $e={vheader:"CPUs",labels:["Model","Processor speed","Amount of cores","Amount of threads"],content:[]};var we=0;for(var b in mist.data.capabilities.cpu){var ke=mist.data.capabilities.cpu[b];$e.content.push({header:"CPU #"+(Number(b)+1),body:[ke.model,UI.format.addUnit(UI.format.number(ke.mhz),"MHz"),ke.cores,ke.threads]});we+=ke.cores}var _e=UI.buildVheaderTable($e);function Ie(){var e=mist.data.capabilities.mem;var t=mist.data.capabilities.load;if(!("swapfree"in e)&&!("swaptotal"in e)){e.swapfree=0;e.swaptotal=0}if(!("shmfree"in e)&&!("shmtotal"in e)){e.shmfree=0;e.shmtotal=0}function a(e,t,a){if(e==0)return"";return $("<div>").addClass("bargraph").append($("<span>").attr("title","Used").addClass("used").text(Math.round(t/e*100)+"%").width(t/e*100+"%")).append(a?$("<span>").attr("title","Cached").addClass("cached").width(a/e*100+"%"):"")}var i={vheader:"Memory",labels:["","Used","Available","Total"],content:[{header:"Physical memory",body:[a(e.total,e.used,e.cached),$("<span>").append(UI.format.bytes(e.used*1024*1024)).append(" ("+UI.format.addUnit(t.mem,"%")+")"),$("<span>").append(UI.format.bytes(e.free*1024*1024)).append($("<div>").append("(").append(UI.format.bytes(e.cached*1024*1024)).append(" cached)")),UI.format.bytes(e.total*1024*1024)]},{header:"Shared memory",body:[a(e.shmtotal,e.shmtotal-e.shmfree),$("<span>").append(UI.format.bytes((e.shmtotal-e.shmfree)*1024*1024)).append(" ("+UI.format.addUnit(t.shm,"%")+")"),UI.format.bytes(e.shmfree*1024*1024),UI.format.bytes(e.shmtotal*1024*1024)]},{header:"Swap memory",body:[a(e.swaptotal,e.swaptotal-e.swapfree),UI.format.bytes((e.swaptotal-e.swapfree)*1024*1024),UI.format.bytes(e.swapfree*1024*1024),UI.format.bytes(e.swaptotal*1024*1024)]}]};var s=UI.buildVheaderTable(i);ye.replaceWith(s);ye=s;var n={vheader:"Load average",labels:["CPU use","1 minute","5 minutes","15 minutes"],content:[{header:"&nbsp;",body:[UI.format.addUnit(UI.format.number(mist.data.capabilities.cpu_use/10),"%"),UI.format.number(t.one/100),UI.format.number(t.five/100),UI.format.number(t.fifteen/100)]}]};var r=UI.buildVheaderTable(n);xe.replaceWith(r);xe=r}Ie();i.append(UI.buildUI([{type:"help",help:"You can find general server statistics here. Note that memory and CPU usage is for your entire machine, not just MistServer."}])).append($("<table>").css("width","auto").addClass("nolay").append($("<tr>").append($("<td>").append(ye)).append($("<td>").append(xe))).append($("<tr>").append($("<td>").append(_e).attr("colspan",2))));UI.interval.set(function(){mist.send(function(){Ie()},{capabilities:true})},3e4);break;case"Email for Help":var Ue=$.extend({},mist.data);delete Ue.statistics;delete Ue.totals;delete Ue.clients;delete Ue.capabilities;Ue=JSON.stringify(Ue);Ue="Version: "+mist.data.config.version+"\n\nConfig:\n"+Ue;var L={};i.append(UI.buildUI([{type:"help",help:"You can use this form to email MistServer support if you're having difficulties.<br>A copy of your server config file will automatically be included."},{type:"str",label:"Your name",validate:["required"],pointer:{main:L,index:"name"},value:mist.user.name},{type:"email",label:"Your email address",validate:["required"],pointer:{main:L,index:"email"}},{type:"hidden",value:"Integrated Help",pointer:{main:L,index:"subject"}},{type:"hidden",value:"-",pointer:{main:L,index:"company"}},{type:"textarea",rows:20,label:"Your message",validate:["required"],pointer:{main:L,index:"message"}},{type:"textarea",rows:20,label:"Your config file",readonly:true,value:Ue,pointer:{main:L,index:"configfile"}},{type:"buttons",buttons:[{type:"save",label:"Send",function:function(e){$(e).text("Sending..");$.ajax({type:"POST",url:"https://mistserver.org/contact?skin=plain",data:L,success:function(e){var t=$("<span>").html(e);t.find("script").remove();i.html(t[0].innerHTML)}})}}]}]));break;case"Disconnect":mist.user.password="";delete mist.user.authstring;delete mist.user.loggedin;mist.data={};UI.sockets.http_host=null;sessionStorage.removeItem("mistLogin");mist.send(function(){UI.navto("Login")},{logout:true});break;default:i.append($("<p>").text("This tab does not exist."));break}i.find(".field").filter(function(){var e=$(this).getval();if(e=="")return true;if(e==null)return true;return false}).each(function(){var e=[];if($(this).is("input, select, textarea")){e.push($(this))}else{e=$(this).find("input, select, textarea")}if(e.length){$(e[0]).focus();return false}})},dynamic:function(e,t){e=Object.assign({},e);var a=e.create(t);if(!a){return}a.raw="";if(!e.getEntry){e.getEntry=function(e,t){return t in e?e[t]:false}}if(!e.getEntries){e.getEntries=function(e){return e}}if(a.update){e.update=a.update}if(!e.update){e.update=function(){}}if(typeof e.add=="object"){var i=e.add;e.add=function(e){return UI.dynamic(i,e)}}if(e.add){a._children={};a.add=function(t){var i=e.add.call(a,t);if(!i){return}if(typeof i.remove!="function"){i.remove=function(){var e=this;if(e instanceof jQuery){e=e[0]}if(e.parentNode){e.parentNode.removeChild(e)}delete a._children[t]}}else{var s=i.remove;i.remove=function(){s.apply(this,arguments);delete a._children[t]}}i._id=t;a._children[t]=i;if(i.customAdd){i.customAdd(a)}else{a.append(i)}}}a.update=function(t,i){var s=e.getEntries(t,a._id);var n=JSON.stringify(s);if(this.raw==n){return}this.values=s;this.values_orig=t;if(e.add){for(var r in s){if(!(r in this._children)){this.add(r)}if(r in this._children){this._children[r].update.call(this._children[r],s[r],s)}}for(var o in this._children){if(!(o in s)){this._children[o].remove()}}}e.update.call(a,s,i);this.raw=n};if(e.values)a.update.call(a,e.values);return a},modules:{stream:{header:function(e,t,a){var i=$("<div>").addClass("header");var s=$("<ul>").addClass("tabnav");i.append($("<div>").css("display","flex").css("align-items","baseline").append($("<h2>").text('Stream "'+e+'"')).append(UI.modules.stream.status(e,{tags:false,thumbnail:false,livestreamhint:false}))).append(s).append($("<h2>").text(t=="Edit"?a in mist.data.streams?'Edit "'+a+'"':'Create "'+a+'"':t));var n=[["Settings","Edit"],"Status","Preview","Embed"];var r=false;if(e.indexOf("+")<0){var o=mist.data.streams[e];if(o?.source&&(o.source.match(/^\/.+\/$/)||o.source.match(/^folder:.+$/))){r=true}}if(r){n.pop();n.pop()}n.push(false);n.push(["Overview","Streams"]);function l(a){if(!a){return $("<span>").addClass("spacer")}var s=a;if(typeof a!="string"){s=a[0];a=a[1]}return $("<li>").addClass("tab").addClass(a==t?"active":false).attr("tabindex",0).attr("data-icon",a).text(s).click(function(){if(t=="Edit"&&i.attr("data-changed")){if(!confirm("Your settings have not been saved. Are you sure you want to navigate away?")){return}}UI.navto(a,a=="Streams"?"":e)})}s.append($("<span>").addClass("curtab-icon").attr("data-icon",t));for(var d in n){s.append(l(n[d]))}return i},bigbuttons:function(e,t){var a=$("<div>").addClass("bigbuttons");a.append($("<button>").text("Settings").addClass("settings").click(function(){UI.navto("Edit",e)}));var i=false;if(e.indexOf("+")<0){var s=mist.data.streams[e];if(s.source&&(s.source.match(/^\/.+\/$/)||s.source.match(/^folder:.+$/))){i=true}}if(t!="Status"){a.append($("<button>").text("Status").addClass("status").click(function(){UI.navto("Status",e)}))}if(t!="Preview"&&!i){a.append($("<button>").text("Preview").addClass("preview").click(function(){UI.navto("Preview",e)}))}if(t!="Embed"&&!i){a.append($("<button>").text("Embed").addClass("embed").click(function(){UI.navto("Embed",e)}))}a.append($("<button>").addClass("cancel").addClass("return").text("Return").click(function(){UI.navto("Streams")}));return a},findMist:function(e,t,a){var i=$("<div>").addClass("findMist").hide();var s=false;function n(e){var t=[];for(var a=0;a<e.length;a++){if(e.indexOf(e[a])==a){t.push(e[a])}}return t}function r(e){var t={HTTP:[],HTTPS:[]};var o=t.HTTP;var l=t.HTTPS;if(s)console.log("Attempting to find urls to reach MistServer's HTTP output..");if(UI.sockets.http_host){if(a){o.push(UI.sockets.http_host);l.push(UI.sockets.http_host);if(s)console.log("Found previously used urls to MistServer's HTTP output, but performing a full search; adding it to both the result lists",UI.sockets.http_host)}else{if(s)console.log("Found a previously used url to MistServer's HTTP output, using that one",UI.sockets.http_host);return e([UI.sockets.http_host])}}if(!mist.data.capabilities){if(s)console.log("I don't know MistServer's capabilities yet, retrieving those first.. brb");mist.send(function(){r(e)},{capabilities:true});return}var d=mist.stored.get();if("HTTPUrl"in d){if(s)console.log("Found a previously valid HTTP url stored in MistServer's config, adding it to the HTTP list",d.HTTPUrl);o.push(d.HTTPUrl)}if("HTTPSUrl"in d){if(s)console.log("Found a previously valid HTTPS url stored in MistServer's config, adding it to the HTTPS list",d.HTTPSUrl);l.push(d.HTTPSUrl)}for(var c in mist.data.config.protocols){var p=mist.data.config.protocols[c];var u=p.connector;u=(""+u).replace(".exe","");switch(p.connector){case"HTTP":case"HTTPS":{if(p.pubaddr){for(var f in p.pubaddr){var h;if(p.pubaddr[f].slice(0,2)=="//"){h=location.protocol;h=h.replace(":","").toUpperCase()}else{h=p.pubaddr[f].split(":")[0].toUpperCase()}if(h in t){t[h].push(p.pubaddr[f]);if(s)console.log("Found a public address in the protocol config, adding it to the "+h+" list",p.pubaddr[f])}else{console.warn("Unknown protocol in public address configuration for "+p.connector+": ",p.pubaddr[f])}}}var m=p.port;if(!m){if(p.connector in mist.data.capabilities.connectors){m=mist.data.capabilities.connectors[p.connector].optional.port["default"]}}if(m){var v=parseURL(mist.user.host,{port:m,pathname:"",protocol:u.toLowerCase()+":"}).full;t[p.connector].push(v);if(s)console.log("Found a port in the protocol config, adding it to the "+p.connector+" list",v)}break}}}if(!o.length){var v=parseURL(mist.user.host,{port:8080,pathname:""}).full;if(s)console.log("Haven't found any HTTP urls yet, adding the default to the HTTP list",v);o.push(v)}if(!l.length){if(s)console.log("Haven't found any HTTPS urls yet, copying the HTTP list to HTTPS: it's worth a try",o);t.HTTPS=o;l=t.HTTPS}o=n(o);l=n(l);i.urls=t;if(s)console.log("Full scan result:",t);var b=location.protocol=="https:"?l:o;if(s)console.log("Returning:",b);return e(b)}function o(e,a){if(a>=e.length){return l(e)}try{if(!t){t=function(e){return e+"player.js"}}url=t(e[a]);if(url.slice(0,2)=="//"){url=location.protocol+url}if(url.slice(0,4)=="http"){$.ajax({type:"GET",url:url,success:function(t){i.hide();d(e[a],t)},error:function(t,i,n){o(e,a+1);if(s)console.log("Could not reach "+url,n)}})}else if(url.slice(0,2)=="ws"){var n=UI.websockets.create(url);n.onopen=function(){n.onerror=function(){};i.hide();d(e[a],n)};n.onerror=function(t){o(e,a+1)}}else{throw"I'm not sure how to contact MistServer with this protocol. (at "+url+")"}}catch(t){if(s)console.warn("Something went wrong while testing urls:",t,"attempt:",a,"url:",e[a]);o(e,a+1)}}function l(e){if(e.length==1&&e[0]==UI.sockets.http_host){UI.sockets.http_host=null;r(function(t){e=t;o(t,0)})}var t;var a;if(e.length){t=$("<div>");var s=$("<ul>");for(var l in e){var d=$("<li>").html($("<a>").attr("href",e[l]).text(e[l]).attr("target","MistURL"));s.append(d)}t.html(s);a=$("<div>").append($("<span>").text("").css("position","absolute").css("margin","1em 0 0 2em")).append($("<div>").css({border:"1px solid #bbb",padding:"0.5em 1em 0 3em",margin:"0 1em"}).append($("<h2>").text("Why am I seeing this?")).append($("<p>").html("If you think one of the urls above should have worked, try clicking the link. <br>If something went wrong, your browser may give you more information about what it is. <br>If you see something like this:")).append($("<div>").css("margin-left","2em").html("<h1>Unsupported Media Type</h1>The server isn't quite sure what you wanted to receive from it.")).append($("<p>").html("then MistServer <i>can</i> be reached there but it couldn't be called from this page, possibly because of mixed content (if you're on an https website, your browser will refuse to load http content: create an https output) or CORS issues (if the HTTP output is accessible on a domain other than '"+location.origin+"' and that is not configured to allow cross-domain requests: check your proxy configuration).")))}else{t=$("<span>").text("I've not tried anything yet. I'm cluessless. Please help.")}var c={};var p=location.protocol=="https:"?"S":"";i.show().html($("<p>").text("Something went wrong: I could not locate MistServer's HTTP"+p+" output url. Where can it be reached?")).append($("<div>").addClass("description").append($("<p>").text("I've attempted:")).append(t)).append(UI.buildUI([{label:"MistServer's HTTP"+p+" endpoint",type:"datalist",datalist:e,help:"Please specify the url at which MistServer's HTTP"+p+" endpoint can be reached.",validate:["required",function(e,t){if(e.length<4){return}if(e.slice(0,4)!="http"){return{msg:"The url to MistServer should probably start with "+location.protocol+"//, for example: <br>"+parseURL(location.origin,{port:location.protocol=="https:"?4433:8080,pathname:""}).full,break:false,classes:["orange"]}}if(e.slice(0,5)!=location.href.slice(0,5)){return{msg:"It looks like you're attempting to connect to MistServer using "+parseURL(e).protocol+", while this page has been loaded over "+parseURL(location.href).protocol+". Your browser may refuse this because it is insecure.",break:false,classes:["orange"]}}}],pointer:{main:c,index:"url"}},{type:"buttons",buttons:[{type:"save",label:"Connect",function:function(){if(c.url[c.url.length-1]!="/"){e.unshift(c.url+"/")}e.unshift(c.url);e=n(e);o(e,0)}}]}])).append(a)}function d(t,a){if(t!=UI.sockets.http_host){UI.sockets.http_host=t;mist.stored.set("HTTP"+(t.slice(0,5)=="https"?"S":"")+"Url",t)}e.call(i,t,a)}r(function(e){o(e,0)});i.getUrls=function(e){return i.urls};return i},livestreamhint:function(e){var t=$("<div>").addClass("livestreamhint");var a=mist.data.streams[e.split("+")[0]];if(a?.source&&a.source.slice(0,1)!="/"&&!a.source.match(/-exec:/)){if("streamkeys"in mist.data){UI.updateLiveStreamHint(e,a.source,t)}else{mist.send(function(){UI.updateLiveStreamHint(e,a.source,t)},{streamkeys:true})}}else{return false}return t},status:function(e,t){var a={livestreamhint:true,status:true,stats:true,tags:true,thumbnail:true};if(!t){t={}}t=Object.assign(a,t);var i={mode:0,cont:$("<div>").addClass("activestream").attr("data-state",0),status:t.status?$("<div>").attr("data-streamstatus",0).text("Inactive").hide():false,viewers:t.stats?$("<span>").attr("beforeifnotempty","Viewers: "):false,inputs:t.stats?$("<span>").attr("beforeifnotempty","Inputs: "):false,outputs:t.stats?$("<span>").attr("beforeifnotempty","Outputs: "):false,context_menu:false,tags:false,addtag:t.tags&&t.tags!="readonly"?$("<div>").addClass("input_container").attr("title","Add a tag to this stream's current tags.\nNote that tags added here will not be applied when the stream restarts. To do that, add the tag through the stream settings.").css("display","block").html($("<span>").attr("showifstate","0").text("Transient tags can be added here once the stream is active.")).append($("<input>").attr("showifstate","1").attr("placeholder","Tag name").on("keydown",function(e){switch(e.key){case" ":{e.preventDefault();break}case"Enter":{$(this).parent().find("button").click();break}}})).append($("<button>").attr("showifstate","1").text("Add transient tag").click(function(){var t={};var a=$(this);var i=a.parent().find("input");var s={tag_stream:{}};s.tag_stream[e]=i.val();a.text("Adding..");mist.send(function(e){a.text("Add tag");i.val("")},s)})):false,livestreamhint:t.livestreamhint?UI.modules.stream.livestreamhint(e):false};i.tags=false;if(t.tags){if(t.tags!="readonly"){i.context_menu=new UI.context_menu}i.tags=UI.modules.stream.tags({streamname:e,readonly:t.tags=="readonly",context_menu:i.context_menu,getStreamstatus:function(){return this.closest("[data-state]").getAttribute("data-state")}});i.tags.update()}i.cont.html(i.status).append(i.viewers).append(i.inputs).append(i.outputs).append(i.tags?i.tags:false).append(i.addtag).append(t.thumbnail?UI.modules.stream.thumbnail(e):false).append(i.livestreamhint);if(i.context_menu){i.cont.css("position","relative");i.cont.append(i.context_menu.ele)}UI.sockets.ws.active_streams.subscribe(function(a,s){if(t.status)i.status.css("display","");if(a=="stream"){if(s[0]==e){i.cont.attr("data-state",s[1]);var n=["Inactive","Initializing","Booting","Waiting for data","Available","Shutting down","Invalid state"];if(t.status)i.status.attr("data-streamstatus",s[1]).text(n[s[1]]);if(t.stats){i.viewers.text(s[2]);i.inputs.text(s[3]>0?s[3]:"");i.outputs.text(s[4]>0?s[4]:"")}if(t.tags){i.tags.update({stats:s})}if(i.livestreamhint){if(s[1]==0){i.livestreamhint.show()}else{i.livestreamhint.hide()}}}}else if(a=="error"){if(t.status){i.status.attr("data-streamstatus",6).text(s)}}});return $("<section>").addClass("activestream").append(i.cont)},actions:function(e,t){return $("<section>").addClass("actions").addClass("bigbuttons").html($("<button>").text("Stop all sessions").attr("data-icon","stop").attr("title","Disconnect sessions for this stream. Disconnecting a session will kill any currently open connections (viewers, pushes and possibly the input). If the USER_NEW trigger is in use, it will be triggered again by any reconnecting connections.").click(function(){if(confirm("Are you sure you want to disconnect all sessions (viewers, pushes and possibly the input) from this stream?")){mist.send(function(){},{stop_sessions:t})}})).append($("<button>").text("Invalidate sessions").attr("data-icon","invalidate").attr("title","Invalidate all the currently active sessions for this stream. This has the effect of re-triggering the USER_NEW trigger, allowing you to selectively close some of the existing connections after they have been previously allowed. If you don't have a USER_NEW trigger configured, this will not have any effect.").click(function(){if(confirm("Are you sure you want to invalidate all sessions for the stream '"+t+"'?\nThis will re-trigger the USER_NEW trigger.")){mist.send(function(){},{invalidate_sessions:t})}})).append($("<button>").text("Nuke stream").attr("data-icon","nuke").attr("title","Shut down a running stream completely and/or clean up any potentially left over stream data in memory. It attempts a clean shutdown of the running stream first, followed by a forced shut down, and then follows up by checking for left over data in memory and cleaning that up if any is found.").click(function(){if(confirm("Are you sure you want to completely shut down the stream '"+t+"'?\nAll viewers will be disconnected.")){mist.send(function(){UI.showTab(e,t)},{nuke_stream:t})}}))},thumbnail:function(e,t){if(!UI.findOutput("JPG")){return}var a,i;var s=$("<img>").hover(function(){if(a&&i){$(this).attr("src",i)}},function(){if(a&&i){$(this).attr("src",a)}});UI.sockets.ws.info_json.subscribe(function(e){if(!e.source)return;for(var t in e.source){if(e.source[t].type=="html5/image/jpeg"){var r=e.source[t].url;if(r.indexOf(".mjpg")>-1){i=r}else{a=r}if(a&&i){break}}}if(i||a){if(!i)i=a;else if(!a)a=i;s.attr("src",a);if(n)n.attr("src",a)}},e);var n;if(t&&t.clone)n=$("<img>").addClass("clone");return $("<section>").addClass("thumbnail").html(s).append(n)},metadata:function(e,t){var a={tracktable:true,tracktiming:true};if(!t){t={}}t=Object.assign(a,t);var i=$("<div>").addClass("meta").text("Loading..");var s=UI.dynamic({create:function(){var e=$("<span>");e.main=UI.dynamic({create:function(){var a=$("<div>").addClass("main").addClass("input_container");a.type=$("<span>");a.html($("<label>").append($("<span>").text("Type:")).append(a.type));a.buffer=$("<span>");a.append($("<label>").attr("data-liveonly","").append($("<span>").text("Buffer window:")).append(a.buffer));a.jitter=$("<span>");a.append($("<label>").attr("data-liveonly","").append($("<span>").text("Jitter:")).append(a.jitter));if(t.tracktiming){a.timing=UI.dynamic({create:function(){var e=$("<div>").addClass("tracktiming");e.box=$("<div>").addClass("boxcont");e.box.label=$("<span>").addClass("center");e.box.left=$("<span>").addClass("left");e.box.right=$("<span>").addClass("right");e.box.append($("<div>").addClass("box")).append(e.box.label).append(e.box.left).append(e.box.right);e.append(e.box);e.bounds=null;e.mstopos=function(e){if(!this.bounds){return 25}var t=(e-this.bounds.firstms.min)/(this.bounds.lastms.max-this.bounds.firstms.min)*100;return t};e.mstosize=function(e){if(!this.bounds){return 10}return e/(this.bounds.lastms.max-this.bounds.firstms.min)*100};return e},add:{create:function(e){var t=$("<div>").addClass("track").attr("data-track",e);t.label=$("<label>");t.box=$("<div>").addClass("box");t.jitter=$("<div>").addClass("jitter");t.box.append(t.jitter);t.left=$("<span>").addClass("left").attr("beforeifnotempty","-");t.right=$("<span>").addClass("right").attr("beforeifnotempty","+");t.box.append(t.left);t.box.append(t.right);t.append(t.box).append(t.label);return t},update:function(e){if(e.type!=this.raw_type){this.attr("data-type",e.type)}if(e.type!=this.raw_tracktype){this.attr("title",UI.format.capital(e.type));this.raw_tracktype=e.type}if(this.label.raw!=e.idx+e.type+e.codec){this.label.text("Track "+e.idx+" ("+e.codec+")");this.label.raw=e.idx+e.type+e.codec;this.css("order",e.idx)}if(this.jitter.raw!=e.jitter){this.jitter.attr("title","Jitter: "+e.jitter+"ms");this.jitter.raw=e.jitter}var t="nowms"in e?"nowms":"lastms";var i=a.timing.bounds.firstms.max;var s=a.timing.bounds.lastms.min;this.box.css("left",a.timing.mstopos(e.firstms)+"%");this.box.css("right",100-a.timing.mstopos(e[t])+"%");if(i>=s){if(e.firstms>s){this.left.html(UI.format.duration((i-e.firstms)*.001,true))}else{this.left.html(UI.format.duration((s-e.firstms)*.001,true))}if(e.lastms>i){this.right.html(UI.format.duration((e[t]-i)*.001,true))}else{this.right.html(UI.format.duration((e[t]-s)*.001,true))}}else{this.left.html(UI.format.duration((i-e.firstms)*.001,true));this.right.html(UI.format.duration((e[t]-s)*.001,true))}this.jitter.width(e.jitter/(e[t]-e.firstms)*100+"%")}},getEntries:function(e){var t={};var i=!a.includemeta.is(":checked");for(var s in e){if(i&&e[s].type=="meta"){continue}t[s]=e[s]}var n={firstms:{min:1e24,max:-1e24},lastms:{min:1e24,max:-1e24}};for(var s in t){var r="nowms"in t[s]?"nowms":"lastms";n.firstms.min=Math.min(n.firstms.min,t[s].firstms);n.firstms.max=Math.max(n.firstms.max,t[s].firstms);n.lastms.min=Math.min(n.lastms.min,t[s][r]);n.lastms.max=Math.max(n.lastms.max,t[s][r])}a.timing.bounds=n;for(var s in t){t[s].bounds=n}return t},update:function(e){var t=a.timing.bounds.firstms.max;var i=a.timing.bounds.lastms.min;this.box.label.html(UI.format.duration(Math.abs(t-i)*.001,true));this.box[0].style.setProperty("--ntracks",Object.keys(e).length);if(t<i){this.box.css("margin-left",a.timing.mstopos(t)+"%");this.box.css("margin-right",100-a.timing.mstopos(i)+"%");this.box.left.html(UI.format.duration(t*.001));this.box.right.html(UI.format.duration(i*.001));this.box.removeClass("gap")}else{this.box.css("margin-left",a.timing.mstopos(i)+"%");this.box.css("margin-right",100-a.timing.mstopos(t)+"%");this.box.left.html(UI.format.duration(i*.001));this.box.right.html(UI.format.duration(t*.001));this.box.addClass("gap")}if(this.box.width()<40){this.box.addClass("toosmall")}else{this.box.removeClass("toosmall")}}});a.includemeta=$("<input>").attr("type","checkbox").click(function(){e.main.timing.update(e.main.timing.values_orig)});a.append($("<label>").append($("<span>").text("Include metadata in graph:")).append(a.includemeta)).append($("<label>").append($("<span>").text("Track timing:"))).append(a.timing)}if(t.tracktable){a.tracks=UI.dynamic({create:function(){return $("<div>").addClass("tracks")},getEntries:function(e){var t={audio:{},video:{},subtitle:{},meta:{}};if(e){var a=Object.keys(e).sort(function(t,a){return e[t].idx-e[a].idx});for(var i in a){var s=e[a[i]];var n=s.codec=="subtitle"?"subtitle":s.type;t[n][a[i]]=s;s.nth=Object.values(t[n]).length}}return t},add:function(e){var t=UI.dynamic({create:function(e){var t=$("<table>").css("width","auto");t.rows=[];var a={audio:{vheader:"Audio",labels:["Codec","Duration","Jitter","Avg bitrate","Peak bitrate","Channels","Samplerate","Language","Track index"]},video:{vheader:"Video",labels:["Codec","Duration","Jitter","Avg bitrate","Peak bitrate","Size","Framerate","Language","Track index","Has B-Frames"]},subtitle:{vheader:"Subtitles",labels:["Codec","Duration","Jitter","Avg bitrate","Peak bitrate","Language"]},meta:{vheader:"Metadata",labels:["Codec","Duration","Jitter","Avg bitrate","Peak bitrate"]}};t.headers=a[e].labels;t.header=$("<tr>").addClass("header").append($("<td>").addClass("vheader").attr("rowspan",a[e].labels.length+1).html($("<span>").text(a[e].vheader))).append($("<td>"));var i=$("<tbody>").append(t.header);for(var s in a[e].labels){var n=$("<tr>").attr("data-label",a[e].labels[s]).append($("<td>").text(a[e].labels[s]+":"));t.rows.push(n);i.append(n)}t.append(i);return t},add:{create:function(e,a){var i=$("<td>");var s=[];for(var n in t.headers){s.push($("<td>"))}return{header:i,cells:s,customAdd:function(e){e.header.append(this.header);for(var t in this.cells){e.rows[t].append(this.cells[t])}}}},update:function(e){function t(e){function t(e,t){if("maxbps"in e){return UI.format.bits(e[t]*8,1)}else{if(t=="maxbps"){return UI.format.bits(e.bps*8,1)}return"unknown"}}function a(e){if(e.firstms==0&&e.lastms==0){return" No data "}var t="lastms";if("nowms"in e){t="nowms"}var a;a=UI.format.duration((e.lastms-e.firstms)/1e3);a+="<br><span class=description>"+UI.format.duration(e.firstms/1e3)+" to "+UI.format.duration(e[t]/1e3)+"</span>";return a}var i=e.codec=="subtitle"?"subtitle":e.type;switch(i){case"audio":return{header:"Track "+e.idx,body:[e.codec,a(e),UI.format.addUnit(UI.format.number(e.jitter),"ms"),t(e,"bps"),t(e,"maxbps"),e.channels,UI.format.addUnit(UI.format.number(e.rate),"Hz"),"language"in e?e.language:"unknown",e.nth]};break;case"video":return{header:"Track "+e.idx,body:[e.codec,a(e),UI.format.addUnit(UI.format.number(e.jitter),"ms"),t(e,"bps"),t(e,"maxbps"),UI.format.addUnit(e.width,"x ")+UI.format.addUnit(e.height,"px"),e.fpks==0?"variable":UI.format.addUnit(UI.format.number(e.fpks/1e3),"fps"),"language"in e?e.language:"unknown",e.nth,"bframes"in e?"yes":"no"]};break;case"subtitle":return{header:"Track "+e.idx,body:[e.codec,a(e),UI.format.addUnit(UI.format.number(e.jitter),"ms"),t(e,"bps"),t(e,"maxbps"),"language"in e?e.language:"unknown",e.nth]};break;case"meta":return{header:"Track "+e.idx,body:[e.codec,a(e),UI.format.addUnit(UI.format.number(e.jitter),"ms"),t(e,"bps"),t(e,"maxbps")]};break}}var a=t(e);if(this.header.raw!=a.header){this.header.text(a.header);this.header.raw=a.header}for(var i in this.cells){if(this.cells[i].raw!=a.body[i]){this.cells[i].html(a.body[i]);this.cells[i].raw=a.body[i]}}}},update:function(){if(Object.values(this._children).length){this.show()}else{this.hide()}}},e);return t},update:function(){}});a.append($("<label>").append($("<span>").text("Track metadata:"))).append(a.tracks)}return a},update:function(e){var t=this;if(t.type.raw!=e.type){t.type.text(e.type=="live"?"Live":"Video on demand");t.type.raw=e.type}if(e.meta){if(t.buffer.raw!=e.meta.buffer_window){t.buffer.html(e.meta.buffer_window?UI.format.addUnit(UI.format.number(e.meta.buffer_window*.001),"s"):"N/A");t.buffer.raw=e.meta.buffer_window}if(t.jitter.raw!=e.meta.jitter){t.jitter.html(e.meta.jitter?UI.format.addUnit(UI.format.number(e.meta.jitter),"ms"):"N/A");t.jitter.raw=e.meta.jitter}t.tracks.update(e.meta.tracks);t.timing.update(e.meta.tracks)}}});e.audio=$("<table>").hide();e.video=$("<table>").hide();e.subtitle=$("<table>").hide();e.metadata=$("<table>").hide();return e.append(e.main).append(e.audio).append(e.video).append(e.subtitle).append(e.metadata)},update:function(e){this.main.update(e);if(this.raw_type!=e.type){this.attr("data-type",e.type);this.raw_type=e.type}}});function n(t){if(s.freeze){return}if(t.error&&(!i.rawdata||i.rawdata.type=="live")){i.html("").attr("onempty",t.error+".")}else{if(i.rawdata&&i.rawdata.type=="live"||!t.error){i.rawdata=t}if(!s.parent().length){i.html($("<div>").append($("<button>").text("Open raw json").click(function(){var t=window.open(null,"Stream info json for "+e);t.document.write("<html><head><title>Raw stream metadata for '"+e+'\'</title><meta http-equiv="content-type" content="application/json; charset=utf-8"></head><body><code><pre>'+JSON.stringify(i.rawdata,null,2)+"</pre></code></body></html>");t.document.close()})).append($("<button>").text("Freeze").attr("title","Pauze updating the stream metadata information below").click(function(){if($(this).text()=="Freeze"){$(this).text("Frozen").css("background","#bbb");s.freeze=true}else{$(this).text("Freeze")[0].style.background="";s.freeze=false}}))).append(s)}function a(e){if(s.freeze){return}var t=e.meta;s.update(e)}a(t)}}var r=true;UI.sockets.ws.info_json.subscribe(function(t){n(t);if(r&&!t.error){r=false;if(t.type=="live"){UI.interval.set(function(){$.ajax({type:"GET",url:UI.sockets.http_host+"json_"+e+".js",success:n})},5e3)}}},e);return $("<section>").addClass("meta").append($("<h3>").text("Stream metadata")).append(i)},processes:function(e){var t=$("<div>").attr("onempty","None.").addClass("processes");var a={"Process type:":function(e){return $("<b>").text(e.process)},"Source:":function(e){var t=$("<span>").text(e.source);if(e.source_tracks&&e.source_tracks.length){t.append($("<span>").addClass("description").text(" track "+e.source_tracks.slice(0,-2).concat(e.source_tracks.slice(-2).join(" and ")).join(", ")))}return t},"Sink:":function(e){var t=$("<span>").text(e.sink);if(e.sink_tracks&&e.sink_tracks.length){t.append($("<span>").addClass("description").text(" track "+e.sink_tracks.slice(0,-2).concat(e.sink_tracks.slice(-2).join(" and ")).join(", ")))}return t},"Active for:":function(e){var t=(new Date).setSeconds((new Date).getSeconds()-e.active_seconds);return $("<span>").append($("<span>").html(UI.format.duration(e.active_seconds))).append($("<span>").addClass("description").text(" since "+UI.format.time(t/1e3)))},"Pid:":function(e,t){return t},"Logs:":function(e){var t=$("<div>").text("None.");if(e.logs&&e.logs.length){t.html("").addClass("description").addClass("logs").css({maxHeight:"6em",display:"flex",flexFlow:"column-reverse nowrap"});for(var a in e.logs){var i=e.logs[a];t.prepend($("<div>").append(UI.format.time(i[0])+" ["+i[1]+"] "+i[2]))}}return t},"Additional info:":function(e){var t;if("ainfo"in e&&e.ainfo&&Object.keys(e.ainfo).length){t=$("<table>");var a=false;if(e.process in mist.data.capabilities.processes){a=mist.data.capabilities.processes[e.process]}if(e.process+".exe"in mist.data.capabilities.processes){a=mist.data.capabilities.processes[e.process+".exe"]}for(var i in e.ainfo){var s=false;if(a&&a.ainfo&&a.ainfo[i]){s=a.ainfo[i]}if(!s){s={name:i}}t.append($("<tr>").append($("<th>").text(s.name+":")).append($("<td>").html(e.ainfo[i]).append(s.unit?$("<span>").addClass("unit").text(s.unit):"")))}}else{t=$("<span>").addClass("description").text("N/A")}return t}};var i=UI.dynamic({create:function(){var e=$("<table>");e.rows={};for(var t in a){var i=$("<tr>").append($("<th>").text(t).css("vertical-align","top"));e.append(i);e.rows[t]=i}return e},add:{create:function(){var e=$("<div>").hide();e.remove=function(){for(var e in this._children){this._children[e].remove()}};return e},add:{create:function(e){return $("<td>").css("vertical-align","top")},update:function(e){this.html(e)}},getEntries:function(e,t){var i={};for(var s in a){var n=a[s](e,t);if(typeof n=="object"){n=n.prop("outerHTML")}i[s]=n}return i},update:function(e){for(var t in this._children){if(!this._children[t].moved){i.rows[t].append(this._children[t]);this._children[t].moved=true}}return}},update:function(e){if(Object.keys(e).length){if(!i.parent().length){i.find("tr").first().addClass("header");t.append(i)}}else{i.remove()}}});UI.sockets.http.api.subscribe(function(e){if(e.proc_list){i.update(e.proc_list)}},{proc_list:e});return $("<section>").addClass("processes").append($("<h3>").text("Processes")).append(t)},triggers:function(e,t){var a=$("<div>").attr("onempty","None.").addClass("triggers");if(mist.data.config.triggers&&Object.keys(mist.data.config.triggers).length){var i=$("<table>").append($("<tbody>").append($("<tr>").addClass("header type").append($("<th>").text("Trigger name:"))).append($("<tr>").addClass("streams").append($("<th>").text("Applies to:"))).append($("<tr>").addClass("handler").append($("<th>").text("Handler:"))).append($("<tr>").addClass("blocking").append($("<th>").text("Blocking:"))).append($("<tr>").addClass("response").append($("<th>").text("Default response:"))).append($("<tr>").addClass("actions").append($("<th>").text("Actions:"))));a.append(i);var s=0;for(var n in mist.data.config.triggers){var r=mist.data.config.triggers[n];for(var o in r){var l=r[o];if(l.streams.length){if(l.streams.indexOf(e)<0){if(l.streams.indexOf(e.split("+")[0])<0){continue}}}s++;var d=i.find("tr");for(var c=0;c<d.length;c++){var p=$("<td>");switch(c){case 0:{p.append($("<b>").text(n));break}case 1:{p.text(l.streams.length?l.streams.join(", "):"All streams");break}case 2:{p.text(l.handler);break}case 3:{p.text(l.sync?"Blocking":"Non-blocking");break}case 4:{p.text(l["default"]?l["default"]:"true");break}case 5:{p.addClass("buttons").attr("data-index",o).attr("data-type",n).append($("<button>").text("Edit").click(function(){var e=$(this).closest(".buttons");UI.navto("Edit Trigger",e.attr("data-type")+","+e.attr("data-index"))})).append(l.streams.length>1?$("<button>").text("Remove from stream").click(function(){var a=$(this).closest(".buttons");var i=a.attr("data-type");var s=mist.data.config.triggers[i][a.attr("data-index")].streams;var n=s.indexOf(e);if(n>=0){s.splice(n,1)}else{n=s.indexOf(e.split("+")[0]);if(n>=0){s.splice(n,1)}}mist.send(function(){UI.navto(t,e)},{config:mist.data.config})}):$("<button>").text("Remove").click(function(){var a=$(this).closest(".buttons");var i=a.attr("data-type");if(confirm("Are you sure you want to delete this "+i+" trigger?")){mist.data.config.triggers[i].splice(a.attr("data-index"),1);if(mist.data.config.triggers[i].length==0){delete mist.data.config.triggers[i]}mist.send(function(a){UI.navto(t,e)},{config:mist.data.config})}}));break}}d.eq(c).append(p)}}}if(s==0){i.remove()}}return $("<section>").addClass("triggers").append($("<h3>").text("Triggers")).append($("<button>").text("Add a trigger").click(function(){UI.navto("Edit Trigger")})).append(a)},pushes:function(e){return UI.modules.pushes({stream:e,logs:false,stop_pushes:false})},logs:function(e){return UI.modules.logs(e)},accesslogs:function(e){var t=$("<div>").attr("onempty","None.").addClass("accesslogs");var a=false;UI.sockets.ws.active_streams.subscribe(function(i,s){if(i=="access"){var n=t[0].scrollTop>=t[0].scrollHeight-t[0].clientHeight;if(s[2]!=""&&s[2]!=e.split("+")[0]){return}var r=$("<span>").html("").append(UI.format.bytes(s[6]));if(s[6]!=0){r.append("(").append(UI.format.bits(s[6]*8/s[5],true)).append(")")}var o=$("<span>").html("").append(UI.format.bytes(s[7]));if(s[7]!=0){o.append("(").append(UI.format.bits(s[7]*8/s[5],true)).append(")")}var l=$("<div>").html($("<span>").addClass("description").text(UI.format.dateTime(s[0]))).append($("<span>").attr("beforeifnotempty","Token: ").attr("title",s[1]).css("max-width","10em").text(s[1])).append($("<span>").attr("beforeifnotempty","Connector: ").text(s[3])).append($("<span>").attr("beforeifnotempty","Hostname: ").text(s[4])).append($("<span>").attr("beforeifnotempty","Connected for: ").html(UI.format.duration(s[5]))).append(r).append(o);t.append(l);if(n)t[0].scrollTop=t[0].scrollHeight;if(a){try{var n=a.document.scrollingElement.scrollTop>=a.document.scrollingElement.scrollHeight-a.document.scrollingElement.clientHeight;a.document.write(l[0].outerHTML);if(n)a.document.scrollingElement.scrollTop=a.document.scrollingElement.scrollHeight}catch(e){}}}else if(i=="error"){var l=$("<div>").text(s);t.append(l)}});return $("<section>").addClass("accesslogs").append($("<h3>").text("Access logs")).append($("<button>").text("Open raw").click(function(){a=window.open("","MistServer access logs for "+e);a.document.write("<html><head><title>MistServer access logs for '"+e+'\'</title><meta http-equiv="content-type" content="application/json; charset=utf-8"><style>body{padding-left:2em;text-indent:-2em;}body>*>*:not(:last-child):not(:empty){padding-right:.5em;}.description{font-size:.9em;color:#777}[beforeifnotempty]:not(:empty):before{content:attr(beforeifnotempty);color:#777}</style></head><body>');a.document.write(t[0].innerHTML);a.document.scrollingElement.scrollTop=a.document.scrollingElement.scrollHeight})).append(t)},preview:function(e,t){var a=$("<section>").addClass("preview");if(!t){window.mv={};t=mv}UI.sockets.http.player(function(){mistPlay(e,{target:a[0],host:UI.sockets.http_host,skin:{inherit:"dev",colors:{accent:"var(--accentColor)"},blueprints:{protocol_mismatch_warning:function(){var e=this;var t=document.createElement("div");MistUtil.event.addListener(e.options.target,"initializeFailed",function(){if(e.info&&e.info.source){var a="";var i=false;if(e.info.source.length==0){a="No stream sources were found."}else{var s=false;var n=location.protocol;for(var r in e.info.source){var o=e.info.source[r].url;o=o.replace(/^ws/,"http");if(o.slice(0,n.length)==n){s=true;break}if(o.slice(0,2)=="//"){s=true;break}}if(!s){n=n.replace(":","").toUpperCase();a="No stream sources using "+n+" were found. You should configure "+n+" to play media from a "+n+" webpage.";if(n=="HTTPS"){i=document.createElement("a");i.setAttribute("href","https://docs.mistserver.org/howto/https/");i.setAttribute("target","_blank");i.appendChild(document.createTextNode("Documentation about HTTPS"))}}}if(a!=""){t.className="err_balloon orange";t.style.position="static";t.style.margin="2em 0 3em";t.appendChild(document.createTextNode("Warning:"));t.appendChild(document.createElement("br"));t.appendChild(document.createTextNode(a));t.appendChild(document.createElement("br"));if(i){t.appendChild(i);t.appendChild(document.createElement("br"))}var l=document.createElement("button");l.style.marginTop="1em";l.appendChild(document.createTextNode("Configure protocols"));t.appendChild(l);l.addEventListener("click",function(){UI.navto("Protocols")})}}},e.video);return t}}},loop:true,MistVideoObject:t})},function(e){$preciew_cont.html(e)});return a},playercontrols:function(e,t){var a=$("<section>").addClass("controls").addClass("mistvideo").addClass("input_container").html($("<h3>").text("MistPlayer")).append($("<p>").text("Waiting for player.."));if(!t){t=$(".dashboard")}if(!$("link#devcss").length){document.head.appendChild($("<link>").attr("rel","stylesheet").attr("type","text/css").attr("href",UI.sockets.http_host+"skins/dev.css").attr("id","devcss")[0])}function i(){var t=e.reference;function i(e){return t.UI.buildStructure.call(t.UI,e)}var s=i({if:function(){return this.playerName&&this.source},then:{type:"container",classes:["mistvideo-description"],style:{display:"block"},children:[{type:"playername",style:{display:"inline"}},{type:"text",text:"is playing",style:{margin:"0 0.2em"}},{type:"mimetype"}]}});var n=i({type:"container",classes:["mistvideo-column","mistvideo-devcontrols"],children:[{type:"protocol_mismatch_warning"},{type:"text",text:"Player control"},{type:"container",classes:["mistvideo-devbuttons"],style:{"flex-wrap":"wrap"},children:[{if:function(){return!!(this.player&&this.player.api)},then:{type:"button",title:"Reload the video source",label:"Reload video",onclick:function(){this.player.api.load()}}},{type:"button",title:"Build MistVideo again",label:"Reload player",onclick:function(){this.reload()}},{type:"button",title:"Switch to the next available player and source combination",label:"Try next combination",onclick:function(){this.nextCombo()}}]},{type:"forcePlayer"},{type:"forceType"},{type:"forceSource"}]});var r=i({type:"decodingIssues",style:{"max-width":"30em","flex-flow":"column nowrap"}});var o=i({type:"log"});var l=$("<button>").text("Open raw").css({display:"block",marginTop:"0.333em"}).click(function(){var e=t.stream;tab=window.open("","Player logs for "+e);tab.document.write("<html><head><title>Player logs for '"+e+'\'</title><meta http-equiv="content-type" content="application/json; charset=utf-8"><style>.timestamp{color:#777;font-size:0.9em;}</style></head><body>');tab.document.write(o.lastChild.outerHTML);tab.document.scrollingElement.scrollTop=tab.document.scrollingElement.scrollHeight});o.insertBefore(l[0],o.children[0]);a.html($("<div>").append($("<div>").append($("<h3>").addClass("title").text("MistPlayer")).append(s)).append(n).append(r)).append(o)}if(e&&e.reference&&e.reference.skin){i()}t[0].addEventListener("initialized",function(){i()});t[0].addEventListener("initializedFailed",function(){i()});return a},embedurls:function(e,t,a){var i=$("<section>").addClass("embedurls");var s=$("<datalist>").attr("id","urlhints");var n=a.HTTPS.concat(a.HTTP);for(var r in n){s.append($("<option>").val(n[r]))}var o=otherhost.host?otherhost.host:n.length?n[0]:t;i.append($("<span>").addClass("input_container").append($("<label>").addClass("UIelement").append($("<span>").addClass("label").text("Use base URL:")).append($("<span>").addClass("field_container").append($("<input>").attr("type","text").addClass("field").val(o).attr("list","urlhints")).append(s).append($("<span>").addClass("unit").append($("<button>").text("Apply").click(function(){otherhost.host=$(this).closest("label").find("input").val();if(otherhost.host.slice(-1)!="/"){otherhost.host+="/"}UI.navto("Embed",e)}))))));var l=encodeURIComponent(e);var d=false;var c={forcePlayer:"",forceType:"",controls:true,autoplay:true,loop:false,muted:false,fillSpace:false,poster:"",urlappend:"",setTracks:{}};var p=$.extend({},c);var u=UI.stored.getOpts();if("embedoptions"in u){p=$.extend(p,u.embedoptions,true);if(typeof p.setTracks!="object"){p.setTracks={}}}var f={};switch(p.controls){case"stock":f.controls="stock";break;case true:f.controls=1;break;case false:f.controls=0;break}function h(){function t(e){var t="";function a(){var e=Math.floor(Math.random()*62);if(e<10){return e}if(e<36){return String.fromCharCode(e+55)}return String.fromCharCode(e+61)}while(e--){t+=a()}return t}function i(e){switch(typeof e){case"string":if($.isNumeric(e)){return e}return'"'+e+'"';case"object":return JSON.stringify(e);default:return e}if(typeof e=="string"){return}}if(d){UI.stored.saveOpt("embedoptions",p)}var s=e+"_"+t(12);var n=['target: document.getElementById("'+s+'")'];for(var r in p){if(r=="prioritize_type"){if(p[r]&&p[r]!=""){n.push("forcePriority: "+JSON.stringify({source:[["type",[p[r]]]]}))}continue}if(r=="monitor_action"){if(p[r]&&p[r]!=""){if(p[r]=="nextCombo"){n.push("monitor: {\n"+"          action: function(){\n"+'            this.MistVideo.log("Switching to nextCombo because of poor playback in "+this.MistVideo.source.type+" ("+Math.round(this.vars.score*1000)/10+"%)");'+"\n"+"            this.MistVideo.nextCombo();\n"+"          }\n"+"        }")}}continue}if(p[r]!=c[r]&&p[r]!=null&&(typeof p[r]!="object"||JSON.stringify(p[r])!=JSON.stringify(c[r]))){n.push(r+": "+i(p[r]))}}var u=[];u.push('<div class="mistvideo" id="'+s+'">');u.push("  <noscript>");u.push('    <a href="'+o+l+".html"+'" target="_blank">');u.push("      Click here to play this video");u.push("    </a>");u.push("  </noscript>");u.push("  <script>");u.push("    var a = function(){");u.push('      mistPlay("'+e+'",{');u.push("        "+n.join(",\n        "));u.push("      });");u.push("    };");u.push("    if (!window.mistplayers) {");u.push('      var p = document.createElement("script");');if(a.HTTPS.length){u.push('      if (location.protocol == "https:") { p.src = "'+(parseURL(o).protocol=="https://"?o:a.HTTPS[0])+'player.js" } ');u.push('      else { p.src = "'+(parseURL(o).protocol=="http://"?o:a.HTTP[0])+'player.js" } ')}else{u.push('      p.src = "'+o+'player.js"')}u.push("      document.head.appendChild(p);");u.push("      p.onload = a;");u.push("    }");u.push("    else { a(); }");u.push("  <\/script>");u.push("</div>");return u.join("\n")}var m=h(p);var v=$("<div>").text("Loading..").css("display","flex").css("flex-flow","column nowrap");var b=$("<span>").text("Loading..").css("word-break","break-all");if(mistplayers){var g=[["","Automatic"]];for(var r in mistplayers){g.push([r,mistplayers[r].name])}}i.append(UI.buildUI([$("<h3>").text("Urls"),{label:"Stream info json",type:"str",value:o+"json_"+l+".js",readonly:true,clipboard:true,help:"Information about this stream as a json page."},{label:"Stream info script",type:"str",value:o+"info_"+l+".js",readonly:true,clipboard:true,help:"This script loads information about this stream into a mistvideo javascript object."},{label:"HTML page",type:"str",value:o+l+".html",readonly:true,qrcode:true,clipboard:true,help:"A basic html containing the embedded stream."},$("<h3>").text("Embed code"),{label:"Embed code",type:"textarea",value:m,rows:m.split("\n").length+3,readonly:true,classes:["embed_code"],clipboard:true,help:"Include this code on your webpage to embed the stream. The options below can be used to configure how your content is displayed."},$("<h4>").text("Embed code options (optional)").css("margin-top",0),{type:"help",help:"Use these controls to customise what this embedded video will look like.<br>Not all players have all of these options."},{label:"Prioritize type",type:"select",select:[["","Automatic"]],pointer:{main:p,index:"prioritize_type"},classes:["prioritize_type"],function:function(){if(!d){return}p.prioritize_type=$(this).getval();$(".embed_code").setval(h(p))},help:"Try to use this source type first, but full back to something else if it is not available."},{label:"Force type",type:"select",select:[["","Automatic"]],pointer:{main:p,index:"forceType"},classes:["forceType"],function:function(){if(!d){return}p.forceType=$(this).getval();$(".embed_code").setval(h(p))},help:"Only use this particular source."},{label:"Force player",type:"select",select:g,pointer:{main:p,index:"forcePlayer"},classes:["forcePlayer"],function:function(){if(!d){return}p.forcePlayer=$(this).getval();$(".embed_code").setval(h(p))},help:"Only use this particular player."},{label:"Controls",type:"select",select:[["1","MistServer Controls"],["stock","Player controls"],["0","None"]],pointer:{main:f,index:"controls"},function:function(){p.controls=$(this).getval()==1;switch($(this).getval()){case 0:p.controls=false;break;case 1:p.controls=true;break;case"stock":p.controls="stock";break}$(".embed_code").setval(h(p))},help:"The type of controls that should be shown."},{label:"Autoplay",type:"checkbox",pointer:{main:p,index:"autoplay"},function:function(){p.autoplay=$(this).getval();$(".embed_code").setval(h(p))},help:"Whether or not the video should play as the page is loaded."},{label:"Loop",type:"checkbox",pointer:{main:p,index:"loop"},function:function(){p.loop=$(this).getval();$(".embed_code").setval(h(p))},help:"If the video should restart when the end is reached."},{label:"Start muted",type:"checkbox",pointer:{main:p,index:"muted"},function:function(){p.muted=$(this).getval();$(".embed_code").setval(h(p))},help:"If the video should restart when the end is reached."},{label:"Fill available space",type:"checkbox",pointer:{main:p,index:"fillSpace"},function:function(){p.fillSpace=$(this).getval();$(".embed_code").setval(h(p))},help:"The video will fit the available space in its container, even if the video stream has a smaller resolution."},{label:"Poster",type:"str",pointer:{main:p,index:"poster"},function:function(){p.poster=$(this).getval();$(".embed_code").setval(h(p))},help:"URL to an image that is displayed when the video is not playing."},{label:"Video URL addition",type:"str",pointer:{main:p,index:"urlappend"},help:"The embed script will append this string to the video url, useful for sending through params.",classes:["embed_code_forceprotocol"],function:function(){p.urlappend=$(this).getval();$(".embed_code").setval(h(p))}},{label:"Preselect tracks",type:"DOMfield",DOMfield:v,help:"Pre-select these tracks."},{label:"Monitoring action",type:"select",select:[["","Ask the viewer what to do"],["nextCombo","Try the next source / player combination"]],pointer:{main:p,index:"monitor_action"},function:function(){p.monitor_action=$(this).getval();$(".embed_code").setval(h(p))},help:"What the player should do when playback is poor."},$("<h3>").text("Protocol stream urls"),b]));function y(e,t){var a=[];var s=i.find(".field.forceType");var n=i.find(".field.prioritize_type");if(t){t=t.replace(parseURL(t).protocol,"");a.push($("<div>").addClass("orange").html('Warning: the provided base URL <a href="'+o+'">'+o+"</a> could not be reached. These links are my best guess but will probably not work properly.").css({margin:"0.5em 0",width:"45em","word-break":"normal"}))}for(var r in e.source){var l=e.source[r];var c=UI.humanMime(l.type);var u=l.url;if(t){u=parseURL(l.url).protocol+t+l.relurl}var f=u.match(/[\?\&]tkn=\d+\&?/);if(f){f=f[0];u=u.replace(f,f[0]=="?"&&f.slice(-1)=="&"?"?":f.slice(-1)=="&"?"&":"")}a.push({label:c?c+" <span class=description>("+l.type+")</span>":UI.format.capital(l.type),type:"str",value:u,readonly:true,qrcode:true,clipboard:true});var c=UI.humanMime(l.type);if(s.children('option[value="'+l.type+'"]').length==0){s.append($("<option>").text(c?c+" ("+l.type+")":UI.format.capital(l.type)).val(l.type));n.append($("<option>").text(c?c+" ("+l.type+")":UI.format.capital(l.type)).val(l.type))}}s.val(p.forceType);n.val(p.prioritize_type);b.html(UI.buildUI(a));d=true}function x(e){var t={};for(var a in e.meta.tracks){var i=e.meta.tracks[a];if(i.codec=="subtitle"){i.type="subtitle"}if(i.type!="audio"&&i.type!="video"&&i.type!="subtitle"){continue}if(!(i.type in t)){if(i.type=="subtitle"){t[i.type]=[]}else{t[i.type]=[["","Autoselect "+i.type]]}}t[i.type].push([i.trackid,UI.format.capital(i.type)+" track "+(t[i.type].length+(i.type=="subtitle"?1:0))])}v.html("");if(Object.keys(t).length){v.closest("label").show();var s=["audio","video","subtitle"];for(var n in s){var a=s[n];if(!t[a]||!t[a].length){continue}var r=$("<select>").attr("data-type",a).css("flex-grow","1").change(function(){if($(this).val()==""){delete p.setTracks[$(this).attr("data-type")]}else{p.setTracks[$(this).attr("data-type")]=$(this).val()}$(".embed_code").setval(h(p))});v.append(r);if(a=="subtitle"){t[a].unshift(["","No "+a])}else{t[a].push([-1,"No "+a])}for(var o in t[a]){r.append($("<option>").val(t[a][o][0]).text(t[a][o][1]))}if(a in p.setTracks){r.val(p.setTracks[a]);if(r.val()==null){r.val("");delete p.setTracks[a];$(".embed_code").setval(h(p))}}}}else{v.closest("label").hide()}}function w(a){UI.sockets.ws.info_json.subscribe(function(e){if(e.type=="error"){if(a==o){w(t)}else{throw e}return}if("source"in e){if(!d||e.source.length)y(e,a==o?false:o)}if("meta"in e&&"tracks"in e.meta){x(e)}},e,a.replace(/^http/,"ws")+"json_"+encodeURIComponent(e)+".js",false,"?inclzero=1")}w(o);return i},tags:function(e){e=Object.assign({streamname:false,readonly:false,context_menu:false,onclick:false,getStreamstatus:function(){return 0}},e);return UI.dynamic({create:function(){var e=document.createElement("div");e.classList.add("tags");return e},add:{create:function(t){var a=document.createElement("span");a.classList.add("tag");a.appendChild(document.createTextNode(t));a.remove=function(){if(this.parentNode){this.parentNode.removeChild(this)}};if(e.onclick)a.addEventListener("click",function(a){return e.onclick.apply(this,[a,t])});if(!e.readonly&&e.context_menu){a.addEventListener("contextmenu",function(a){a.stopPropagation();a.preventDefault();var i=this.values;var s=e.streamname;var n=e.getStreamstatus.apply(this,arguments);var r=[];if(n!=0){if(i==0){r.push(["Re-activate tag",function(){var a={tag_stream:{}};a.tag_stream[s]=t;mist.send(function(){e.context_menu.hide()},a)},"",""])}else{r.push(["Untag stream",function(){var a={untag_stream:{}};a.untag_stream[s]=t;mist.send(function(){e.context_menu.hide()},a)},"","Remove this tag from this stream."+(i==2?"\nIt will not be removed from the config, so it will return when the stream restarts.":"")])}}e.context_menu.show([[$("<div>").addClass("header").append($("<div>").text("#"+t)).append($("<div>").addClass("description").text({0:"Inactive tag",1:"Transient tag",2:"Persistent tag"}[i]).attr("title",this.getAttribute("title")))],r.length?r:null],a)})}return a},update:function(e){var t={0:"This tag is inactive: it is in the stream config, but it has been removed. It will return when the stream restarts.",1:"This tag is transient: it is not in the stream config. It will disappear when the stream becomes inactive.",2:"This tag is persistent: it is in the stream config. It will remain when the stream restarts."};if(this.raw!==e){this.raw=e;this.setAttribute("data-type",e);this.setAttribute("title",t[e])}}},getEntries:function(t){if(!t){t={}}if(Array.isArray(t)){t={stats:t}}if(!("tags"in t)){t.tags=[];var a=e.streamname.split("+")[0];if(a in mist.data.streams){t.tags=mist.data.streams[a].tags}}var i={};for(var s in t.tags){i[t.tags[s]]=0}if(t.stats&&t.stats.length>=6&&t.stats[1]!=0){var n=t.stats[5];if(typeof n=="string"&&n!=""){n=n.split(" ")}for(var s in n){if(n[s]in i){i[n[s]]=2}else{i[n[s]]=1}}}else{for(var s in i){i[s]=2}}return i}})},clients:function(e){var t={Host:function(e){return e.host},Protocol:function(e){return e.protocol.replace("INPUT:","")},Connected:function(e){return UI.format.duration(e.conntime)},"Data downloaded":function(e){return UI.format.bytes(e.down)},"Current bitrate":function(e){return UI.format.bits(e.downbps*8,true)},"Media time":function(e){return e.position?UI.format.duration(e.position):""},"Packets received":function(e){return e.pktcount?UI.format.number(e.pktcount,{round:false}):""},"Packets lost":function(e){return e.pktcount?UI.format.number(e.pktlost,{round:false}):""},"Packets retransmitted":function(e){return e.pktcount?UI.format.number(e.pktretransmit,{round:false}):""}};var a=UI.dynamic({create:function(){var e=$("<thead>");var a=$("<tbody>");var i=$("<table>").append(e).append(a);i._rows={};for(var s in t){var n=$("<tr>");var r=$("<td>").text(s+":");n.append(r);i._rows[s]=n;a.append(n)}e.append(a.children().first());return i},add:{create:function(){var e={cells:{},customAdd:function(e){for(var t in this.cells){e._rows[t].append(this.cells[t])}},remove:function(e){for(var t in this.cells){this.cells[t].remove();delete this.cells[t]}}};for(var a in t){e.cells[a]=$("<td>")}return e},update:function(e){for(var a in this.cells){var i=t[a].call(null,e);if(this.cells[a].raw!=i){this.cells[a].html(i);this.cells[a].raw=i}}}},update:function(e){if(e.length){if(!a.parent().length){a._parent.append(a)}}else if(a.parent()){a._parent=a.parent();a.remove()}}});UI.sockets.http.clients.subscribe(function(t){for(var i=t.data.length-1;i>=0;i--){if(t.data[i].stream!=e){t.data.splice(i,1)}}a.update(t.data)},{streams:[e],protocols:["INPUT"]});return $("<section>").addClass("clients").append($("<div>").addClass("inputs").append($("<h3>").text("Current input")).append(a))}},logs:function(e){var t=true;var a=$("<div>").attr("onempty","None.").attr("data-scrolling",t).addClass("logs").on("scroll",function(){if(this.scrollTop+this.clientHeight>=this.scrollHeight-5){t=true}else{t=false}a.attr("data-scrolling",t)});var i=false;UI.sockets.ws.active_streams.subscribe(function(s,n){if(s=="log"){if(e&&n[3]!=""&&n[3]!=e.split("+")[0]){return}if(n[1]=="ACCS"){return}var r=$("<div>").addClass("message").attr("data-debuglevel",n[1]).html($("<span>").addClass("time").html($("<span>").append($("<span>").addClass("description").text("[")).append($("<span>").text(UI.format.dateTime(n[0]))).append($("<span>").addClass("description").text("] ")).children())).append($("<span>").addClass("binary").attr("title","binary name").text(n[5])).append($("<span>").addClass("stream").attr("title","stream name").html(n[3]?$("<span>").append($("<span>").addClass("description").text(":")).append($("<span>").text(n[3])).children():"")).append($("<span>").addClass("pid").attr("title","pid").html(n[4]?$("<span>").append($("<span>").addClass("description").text(" (")).append($("<span>").text(n[4])).append($("<span>").addClass("description").text(")")).children():"")).append($("<span>").addClass("debuglevel").attr("title","debug level").html($("<span>").append($("<span>").addClass("description").text(" [")).append($("<span>").text(n[1])).append($("<span>").addClass("description").text("]")).children())).append($("<span>").addClass("message").text(" "+n[2])).append($("<span>").addClass("line").addClass("copy_but_hide").attr("title","line number").html(n[6]?"&nbsp;("+n[6]+")":""));a.append(r);if(a.children().length>1e3){a.children().first().remove()}if(t)a[0].scrollTop=a[0].scrollHeight;if(i){try{let e=i.document.scrollingElement.scrollTop>=i.document.scrollingElement.scrollHeight-i.document.scrollingElement.clientHeight;i.document.write(r[0].outerHTML);if(e)i.document.scrollingElement.scrollTop=i.document.scrollingElement.scrollHeight}catch(e){}}}else if(s=="error"){var r=$("<div>").text(n);a.append(r)}});return $("<section>").addClass("logs").append($("<h3>").text("MistServer logs")).append($("<button>").text("Open raw").click(function(){i=window.open("","MistServer logs"+(e?" for "+e:""));i.document.write("<html><head><title>MistServer logs"+(e?" for '"+e+"'":"")+'</title><meta http-equiv="content-type" content="application/json; charset=utf-8"><style>body{padding-left:2em;text-indent:-2em;font-family:monospace}.description,.message :is(.time,.binary,.pid,.line){font-size:.9em;color:#777}.message:is([data-debuglevel="WARN"],[data-debuglevel="ERROR"],[data-debuglevel="FAIL"]){font-weight:bold;}</style></head><body>');i.document.write(a[0].innerHTML);i.document.scrollingElement.scrollTop=i.document.scrollingElement.scrollHeight})).append(a).append($("<button>").addClass("down").attr("data-icon","down").attr("title","Snap to bottom").click(function(){t=true;a[0].scrollTop=a[0].scrollHeight}))},pushes:function(e){if(!e){e={}}e=Object.assign({stream:false,logs:true,stop_pushes:true,form:false,collapsible:false},e);var t=$("<div>").addClass("pushes");t.html("Loading..");mist.send(function(a){t.html("");mist.data.push_list=a.push_list;var i=new UI.context_menu;t.append(i.ele);if(e.push_settings){t.append($("<section>").append($("<h3>").text("Automatic push settings")).append(UI.buildUI([{type:"help",help:"These settings only apply to automatic pushes."},{label:"Delay before retry",unit:"s",type:"int",min:0,help:"How long the delay should be before MistServer retries an automatic push.<br>If set to 0, it does not retry.",default:3,pointer:{main:a.push_settings,index:"wait"}},{label:"Maximum retries",unit:"/s",type:"int",min:0,help:"The maximum amount of retries per second (for all automatic pushes).<br>If set to 0, there is no limit.",default:0,pointer:{main:a.push_settings,index:"maxspeed"}},{type:"buttons",buttons:[{type:"save",label:"Save",function:function(){mist.send(function(e){UI.navto("Push")},{push_settings:a.push_settings})}}]}])))}if(e.filter){t.append(UI.buildUI([{label:"Filter the pushes below",classes:["filter"],help:"Pushes that do not contain this text in their stream, target or notes will be hidden.",function:function(e){var a=$(this).getval();var i=t.find("table[data-pushtype]").each(function(e,t){t.filter(a)})},css:{"margin-top":"3em"}}]).css({"margin-bottom":0}))}function s(s,n){function r(e,t,a){var i="";i+="$"+e+" ";switch(Number(t)){case 0:{i+="is true";break}case 1:{i+="is false";break}case 2:{i+="== "+a;break}case 3:{i+="!= "+a;break}case 10:{i+="> (numerical) "+a;break}case 11:{i+=">= (numerical) "+a;break}case 12:{i+="< (numerical) "+a;break}case 13:{i+="<= (numerical) "+a;break}case 20:{i+="> (lexical) "+a;break}case 21:{i+=">= (lexical) "+a;break}case 22:{i+="< (lexical) "+a;break}case 23:{i+="<= (lexical) "+a;break}default:{i+="comparison operator unknown";break}}return i}var o={"":function(e){var t=$("<label>").addClass("toggle-switch").append($("<input>").attr("type","checkbox").prop("checked",!e.deactivated).change(function(){if(e.deactivated){var t=$(this);var a={};a[e.id]=e;mist.send(function(e){d.update(e.auto_push)},{push_auto_add:a})}else{e.stream="deactivated_"+e.stream;var a={};a[e.id]=e;mist.send(function(e){d.update(e.auto_push)},{push_auto_add:a})}})).append($("<div>").addClass("slider")).append($("<span>").text(e.deactivated?"Disabled":"Enabled").hide()).click(function(e){e.stopPropagation()});return t},Stream:function(e){if(e.stream[0]=="#")return e.stream;return $("<a>").addClass("clickable").text(e.stream).click(function(t){UI.navto("Preview",e.stream);t.stopPropagation()}).on("contextmenu",function(t){t.preventDefault();t.stopPropagation();var a=e.stream;var s=[$("<div>").addClass("header").text(a)];var n=[[$("<span>").html("Edit "+(a.indexOf("+")<0?"stream":"<b>"+a.split("+")[0]+"</b>")),function(){UI.navto("Edit",a)},"Edit","Change the settings of this stream."],["Stream status",function(){UI.navto("Status",a)},"Status","See more details about the status of this stream."],["Preview stream",function(){UI.navto("Preview",a)},"Preview","Watch the stream."]];var r=[s];r.push(n);i.show(r,t)})},Target:function(e){var t=$("<div>");var a=e.target;if(s!="Automatic"){if(e.stats&&e.stats.current_target){a=e.stats.current_target}else{a=e.resolved_target}}a=a.split("?");var i=[];if(a.length>1)i=a.pop().split("&");var n=a.join("?");t.append($("<span>").text(n).attr("title",e.target));if(i.length){t.append($("<span>").addClass("param").text("?"+i[0]));for(var r=1;r<i.length;r++){t.append($("<span>").addClass("param").text("&"+i[r]))}}return t.children()},Conditions:false,Notes:false,Statistics:false,Actions:function(i,s){var n=$("<div>").addClass("buttons");if(s=="Automatic"){n.append($("<button>").text("Edit").click(function(e){e.stopPropagation();UI.navto("Start Push","auto_"+i.id)}))}n.append($("<button>").text(s=="Automatic"?"Remove":"Stop").click(function(e){e.stopPropagation();if(confirm("Are you sure you want to "+$(this).text().toLowerCase()+" this push?\n"+i.stream+" to "+i.target)){$(this).html($("<span>").addClass("red").text(s=="Automatic"?"Removing..":"Stopping.."));if(s=="Automatic"){var t=this;mist.send(function(e){$(t).text("Done.");d.update(e.auto_push)},{push_auto_remove:i.id})}else{mist.send(function(e){},{push_stop:[i.id]})}}}));if(s=="Automatic"){if(e.stop_pushes){n.append($("<button>").text("Stop pushes").click(function(e){e.stopPropagation();var s='Are you sure you want to stop all pushes matching \n"'+i.stream+" to "+i.target+'"?';if(i.stream[0]=="#"){s="Are you sure you want to stop all pushes to "+i.target+'"?'}if(!i.deactivated&&a.push_settings.wait!=0){s+="\n\nRetrying is enabled. That means the push will probably just restart. You'll probably want to set 'Delay before retry' to 0, or disable the autopush first."}if(confirm(s)){var n=$(this);n.text("Stopping pushes..");var r=[];var o=mist.data.push_list;for(var l in o){if(i.target==o[l][2]&&(i.stream[0]=="#"||i.stream==o[l][1])){r.push(o[l][0]);t.find('table[data-pushtype="active"] tr[data-pushid='+o[l][0]+"]").html($("<td colspan=99>").html($("<span>").addClass("red").text("Stopping..")))}}mist.send(function(){n.text("Stop pushes")},{push_stop:r})}}))}}return n}};if(e.stream){delete o.Stream}if(s=="Automatic"){o.Conditions=function(e){var t=$("<div>");if("scheduletime"in e){t.append($("<span>").text("schedule on "+new Date(e.scheduletime*1e3).toLocaleString()))}if("completetime"in e){t.append($("<span>").text("complete on "+new Date(e.completetime*1e3).toLocaleString()))}if("start_rule"in e){t.append($("<span>").text("starts if "+r.apply(this,e.start_rule)))}if("end_rule"in e){t.append($("<span>").text("stops if "+r.apply(this,e.end_rule)))}return t.children().length?t:""};o.Notes=function(e){if("x-LSP-notes"in e&&e["x-LSP-notes"]){return e["x-LSP-notes"]}return""}}else{delete o[""];o.Statistics={create:function(){return $("<div>").addClass("statistics")},add:{create:function(t){var a=$("<div>");var i={pid:"Pid: ",latency:"Latency: ",active_ms:"Active for: ",bytes:"Data transferred: ",mediatime:"Last sent timestamp:",media_tx:"Media time transferred: ",mediaremaining:"Media time until stream end: ",pkt_retrans_count:"Packets retransmitted: ",pkt_loss_count:"Packets lost: ",tracks:"Tracks: "};if(e.logs&&t=="logs"){return UI.dynamic({create:function(){return $("<div>").addClass("logs")},add:{create:function(){return $("<div>")},update:function(e){this.html(UI.format.time(e[0])+" ["+e[1]+"] "+e[2])}}})}if(t in i){return a.attr("beforeifnotempty",i[t])}},update:function(e,t){var a=this;var i={pid:function(e){return e},latency:function(e){var t=$("<span>").html(UI.format.addUnit(UI.format.number(e),"ms"));t.find(".unit").append($("<span>").addClass("info").text("i").hover(function(e){UI.tooltip.show(e,$("<div>").append($("<h3>").html("Latency: "+t.html())).append($("<p>").text("This the difference between the last sent timestamp and the theoretically highest possible playback position. This is usually mostly jitter buffers.")))},function(e){UI.tooltip.hide()}));return t},active_ms:function(e){return UI.format.duration(e*.001)},bytes:UI.format.bytes,mediatime:function(e){return UI.format.duration(e*.001)},media_tx:function(e){return UI.format.duration(e*.001)},mediatimestamp:function(e){return UI.format.duration(e*.001)},tracks:function(e){return e.join(", ")},pkt_retrans_count:function(e){return UI.format.number(e||0)},pkt_loss_count:function(e){return UI.format.number(e||0)+" ("+UI.format.addUnit(UI.format.number(t.pkt_loss_perc||0),"%")+" over the last "+UI.format.addUnit(5,"s")+")"}};if(this._id in i){this.html(i[this._id](e))}}}}}var l=$("<div>").attr("onempty","None.");var d;if(s=="Automatic"){d=UI.dynamic({create:function(){var e=$("<table>").attr("data-pushtype","auto");var a=$("<tr>");e.append($("<thead>").append(a)).append($("<tbody>"));for(var i in o){if(!o[i])continue;var s=$("<th>").addClass("header").text(i).attr("data-index",i);a.append(s)}a.find('[data-index="Actions"]').removeAttr("data-index").text("");UI.sortableItems(e,function(t){return e._children[this.getAttribute("data-pushid")]._children[t].raw},{controls:a[0],sortby:"Stream"in o?"Stream":"Target",sortsave:"sort_autopushes",container:e[0].children[1]});e[0].filter=function(a){if(typeof a=="undefined"){a=t.find("input.filter").getval();if(!a)a=""}a=a.toLowerCase();function i(e){if(typeof e=="undefined"||e===null)return false;return e.toLowerCase().indexOf(a)>=0}for(var s in e._children){var n=e._children[s];var r=n.values;if(i(r.stream)||i(r.target)||i(r["x-LSP-notes"])){n[0].classList.remove("hidden")}else{n[0].classList.add("hidden")}}};return e},add:{create:function(s){var n=$("<tr>").attr("data-pushid",s);n._children={};for(var r in o){if(!o[r])continue;var l=$("<td>").attr("data-index",r);n._children[r]=l;n.append(l);if(o[r]instanceof jQuery){l.html(o[r].clone(true))}else if(typeof o[r]=="object"){l.dynamic=UI.dynamic(o[r]);l.html(l.dynamic)}}n.click(function(e){if(window.getSelection().toString().length){return}var t=d._children[s].values;UI.navto("Start Push","auto_"+t.id)});n.on("contextmenu",function(n){n.preventDefault();var r=d._children[s].values;var o=$("<div>").addClass("header");if(!e.stream){o.append($("<span>").text(r.stream)).append($("<span>").addClass("unit").text("  "))}o.append($("<span>").addClass("target").append(d._children[s]._children["Target"].children().clone()));if(r["x-LSP-notes"]){o.append($("<div>").addClass("description").text(r["x-LSP-notes"]))}var l=[];l.push(["Edit",function(){UI.navto("Start Push","auto_"+r.id)},"Edit","Edit this automatic push"]);l.push(["Copy target",function(){var e=this;var t=r.target;UI.copy(t).then(function(){e._setText("Copied!");setTimeout(function(){i.hide()},300)}).catch(function(a){e._setText("Copy: "+a);setTimeout(function(){i.hide()},300);var s=UI.popup(UI.buildUI([$("<h1>").text("Copy push target"),{type:"help",help:"Automatic copying of the template to the clipboard failed ("+a+"). Instead you can manually copy from the field below."},{type:"str",label:"Push target",value:t,rows:Math.ceil(t.length/50+2)}]));s.element.find("textarea").select()})},"copy","Copy the full target url to the clipboard."]);if(r.deactivated){l.push(["Enable",function(){var e=$(this);var t={};t[r.id]=r;mist.send(function(e){d.update(e.auto_push);i.hide()},{push_auto_add:t})},"wake","Enable this automatic push"])}else{l.push(["Disable",function(){r.stream="deactivated_"+r.stream;var e={};e[r.id]=r;mist.send(function(e){d.update(e.auto_push);i.hide()},{push_auto_add:e})},"sleep","Disable this automatic push: it will not start new pushes but will remain listed"])}l.push(["Remove",function(){if(confirm("Are you sure you want to "+$(this).text().toLowerCase()+" this push?\n"+r.stream+" to "+r.target)){$(this).html($("<span>").addClass("red").text("Removing.."));var e=this;mist.send(function(t){$(e).text("Done.");d.update(t.auto_push);i.hide()},{push_auto_remove:r.id})}},"trash","Remove this automatic push."]);if(e.stop_pushes){l.push(["Stop pushes",function(e){e.stopPropagation();var s='Are you sure you want to stop all pushes matching \n"'+r.stream+" to "+r.target+'"?';if(r.stream[0]=="#"){s="Are you sure you want to stop all pushes to "+r.target+'"?'}if(!r.deactivated&&a.push_settings.wait!=0){s+="\n\nRetrying is enabled. That means the push will probably just restart. You'll probably want to set 'Delay before retry' to 0, or deactive the autopush first."}if(confirm(s)){var n=$(this);var o=n.children().first();n.text("Stopping pushes..").prepend(o);var l=[];var d=mist.data.push_list;for(var c in d){if(r.target==d[c][2]&&(r.stream[0]=="#"||r.stream==d[c][1])){l.push(d[c][0]);t.find('table[data-pushtype="active"] tr[data-pushid='+d[c][0]+"]").html($("<td colspan=99>").html($("<span>").addClass("red").text("Stopping..")))}}mist.send(function(){n.text("Stop pushes").prepend(o);i.hide()},{push_stop:l})}},"stop","Stop all active pushes "+(r.stream[0]=="#"?"":"matching '"+r.stream+"'")+" to '"+r.target+"'."]);l.push(["Stop & remove",function(e){e.stopPropagation();var a='Are you sure you want to stop all pushes matching \n"'+r.stream+" to "+r.target+'",\n and then remove this automatic push?';if(r.stream[0]=="#"){a="Are you sure you want to stop all pushes to "+r.target+'",\n and then remove this automatic push?'}if(confirm(a)){var s=$(this);var n=s.children().first();s.text("Stopping pushes..").prepend(n);var o=[];var l=mist.data.push_list;for(var c in l){if(r.target==l[c][2]&&(r.stream[0]=="#"||r.stream==l[c][1])){o.push(l[c][0]);t.find('table[data-pushtype="active"] tr[data-pushid='+l[c][0]+"]").html($("<td colspan=99>").html($("<span>").addClass("red").text("Stopping..")))}}mist.send(function(e){s.text("Stop pushes").prepend(n);d.update(e.auto_push);i.hide()},{push_stop:o,push_auto_remove:r.id})}},"stop_remove","Stop all active pushes "+(r.stream[0]=="#"?"":"matching '"+r.stream+"'")+" to '"+r.target+"' and then remove this automatic push."])}var c=[[o],l];i.show(c,n)});return n},update:function(e){for(var t in o){if(typeof o[t]=="function"){var a=o[t](e,s);if(a!=this._children[t].raw){if(a instanceof jQuery){this._children[t].raw=$("<div>").html(a).prop("innerHTML")}else{this._children[t].raw=a}this._children[t].html(a);if(t=="Notes"){this._children[t].attr("title",a)}}}}this.sort()},getEntries:function(e){out=Object.assign({},e);out.deactivated=e.stream.indexOf("deactivated_")==0;if(out.deactivated){out.stream=out.stream.slice(16)}return out}},update:function(t){var a=this;a.data("values",t);function i(e){for(var t in a._children){var i=a._children[t];if(i._children[e].raw!=""){return true}}return false}if(Object.keys(t).length){if(!a.parent().length){l.append(a)}}else if(a[0].parentNode){a[0].parentNode.removeChild(a[0])}a.sort();if(e.filter)a[0].filter()},values:n,getEntries:function(t){var a={};var i=false;if(e.stream&&e.stream.split("+").length==1){i=true}for(var s in t){var n=t[s];n.id=s;var r=n.stream.replace("deactivated_","");if(!e.stream||r==e.stream||!i&&r.split("+")[0]==e.stream){a[n.id]=n}}return a}})}else{d=UI.dynamic({create:function(){var e=$("<table>").attr("data-pushtype","active");var a=$("<tr>");e.append($("<thead>").append(a)).append($("<tbody>"));for(var i in o){if(!o[i])continue;var s=$("<th>").addClass("header").text(i).attr("data-index",i);a.append(s)}a.find('[data-index="Actions"]').removeAttr("data-index").text("");var n=mist.stored.get();if(!("sort_pushes"in n)){n.sort_pushes={}}var r=$("<select>").append($("<option>").text("Pid").val("pid")).append($("<option>").text("Time active").val("active_seconds")).append($("<option>").text("Transferred data").val("bytes")).append($("<option>").text("Transferred media time").val("mediatime")).val(n.sort_pushes_statistics_type?n.sort_pushes_statistics_type:"pid").change(function(){mist.stored.set("sort_pushes_statistics_type",$(this).val());e.sort("Statistics")});a.find('[data-index="Statistics"]').append(r);UI.sortableItems(e,function(t){if(t=="Statistics"){var a=e._children[this.getAttribute("data-pushid")].values;if(a)a=a.stats;var i=r.val();if(a&&i in a){return a[i]}return null}return e._children[this.getAttribute("data-pushid")]._children[t].raw},{controls:a[0],sortby:"Statistics",sortsave:"sort_pushes",container:e[0].children[1]});e[0].filter=function(a){if(typeof a=="undefined"){a=t.find("input.filter").getval();if(!a)a=""}a=a.toLowerCase();function i(e){if(typeof e=="undefined"||e===null)return false;return e.toLowerCase().indexOf(a)>=0}for(var s in e._children){var n=e._children[s];var r=n.values;if(i(r.stream)||i(r.target)||i(r.resolved_target)){n[0].classList.remove("hidden")}else{n[0].classList.add("hidden")}}};return e},add:{create:function(t){var a=$("<tr>").attr("data-pushid",t);a._children={};for(var s in o){if(!o[s])continue;var n=$("<td>").attr("data-index",s);a._children[s]=n;a.append(n);if(o[s]instanceof jQuery){n.html(o[s].clone(true))}else if(typeof o[s]=="object"){n.dynamic=UI.dynamic(o[s]);n.html(n.dynamic)}}a.on("contextmenu",function(a){a.preventDefault();var s=d._children[t].values;var n=$("<div>").addClass("header");if(!e.stream){n.append($("<span>").text(s.stream)).append($("<span>").addClass("unit").text("  "))}n.append($("<span>").addClass("target").append(d._children[t]._children["Target"].children().clone()));var r=[];r.push(["Stop",function(){if(confirm("Are you sure you want to "+$(this).text().toLowerCase()+" this push?\n"+s.stream+" to "+s.target)){$(this).html($("<span>").addClass("red").text("Stopping.."));mist.send(function(e){},{push_stop:[s.id]})}},"trash","Stop this push."]);var o=[[n],r];i.show(o,a)});return a},update:function(e){for(var t in o){if(typeof o[t]=="function"){var a=o[t](e,s);if(a!=this._children[t].raw){this._children[t].html(a);this._children[t].raw=a}}else if(t=="Statistics"&&o[t]){var i={pid:e.id};if(e.stats){i=Object.assign(i,e.stats)}i.logs=e.logs;this._children[t].dynamic.update(i)}}}},update:function(t){var a=this;a.data("values",t);if(Object.keys(t).length){if(!a.parent().length){l.append(a)}}else if(a[0].parentNode){a[0].parentNode.removeChild(a[0])}a.sort();if(e.filter)a[0].filter()},values:n,getEntries:function(t){var a={};var i=false;if(e.stream&&e.stream.split("+").length==1){i=true}for(var s in t){var n=mist.convertPushArr2Obj(t[s]);if(!e.stream||n.stream==e.stream||!i&&n.stream.split("+")[0]==e.stream){a[n.id]=n}}return a}})}l.update=function(){return d.update.apply(d,arguments)};return l}t.append($("<section>").append($("<h3>").text("Automatic pushes")).append($("<div>").addClass("buttons").append($("<button>").attr("data-icon","plus").text("Add an automatic push").click(function(){UI.navto("Start Push","auto")}))).append(s("Automatic",a.auto_push)));var n=s("Manual",a.push_list);t.append($("<section>").append($("<h3>").text("Active pushes")).append($("<div>").addClass("buttons").append($("<button>").attr("data-icon","plus").text("Start a push").click(function(){UI.navto("Start Push")})).append(e.stop_pushes?$("<button>").attr("data-icon","stop").text("Stop all pushes listed below").click(function(){var e=[];var a=t.find('table[data-pushtype="active"]');var i=a.find("tr[data-pushid]:visible");i.each(function(t,a){e.push($(this).attr("data-pushid"))});if(e.length){if(confirm("Are you sure you want to stop "+e.length+" push"+(e.length>1?"es?":"?"))){i.each(function(){$(this).html($("<td colspan=99>").html($("<span>").addClass("red").text("Stopping..")))});mist.send(function(){},{push_stop:e})}}}):"")).append(n));UI.sockets.http.api.subscribe(function(e){n.update(e.push_list);mist.data.push_list=e.push_list},{push_list:1});if(e.collapsible){t.children("section").not(".context_menu").addClass("collapsible").addClass("expanded").each(function(){$(this).children().first().click(function(){$(this).closest("section.collapsible").toggleClass("expanded")})})}},{push_auto_list:1,push_list:1,push_settings:1});return $("<section>").addClass("pushes").append($("<h3>").text("Pushes and recordings")).append(t)},streamkeys:function(e,t){if(!t){t=function(){UI.showTab("Stream keys")}}let a=$("<section>").text("Loading..");mist.send(function(i){var s={};let n=$.extend({},mist.data.streams);if(i.active_streams){for(let e of i.active_streams){var r=e.split("+")[0];if(r in mist.data.streams){if(r!=e&&!(e in n)){n[e]=$.extend({},mist.data.streams[r]);n[e].name=e}n[e].online=1}}}a.html($("<h1>").text("Manage stream keys"+(e?" for '"+e+"'":"")).css("margin-top",0)).append(UI.buildUI([{type:"help",help:"Stream keys are a method to bypass all security and allow an incoming push for the given stream. If a token that matches a stream is used it will be accepted. This will even apply to vod or unconfigured streams, making them active as a live stream with default settings. <br>Note: A stream with source 'push://' and a stream key would accept both its stream name and stream key for input. To avoid this enable the 'Require stream key' option."},UI.buildUI([$("<h3>").text("Add stream key(s)"),{label:"For stream name",type:"str",pointer:{main:s,index:"stream"},prefix:e?e+"+":false,validate:e?[]:["required","streamname_with_wildcard",function(e){if(!(e in n)){return{msg:"This stream does not exist (yet). You can add a key for it anyway.",break:false}}if(n[e].source?.slice(0,7)!="push://"){return{msg:"It is not possible to push into this stream. Pushing to this stream will only work if it is not already active.",classes:["orange"],break:false}}}],help:"Enter the stream for which this stream key will be valid. You can enter a stream with wildcard. You can add stream keys for streams that do not exist yet.",datalist:function(){let t=[];for(const a in n){if(n[a].source?.slice(0,7)=="push://"){if(e){if(a.split("+")[0]==e){t.push(a.split("+").slice(1).join("+"))}}else{t.push(a)}}}return t}()},{label:"Stream key(s)",type:"inputlist",classes:["streamkeysinputlist"],pointer:{main:s,index:"keys"},validate:["required"],help:"Enter one or more keys",input:{type:"str",clipboard:true,maxlength:256,validate:[function(e,t){if(i.streamkeys&&e in i.streamkeys){return{msg:"The key '"+e+"' is already in use. Duplicates are not allowed.",classes:["red"]}}if(e.length&&!e.match(/^[0-9a-z]+$/i)){return{msg:"The key '"+e+"' contains special characters. We recommend not using these as some video streaming protocols do not accept them.",classes:["orange"],break:false}}}],unit:$("<button>").text("Generate").click(function(){let e=$(this).closest(".field_container").find(".field");function t(e){function t(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";return e[Math.floor(Math.random()*e.length)]}let a="";while(a.length<e){a+=t()}return a}function a(){e.setval(t(32));if(e.data("validate")(e)){a()}}a();e.trigger("keyup")})}},{type:"buttons",buttons:[{type:"save",icon:"plus",label:"Add",function:function(){let a={};for(let t of s.keys){a[t]=e?s.stream?e+"+"+s.stream:e:s.stream}mist.send(function(){t()},{streamkey_add:a})}}]}]),$("<h3>").text("Current stream keys"+(e?" for '"+e+"'":"")),{type:"help",help:"Note: the stream status on this page does not update automatically."},{label:"Filter",help:"Only streams or keys that contain the text you enter here will be displayed.",function:function(){$(this).closest(".input_container").find(".streamkeys")?.[0]?.filter($(this).getval())},css:{marginBottom:"3em"}},function(){const t=$("<div>").addClass("streamkeys");let a={};for(key in i.streamkeys){if(e){if(i.streamkeys[key].split("+")[0]!=e)continue}if(!(i.streamkeys[key]in a)){a[i.streamkeys[key]]=[]}a[i.streamkeys[key]].push(key)}let s=Object.keys(a).sort();function r(e){const t=$("<span>").addClass("clickable").text(e);if(e.indexOf("+")>=0){const a=e.split("+");t.html($("<span>").addClass("wildparent").text(a[0]+"+")).append(a.slice(1))}t.on("contextmenu",function(a){a.preventDefault();const i=[$("<div>").addClass("header").html(t.html())];const s=[[$("<span>").html("Edit "+(e.indexOf("+")<0?"stream":"<b>"+e.split("+")[0]+"</b>")),function(){UI.navto("Edit",e)},"Edit","Change the settings of this stream."],["Stream status",function(){UI.navto("Status",e)},"Status","See more details about the status of this stream."],["Preview stream",function(){UI.navto("Preview",e)},"Preview","Watch the stream."]];if(!(e.split("+")[0]in mist.data.streams)){s.shift();s.unshift([$("<span>").html("Create "+(e.indexOf("+")<0?"stream":"<b>"+e.split("+")[0]+"</b>")),function(){UI.navto("Edit",e)},"Edit","Create this stream."])}const n=[i];n.push(s);l.show(n,a)}).click(function(e){this.dispatchEvent(new MouseEvent("contextmenu",e));e.stopPropagation()});return t}for(let e of s){t.append($("<div>").addClass("stream").attr("data-stream",e).append($("<div>").addClass("header").addClass("activestream").append(function(){let t=false;if(i.active_streams?.indexOf(e)>=0){t=true}return $("<div>").attr("data-streamstatus",t?4:0).attr("title",t?"Active":"Inactive")}()).append(r(e)).append(function(){let t="Unconfigured";let a=e.split("+")[0];if(a in n){if(n[a].source.slice(0,7)!="push://"){t="Using stream key will override configured source"}else if(n[a].source.slice(0,16)=="push://invalid,host"){t="Stream key only"}else{t="Configured"}}return $("<span>").text("("+t+")").addClass("description").css("font-weight","normal")}()).append($("<button>").attr("data-icon","trash").text("Delete all").click(function(){if(confirm("Are you sure you want to remove all "+a[e].length+" keys of the stream '"+e+"'?")){let t=$(this);mist.send(function(){let e=t.closest(".streamkeys");t.closest(".stream").remove();e[0].show_page()},{streamkey_del:Object.values(a[e])})}}))).append(function(){const t=$("<div>").addClass("keys");for(let i of a[e]){t.append($("<span>").addClass("key").attr("data-key",i).append($("<span>").text(i).addClass("clickable").on("contextmenu",function(t){t.preventDefault();let a=$(this);let s=UI.updateLiveStreamHint(e,"push://invalid,host","raw",false,[i]);function n(e,t){return["Copy "+e,function(){UI.copy(t).then(()=>{this._setText("Copied!");setTimeout(function(){l.hide()},300)}).catch(e=>{this._setText("Copy: "+e);setTimeout(function(){l.hide()},300);var a=UI.popup(UI.buildUI([$("<h1>").text("Copy to clipboard"),{type:"help",help:"Automatic copying failed ("+e+"). Instead you can manually copy from the field below."},{type:"str",label:"Text",value:t,rows:Math.ceil(t.length/50+2)}]));a.element.find("textarea").select()})},"copy","Copy the "+e+" to the clipboard:\n"+t]}let o=[];o.push(n("key",i));for(const e in s){if(Array.isArray(s[e])){o.push(n(e+" url",s[e][0]))}else if(e=="RTMP"){o.push(n("full RTMP url",s.RTMP.full_url[0]));o.push(n("RTMP url (without key)",Object.keys(s.RTMP.pairs)[0]))}}l.show([[$("<div>").addClass("header").append($("<div>").text(i).css("font-family","monospace")).append($("<div>").text("for ").append(r(e).removeClass("clickable")))],o,[["Delete this stream key",function(){if(confirm("Are you sure you want to remove the key '"+i+"'?")){mist.send(function(){let e=a.closest(".keys");let t=e.closest(".streamkeys");a.closest(".key").remove();if(!e.children().length){e.closest(".stream").remove()}t[0].show_page()},{streamkey_del:i})}},"trash","Delete this stream key"]]],t)}).click(function(e){this.dispatchEvent(new MouseEvent("contextmenu",e));e.stopPropagation()})).append($("<button>").attr("data-icon","trash").attr("title","Delete").click(function(){if(confirm("Are you sure you want to remove the key '"+i+"'?")){let e=$(this);mist.send(function(){let t=e.closest(".keys");let a=t.closest(".streamkeys");e.closest(".key").remove();if(!t.children().length){t.closest(".stream").remove()}a[0].show_page()},{streamkey_del:i})}})))}return t}()))}t[0].filter=function(e){e=e.toLowerCase();for(var a=0;a<this.children.length;a++){var i=this.children[a];if(i.getAttribute("data-stream").toLowerCase().indexOf(e)>=0){i.classList.remove("hidden");i.classList.add("showAllKeys")}else{i.classList.add("hidden");i.classList.remove("showAllKeys")}}const s=this.querySelectorAll(".stream .keys .key");for(let t of s){if(t.getAttribute("data-key").toLowerCase().indexOf(e)>=0){t.classList.remove("hidden");t.closest(".stream").classList.remove("hidden")}else{t.classList.add("hidden")}}t[0].show_page()};return t}()]));const o=UI.pagecontrol(a.find(".input_container > .streamkeys")[0],mist.stored.get()?.streamkeys_pagesize||5);a.append(o);o.elements.pagelength.change(function(){mist.stored.set("streamkeys_pagesize",$(this).val())});const l=new UI.context_menu;a.append(l.ele);a.find(".field").first().focus()},{streamkeys:true,active_streams:true,capabilities:true});return a}},sockets:{http_host:null,http:{api:{command:{},listeners:[],interval:false,get:function(){var e=this;mist.send(function(t){for(var a in e.listeners){e.listeners[a](t)}},e.command)},init:function(){var e=this;e.get();e.interval=UI.interval.set(function(){e.get()},5e3)},subscribe:function(e,t){this.command=Object.assign(this.command,t);if(!this.interval||!(this.interval in UI.interval.list)){this.listeners=[];this.listeners.push(e);this.init()}else{this.listeners.push(e);this.get()}}},clients:{requests:[],listeners:[],interval:false,subscribe:function(e,t){if(!this.interval||!(this.interval in UI.interval.list)){this.listeners=[];this.requests=[]}if(!("time"in t)){t.time=-3}this.requests.push(t);this.listeners.push(e);var a=this;if(this.listeners.length==1){UI.sockets.http.api.subscribe(function(e){for(var t in e.clients){var i=e.clients[t];var s={data:[],time:i.time};for(var n in i.data){var r={};for(var o in i.fields){var l=i.fields[o];r[l]=i.data[n][o]}s.data.push(r)}a.listeners[t].call(null,s)}},{clients:this.requests});this.interval=UI.sockets.http.api.interval}else{UI.sockets.http.api.get()}}},player:function(e,t){if(!mistPlay){if(!UI.sockets.http_host){t("Could not find player.js: MistServer host unknown")}var a=UI.sockets.http_host+"player.js";$.ajax({type:"GET",url:a,success:function(t){e()},error:function(){t("Error while retrieving player.js from "+a)}})}else{e()}}},ws:{info_json:{children:{},init:function(e){var t=UI.websockets.create(e);this.children[e]={ws:false,messages:[],listeners:[]};this.children[e].ws=t;var a=this;t.onmessage=function(t){var i=JSON.parse(t.data);if(e in a.children){a.children[e].messages.push(i);for(var s in a.children[e].listeners){a.children[e].listeners[s](i)}}};t.onerror=function(t){if(e in a.children){for(var i in a.children[e].listeners){a.children[e].listeners[i](t)}}};t.cleanup=function(){delete a.children[e];t.onclose=function(){};t.onmessage=function(){}};var i=t.close;t.close=function(){t.cleanup();return i.apply(this,arguments)};t.onclose=function(){t.cleanup()}},subscribe:function(e,t,a,i){if(!e){throw"Callback function not specified."}if(!t&&!a){throw"Stream name not specified."}if(!i){i=""}if(!a){if(!UI.sockets.http_host){var s=this;var n=arguments;UI.modules.stream.findMist(function(e){s.subscribe.apply(s,n)});return}a=UI.sockets.http_host.replace(/^http/,"ws")+"json_"+encodeURIComponent(t)+".js"+i}if(!(a in this.children)||this.children[a].ws.readyState>1){this.init(a)}for(var r in this.children[a].messages){e(this.children[a].messages[r])}this.children[a].listeners.push(e)}},active_streams:{ws:false,listeners:[],messages:[],init:function(e){var t=parseURL(mist.user.host);t=parseURL(mist.user.host,{pathname:t.pathname.replace(/\/api$/,"")+"/ws",search:"?logs=100&accs=100&streams=1"});var a=UI.websockets.create(t.full.replace(/^http/,"ws"),e);this.ws=a;var i=this;a.authState=0;a.onmessage=function(e){var t=JSON.parse(e.data);var a=t[0];var s=t[1];if(a=="auth"){if(s===true){this.authState=2}else if(s===false){this.send(JSON.stringify(["auth",{password:MD5(mist.user.password+mist.user.authstring),username:mist.user.name}]));this.authState=1}else if(typeof s=="object"){if("challenge"in s){this.send(JSON.stringify(["auth",{password:MD5(mist.user.password+s.challenge),username:mist.user.name}]));this.authState=1}else if("status"in s&&s.status=="OK"){this.authState=2}}return}i.messages.push([a,s]);for(var n in i.listeners){i.listeners[n](a,s)}};var s=a.close;a.close=function(){i.listeners=[];i.messages=[];i.ws=false;return s.apply(this,arguments)}},subscribe:function(e){for(var t in this.messages){e(this.messages[t][0],this.messages[t][1])}var a=this;if(!this.ws||this.ws.readyState>1){this.init(function(){for(var e in a.listeners){a.listeners[e]("error","An error occured: failed to connect to the active streams api websocket.")}})}this.listeners.push(e)}}}}};if(!("origin"in location)){location.origin=location.protocol+"//"}var host;if(location.origin=="file://"){host="http://localhost:4242/api"}else{host=location.origin+location.pathname.replace(/\/+$/,"")+"/api"}var mist={data:{},user:{name:"",password:"",host:host},send:function(e,t,a){t=t||{};a=a||{};a=$.extend(true,{timeOut:3e4,sendData:t},a);var i={authorize:{password:mist.user.authstring?MD5(mist.user.password+mist.user.authstring):"",username:mist.user.name}};$.extend(true,i,t);log("Send",$.extend(true,{},t));var s={url:mist.user.host,type:"POST",contentType:"application/json",data:JSON.stringify(i),dataType:"json",crossDomain:true,timeout:a.timeout*1e3,async:true,error:function(i,s,n){console.warn("connection failed :(",n);delete mist.user.loggedin;if(!a.hide){switch(s){case"timeout":s=$("<i>").text("The connection timed out. ");break;case"abort":s=$("<i>").text("The connection was aborted. ");break;default:s=$("<i>").text(s+". ").css("text-transform","capitalize")}$("#message").addClass("red").text("An error occurred while attempting to communicate with MistServer:").append($("<br>")).append($("<span>").text(s)).append($("<a>").text("Send server request again").click(function(){mist.send(e,t,a)}))}UI.navto("Login")},success:function(s,n,r){log("Receive",$.extend(true,{},s),"as reply to",a.sendData);mist.lastrequest=r;delete mist.user.loggedin;switch(s.authorize.status){case"OK":if("streams"in s){if(s.streams){if("incomplete list"in s.streams){delete s.streams["incomplete list"];$.extend(mist.data.streams,s.streams)}else{mist.data.streams=s.streams}}else{mist.data.streams={}}}var o=$.extend({},s);var l=["config","capabilities","ui_settings","LTS","active_streams","browse","log","totals","bandwidth","variable_list","external_writer_list","streamkeys"];for(var d in o){if(l.indexOf(d)==-1){delete o[d]}}if("bandwidth"in i&&!("bandwidth"in s)){o.bandwidth=null}if(a.sendData.capabilities&&a.sendData.capabilities!==true){delete o.capabilities}$.extend(mist.data,o);mist.user.loggedin=true;UI.elements.connection.status.text("Connected").removeClass("red").addClass("green");UI.elements.connection.user_and_host.text(mist.user.name+" @ "+mist.user.host);UI.elements.connection.msg.removeClass("red").text("Last communication with the server at "+UI.format.time((new Date).getTime()/1e3));if(s.log){var c=s.log[s.log.length-1];UI.elements.connection.msg.append($("<br>")).append($("<span>").text("Last log entry: "+UI.format.time(c[0])+" ["+c[1]+"] "+c[2]))}if("totals"in s){function p(e){function t(t){if(typeof t=="undefined"){t=n}for(var i in e.fields){a[e.fields[i]].push([n,0])}}var a={};for(var i in e.fields){a[e.fields[i]]=[]}var s=0;var n;if(!e.data){n=(mist.data.config.time-600)*1e3;t();n=(mist.data.config.time-15)*1e3;t()}else{if(e.start>mist.data.config.time-600){n=(mist.data.config.time-600)*1e3;t();n=e.start*1e3;t()}else{n=e.start*1e3}for(var i in e.data){if(i==0){var n=e.start*1e3;var r=0}else{n+=e.interval[r][1]*1e3;e.interval[r][0]--;if(e.interval[r][0]<=0){r++;if(r<e.interval.length-1){s+=2}}}if(s%2==1){t();s--}for(var o in e.data[i]){a[e.fields[o]].push([n,e.data[i][o]])}if(s){t();s--}}if(mist.data.config.time-e.end>20){t();n=(mist.data.config.time-15)*1e3;t()}}return a}function u(e,t,a){var i=p(a);stream=e?e.join(" "):"all_streams";protocol=t?t.join("_"):"all_protocols";if(!(stream in mist.data.totals)){mist.data.totals[stream]={}}if(!(protocol in mist.data.totals[stream])){mist.data.totals[stream][protocol]={}}$.extend(mist.data.totals[stream][protocol],i)}mist.data.totals={};if("fields"in s.totals){u(t.totals.streams,t.totals.protocols,s.totals)}else{for(var d in s.totals){u(t.totals[d].streams,t.totals[d].protocols,s.totals[d])}}}if(e){e(s,a)}break;case"CHALL":if(s.authorize.challenge==mist.user.authstring){if(mist.user.password!=""){UI.elements.connection.msg.text("The credentials you provided are incorrect.").addClass("red")}UI.navto("Login")}else if(mist.user.password==""){UI.navto("Login")}else{mist.user.authstring=s.authorize.challenge;mist.send(e,t,a);var f={host:mist.user.host,name:mist.user.name,password:mist.user.password};sessionStorage.setItem("mistLogin",JSON.stringify(f))}break;case"NOACC":UI.navto("Create a new account");break;case"ACC_MADE":delete t.authorize;mist.send(e,t,a);break;default:UI.navto("Login")}}};if(!a.hide){UI.elements.connection.msg.removeClass("red").text("Data sent, waiting for a reply..").append($("<br>")).append($("<a>").text("Cancel request").click(function(){n.abort()}))}var n=$.ajax(s)},inputMatch:function(e,t){if(typeof e=="undefined"){return false}if(typeof e=="string"){e=[e]}for(var a in e){var i=e[a];var s=t;if(i.slice(-1)=="?"){i=i.slice(0,-1);s=s.split("?")[0]}var n=i.replace(/[^\w\s]/g,"\\$&");n=n.replace(/\\\*/g,".*");var r=new RegExp("^(?:[a-zA-Z]:)?"+n+"(?:\\?[^\\?]*)?$","i");if(r.test(s)){return true}}return false},convertBuildOptions:function(e,t){var a=[];var i=["required","optional"];if("desc"in e){a.push({type:"help",help:e.desc})}function s(e,a,s){var n={label:UI.format.capital(s.name?s.name:a),pointer:{main:t,index:a},validate:[]};if(i[e]=="required"&&(!("default"in s)||s["default"]=="")){n.validate.push("required")}if("default"in s){n.placeholder=s["default"];if(s.type=="select"){for(var r in s.select){if(s.select[r][0]==s["default"]){n.placeholder=s.select[r][1];break}}}}if("help"in s){n.help=s.help}if("unit"in s){n.unit=s.unit}if("placeholder"in s){n.placeholder=s.placeholder}if("datalist"in s){n.datalist=s.datalist}if("type"in s){switch(s.type){case"int":n.type="int";if("max"in s){n.max=s.max}if("min"in s){n.min=s.min}break;case"uint":n.type="int";n.min=0;if("max"in s){n.max=s.max}if("min"in s){n.min=Math.max(n.min,s.min)}break;case"radioselect":n.type="radioselect";n.radioselect=s.radioselect;break;case"select":n.type="select";n.select=s.select.slice(0);if(n.validate.indexOf("required")<0){n.select.unshift(["","placeholder"in n?"Default ("+n.placeholder+")":""])}break;case"sublist":{n.type="sublist";n.saveas={};n.itemLabel=s.itemLabel;n.sublist=mist.convertBuildOptions(s,n.saveas);break}case"group":{n.type="group";n.label=s.name;n.options=mist.convertBuildOptions({optional:s.options},t);n.options=n.options.slice(1);break}case"bool":{n.type="checkbox";break}case"unixtime":{n.type="unix";break}case"inputlist":{n.type="inputlist";if("input"in s)n.input=s.input;break}case"json":case"debug":case"inputlist":case"browse":{n.type=s.type;break}default:n.type="str";if("minlength"in s){n.minlength=s.minlength}if("maxlength"in s){n.maxlength=s.maxlength}break}}else{n.type="checkbox"}if("format"in s){switch(s.format){case"set_or_unset":{n["postSave"]=function(){var e=$(this).data("pointer");if(!e.main[e.index]){delete e.main[e.index]}};break}}}if("influences"in s){n["function"]=function(){var e=$(this).closest(".UIelement");var t=e.find("style");if(!t.length){t=$("<style>").addClass("dependencies")[0];e.append(t)}else{t=t[0]}t.innerHTML=".UIelement[data-dependent-"+a+"]:not([data-dependent-"+a+'~="'+$(this).getval()+'"]) { display: none; }'+"\n";$(t).data("content",t.innerHTML);$("style.dependencies.hidden").each(function(){$(this).html($(this).data("content")).removeClass("hidden")});$(".UIelement:not(:visible) style.dependencies:not(.hidden)").each(function(){$(this).addClass("hidden");$(this).html("")})}}else if("disable"in s){n["function"]=function(){var e=$(this).closest(".input_container");var t=$(this).getval();for(var a=0;a<s.disable.length;a++){var i=s.disable[a];var n=e.find('.field[name="'+i+'"]').closest(".UIelement");if(n.length){if(t==""){n[0].style.display=""}else{n.hide()}}}}}if("dependent"in s){n.dependent=s.dependent}if("value"in s){n.value=s.value}if("validate"in s){n.validate=n.validate.concat(s.validate);if(s.validate.indexOf("track_selector_parameter")>-1){n.help="<div>"+s.help+"</div>"+"<p>Track selector parameters consist of a string value which may be any of the following:</p> <ul><li><code>selector,selector</code>: Selects the union of the given selectors. Any number of comma-separated selector combinations may be used, they are evaluated one by one from left to right.</li> <li><code>selector,!selector</code>: Selects the difference of the given selectors. Specifically, all tracks part of the first selector that are not part of the second selector. Any number of comma-separated selector combinations may be used, they are evaluated one by one from left to right.</li> <li><code>selector,|selector</code>: Selects the intersection of the given selectors. Any number of comma-separated selector combinations may be used, they are evaluated one by one from left to right.</li> <li><code>none</code> or <code>-1</code>: Selects no tracks of this type.</li> <li><code>all</code> or <code>*</code>: Selects all tracks of this type.</li> <li>Any positive integer: Select this specific track ID. Does not apply if the given track ID does not exist or is of the wrong type. <strong>Does</strong> apply if the given track ID is incompatible with the currently active protocol or container format.</li> <li>ISO 639-1/639-3 language code: Select all tracks marked as the given language. Case insensitive.</li> <li>Codec string (e.g. <code>h264</code>): Select all tracks of the given codec. Case insensitive.</li> <li><code>highbps</code>, <code>maxbps</code> or <code>bestbps</code>: Select the track of this type with the highest bit rate.</li> <li><code>lowbps</code>, <code>minbps</code> or <code>worstbps</code>: Select the track of this type with the lowest bit rate.</li> <li><code>Xbps</code> or <code>Xkbps</code> or <code>Xmbps</code>: Select the single of this type which has a bit rate closest to the given number X. This number is in bits, not bytes.</li> <li><code>&gt;Xbps</code> or <code>&gt;Xkbps</code> or <code>&gt;Xmbps</code>: Select all tracks of this type which have a bit rate greater than the given number X. This number is in bits, not bytes.</li> <li><code>&lt;Xbps</code> or <code>&lt;Xkbps</code> or <code>&lt;Xmbps</code>: Select all tracks of this type which have a bit rate less than the given number X. This number is in bits, not bytes.</li> <li><code>max&lt;Xbps</code> or <code>max&lt;Xkbps</code> or <code>max&lt;Xmbps</code>: Select the one track of this type which has the highest bit rate less than the given number X. This number is in bits, not bytes.</li> <li><code>highres</code>, <code>maxres</code> or <code>bestres</code>: Select the track of this type with the highest pixel surface area. Only applied when the track type is video.</li> <li><code>lowres</code>, <code>minres</code> or <code>worstres</code>: Select the track of this type with the lowest pixel surface area. Only applied when the track type is video.</li> <li><code>XxY</code>: Select all tracks of this type with the given pixel surface area in X by Y pixels. Only applied when the track type is video.</li> <li><code>~XxY</code>: Select the single track of this type closest to the given pixel surface area in X by Y pixels. Only applied when the track type is video.</li> <li><code>&gt;XxY</code>: Select all tracks of this type with a pixel surface area greater than X by Y pixels. Only applied when the track type is video.</li> <li><code>&lt;XxY</code>: Select all tracks of this type with a pixel surface area less than X by Y pixels. Only applied when the track type is video.</li> <li><code>720p</code>, <code>1080p</code>, <code>1440p</code>, <code>2k</code>, <code>4k</code>, <code>5k</code>, or <code>8k</code>: Select all tracks of this type with the given pixel surface area. Only applied when the track type is video.</li> <li><code>surround</code>, <code>mono</code>, <code>stereo</code>, <code>Xch</code>: Select all tracks of this type with the given channel count. The 'Xch' variant can use any positive integer for 'X'. Only applied when the track type is audio.</li></ul>"}if(s.validate.indexOf("track_selector")>-1){n.help="<div>"+s.help+"</div>"+"<p>A track selector is at least one track type (audio, video or subtitle) combined with a track selector parameter. For example: <code>audio=none&video=maxres</code>.<p>Track selector parameters consist of a string value which may be any of the following:</p> <ul><li><code>selector,selector</code>: Selects the union of the given selectors. Any number of comma-separated selector combinations may be used, they are evaluated one by one from left to right.</li> <li><code>selector,!selector</code>: Selects the difference of the given selectors. Specifically, all tracks part of the first selector that are not part of the second selector. Any number of comma-separated selector combinations may be used, they are evaluated one by one from left to right.</li> <li><code>selector,|selector</code>: Selects the intersection of the given selectors. Any number of comma-separated selector combinations may be used, they are evaluated one by one from left to right.</li> <li><code>none</code> or <code>-1</code>: Selects no tracks of this type.</li> <li><code>all</code> or <code>*</code>: Selects all tracks of this type.</li> <li>Any positive integer: Select this specific track ID. Does not apply if the given track ID does not exist or is of the wrong type. <strong>Does</strong> apply if the given track ID is incompatible with the currently active protocol or container format.</li> <li>ISO 639-1/639-3 language code: Select all tracks marked as the given language. Case insensitive.</li> <li>Codec string (e.g. <code>h264</code>): Select all tracks of the given codec. Case insensitive.</li> <li><code>highbps</code>, <code>maxbps</code> or <code>bestbps</code>: Select the track of this type with the highest bit rate.</li> <li><code>lowbps</code>, <code>minbps</code> or <code>worstbps</code>: Select the track of this type with the lowest bit rate.</li> <li><code>Xbps</code> or <code>Xkbps</code> or <code>Xmbps</code>: Select the single of this type which has a bit rate closest to the given number X. This number is in bits, not bytes.</li> <li><code>&gt;Xbps</code> or <code>&gt;Xkbps</code> or <code>&gt;Xmbps</code>: Select all tracks of this type which have a bit rate greater than the given number X. This number is in bits, not bytes.</li> <li><code>&lt;Xbps</code> or <code>&lt;Xkbps</code> or <code>&lt;Xmbps</code>: Select all tracks of this type which have a bit rate less than the given number X. This number is in bits, not bytes.</li> <li><code>max&lt;Xbps</code> or <code>max&lt;Xkbps</code> or <code>max&lt;Xmbps</code>: Select the one track of this type which has the highest bit rate less than the given number X. This number is in bits, not bytes.</li> <li><code>highres</code>, <code>maxres</code> or <code>bestres</code>: Select the track of this type with the highest pixel surface area. Only applied when the track type is video.</li> <li><code>lowres</code>, <code>minres</code> or <code>worstres</code>: Select the track of this type with the lowest pixel surface area. Only applied when the track type is video.</li> <li><code>XxY</code>: Select all tracks of this type with the given pixel surface area in X by Y pixels. Only applied when the track type is video.</li> <li><code>~XxY</code>: Select the single track of this type closest to the given pixel surface area in X by Y pixels. Only applied when the track type is video.</li> <li><code>&gt;XxY</code>: Select all tracks of this type with a pixel surface area greater than X by Y pixels. Only applied when the track type is video.</li> <li><code>&lt;XxY</code>: Select all tracks of this type with a pixel surface area less than X by Y pixels. Only applied when the track type is video.</li> <li><code>720p</code>, <code>1080p</code>, <code>1440p</code>, <code>2k</code>, <code>4k</code>, <code>5k</code>, or <code>8k</code>: Select all tracks of this type with the given pixel surface area. Only applied when the track type is video.</li> <li><code>surround</code>, <code>mono</code>, <code>stereo</code>, <code>Xch</code>: Select all tracks of this type with the given channel count. The 'Xch' variant can use any positive integer for 'X'. Only applied when the track type is audio.</li></ul>"}}return n}for(var n in i){if(e[i[n]]){a.push($("<h4>").text(UI.format.capital(i[n])+" parameters"));var r=Object.keys(e[i[n]]);if("sort"in e){r.sort(function(t,a){return(""+e[i[n]][t][e.sort]).localeCompare(e[i[n]][a][e.sort])})}for(var o in r){var l=r[o];var d=e[i[n]][l];if(Array.isArray(d)){for(var c in d){a.push(s(n,l,d[c]))}}else{a.push(s(n,l,d))}}}}return a},convertPushArr2Obj:function(e,t){var a={id:e[0],stream:e[1],target:e[2]};if(t){if(e.length>=4){if(e[3])a.scheduletime=e[3];if(e.length>=5){if(e[4])a.completetime=e[4];if(e.length>=8){if(e[5]){a.start_rule([e[5],e[6],e[7]])}if(e.length>=11){if(e[8]){a.end_rule([e[8],e[9],e[10]])}}}}}}else{if(e.length>=4){if(e[3])a.resolved_target=e[3];if(e.length>=5){if(e[4])a.logs=e[4];if(e.length>=6){if(e[5])a.stats=e[5]}}}}return a},stored:{get:function(){return mist.data.ui_settings||{}},set:function(e,t){var a=this.get();var i=JSON.stringify(a[e]);a[e]=t;if(i!=JSON.stringify(t)){mist.send(function(){},{ui_settings:a})}},del:function(e){delete mist.data.ui_settings[e];mist.send(function(){},{ui_settings:mist.data.ui_settings})}}};function log(){try{if(UI.debug){var e=(new Error).stack;[].push.call(arguments,e)}[].unshift.call(arguments,"["+UI.format.time((new Date).getTime()/1e3)+"]");console.log.apply(console,arguments)}catch(e){}}$.fn.getval=function(){var e=$(this).data("opts");var t=$(this).val();if(e&&"type"in e){var a=e.type;switch(a){case"int":if(t!=""){t=Number(t)}break;case"span":t=$(this).html();break;case"debug":t=$(this).val()==""?null:Number($(this).val());break;case"checkbox":t=$(this).prop("checked");break;case"radioselect":var i=$(this).find("label > input[type=radio]:checked").parent();if(i.length){t=[];t.push(i.children("input[type=radio]").val());var s=i.children("select");if(s.length){t.push(s.val())}}else{t=""}break;case"checklist":t=[];$(this).find(".checklist input[type=checkbox]:checked").each(function(){t.push($(this).attr("name"))});break;case"unix":if(t!=""){t=Math.round(new Date($(this).val())/1e3)}break;case"selectinput":t=$(this).children("select").first().val();if(t=="CUSTOM"){t=$(this).children("label").first().find(".field_container").children().first().getval()}break;case"inputlist":t=[];$(this).find(".field").each(function(){if($(this).getval()!=""){t.push($(this).getval())}});break;case"sublist":t=$(this).data("savelist");break;case"json":try{t=JSON.parse($(this).val())}catch(e){t=null}break;case"bitmask":{t=0;$(this).find("input").each(function(){if($(this).prop("checked")){t+=Number($(this).val())}});break}}if("factor"in e&&t!==null&&t!=""){t*=e.factor}}return t};$.fn.setval=function(e,t){var a=$(this).data("opts");if(a&&"factor"in a&&Number(e)!=0){e/=a.factor}$(this).val(e);if(a&&"type"in a){var i=a.type;switch(i){case"span":$(this).html(e).attr("title",typeof e=="string"?e:"");break;case"checkbox":$(this).prop("checked",e);break;case"geolimited":case"hostlimited":var s=$(this).closest(".field_container").data("subUI");if(typeof e=="undefined"||e.length==0){e="-"}s.blackwhite.val(e.charAt(0));e=e.substr(1).split(" ");for(var n in e){s.values.append(s.prototype.clone(true).val(e[n]))}s.blackwhite.trigger("change");break;case"radioselect":if(typeof e=="undefined"){return $(this)}var r=$(this).find('label > input[type=radio][value="'+e[0]+'"]').prop("checked",true).parent();if(e.length>1){r.children("select").val(e[1])}break;case"checklist":var o=$(this).find(".checklist input[type=checkbox]").prop("checked",false);for(n in e){o.filter('[name="'+e[n]+'"]').prop("checked",true)}break;case"unix":if(typeof e!="undefined"&&e!=""&&e!==null){var l=new Date(Math.round(e)*1e3);l.setMinutes(l.getMinutes()-l.getTimezoneOffset());l=l.toISOString();$(this).val(l.split("Z")[0])}break;case"selectinput":if(e===null){e=""}var d=false;for(var n in a.selectinput){var c;if(typeof a.selectinput[n]=="string"){c=a.selectinput[n]}else if(typeof a.selectinput[n][0]=="string"){c=a.selectinput[n][0]}if(c==e){$(this).children("select").first().val(e);d=true;break}}if(!d){$(this).children("label").first().find(".field_container").children().first().setval(e).trigger("change",t);$(this).children("select").first().val("CUSTOM").trigger("change",t)}break;case"inputlist":{if(typeof e=="string"){e=[e]}let b=$(this).children();for(var n in e){var p=$(this).data("newitem")();p.find(".field").setval(e[n]);$(this).append(p)}$(this).append($(this).data("newitem")());b.remove();break}case"sublist":var u=$(this);var f=$(this).children(".curvals");f.html("");if(e&&e.length){for(var n in e){var h=$.extend(true,{},e[n]);function m(e){for(var t in e){if(t.slice(0,6)=="x-LSP-"){delete e[t]}else if(typeof e[t]=="object"){m(e[t])}}}m(h);f.append($("<div>").addClass("subitem").append($("<span>").addClass("itemdetails").text(e[n]["x-LSP-name"]?e[n]["x-LSP-name"]:JSON.stringify(h)).attr("title",JSON.stringify(h,null,2))).append($("<button>").addClass("move").text("^").attr("title","Move item up").click(function(){var e=$(this).parent().index();if(e==0){return}var t=u.getval();t.splice(e-1,0,t.splice(e,1)[0]);u.setval(t)})).append($("<button>").text("Edit").click(function(){var e=$(this).parent().index();var t=$(this).closest(".field");t.data("build")(Object.assign({},t.getval()[e]),e)})).append($("<button>").text("x").attr("title","Remove item").click(function(e){var t=$(this).parent().index();var a=u.data("savelist");a.splice(t,1);u.setval(a);e.preventDefault()})))}}else{f.append("None.")}u.data("savelist",e);break;case"json":{$(this).val(e===null?"":JSON.stringify(e,null,2));break}case"bitmask":{var v=$(this).data("opts").bitmask;var o=$(this).find("input");for(var n in v){$el=o.eq(n);if((e&v[n][0])==v[n][0]){$el.attr("checked","checked")}else{$el.removeAttr("checked")}}break}}}$(this).trigger("change",t);return $(this)};function parseURL(e,t){var a;if("URL"in window&&typeof window.URL=="function"){try{a=new URL(e)}catch(t){a=document.createElement("a");a.href=e}}else{a=document.createElement("a");a.href=e}if(t){for(var i in t){a[i]=t[i]}}return{full:a.href,protocol:a.protocol+"//",host:a.hostname,port:a.port?":"+a.port:"",pathname:a.pathname?a.pathname:null,search:a.search?a.search.replace(/^\?/,""):null,searchParams:a.search?a.searchParams:null}}function triggerRewrite(e){if(typeof e=="object"&&typeof e.length=="undefined"){return e}return obj={handler:e[0],sync:e[1],streams:e[2],default:e[3]}}